"use strict";(self.webpackChunk_3dprgrampattern_website=self.webpackChunk_3dprgrampattern_website||[]).push([[186],{3905:(e,n,a)=>{a.d(n,{Zo:()=>u,kt:()=>g});var t=a(7294);function r(e,n,a){return n in e?Object.defineProperty(e,n,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[n]=a,e}function l(e,n){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var t=Object.getOwnPropertySymbols(e);n&&(t=t.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),a.push.apply(a,t)}return a}function i(e){for(var n=1;n<arguments.length;n++){var a=null!=arguments[n]?arguments[n]:{};n%2?l(Object(a),!0).forEach((function(n){r(e,n,a[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):l(Object(a)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(a,n))}))}return e}function d(e,n){if(null==e)return{};var a,t,r=function(e,n){if(null==e)return{};var a,t,r={},l=Object.keys(e);for(t=0;t<l.length;t++)a=l[t],n.indexOf(a)>=0||(r[a]=e[a]);return r}(e,n);if(Object.getOwnPropertySymbols){var l=Object.getOwnPropertySymbols(e);for(t=0;t<l.length;t++)a=l[t],n.indexOf(a)>=0||Object.prototype.propertyIsEnumerable.call(e,a)&&(r[a]=e[a])}return r}var s=t.createContext({}),p=function(e){var n=t.useContext(s),a=n;return e&&(a="function"==typeof e?e(n):i(i({},n),e)),a},u=function(e){var n=p(e.components);return t.createElement(s.Provider,{value:n},e.children)},c="mdxType",h={inlineCode:"code",wrapper:function(e){var n=e.children;return t.createElement(t.Fragment,{},n)}},k=t.forwardRef((function(e,n){var a=e.components,r=e.mdxType,l=e.originalType,s=e.parentName,u=d(e,["components","mdxType","originalType","parentName"]),c=p(a),k=r,g=c["".concat(s,".").concat(k)]||c[k]||h[k]||l;return a?t.createElement(g,i(i({ref:n},u),{},{components:a})):t.createElement(g,i({ref:n},u))}));function g(e,n){var a=arguments,r=n&&n.mdxType;if("string"==typeof e||r){var l=a.length,i=new Array(l);i[0]=k;var d={};for(var s in n)hasOwnProperty.call(n,s)&&(d[s]=n[s]);d.originalType=e,d[c]="string"==typeof e?e:r,i[1]=d;for(var p=2;p<l;p++)i[p]=a[p];return t.createElement.apply(null,i)}return t.createElement.apply(null,a)}k.displayName="MDXCreateElement"},5167:(e,n,a)=>{a.r(n),a.d(n,{contentTitle:()=>i,default:()=>c,frontMatter:()=>l,metadata:()=>d,toc:()=>s});var t=a(7462),r=(a(7294),a(3905));const l={sidebar_position:7},i="\u7b2c8\u7ae0 \u62fc\u63a5\u6a21\u5f0f",d={unversionedId:"\u62fc\u63a5\u6a21\u5f0f/\u62fc\u63a5\u6a21\u5f0f",id:"\u62fc\u63a5\u6a21\u5f0f/\u62fc\u63a5\u6a21\u5f0f",title:"\u7b2c8\u7ae0 \u62fc\u63a5\u6a21\u5f0f",description:"\u4f7f\u7528\u9884\u5b9a\u4e49\u5b8f\u62fc\u63a5GLSL",source:"@site/docs/\u62fc\u63a5\u6a21\u5f0f/\u62fc\u63a5\u6a21\u5f0f.md",sourceDirName:"\u62fc\u63a5\u6a21\u5f0f",slug:"/\u62fc\u63a5\u6a21\u5f0f/",permalink:"/docs/\u62fc\u63a5\u6a21\u5f0f/",editUrl:"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/\u62fc\u63a5\u6a21\u5f0f/\u62fc\u63a5\u6a21\u5f0f.md",tags:[],version:"current",sidebarPosition:7,frontMatter:{sidebar_position:7},sidebar:"docs",previous:{title:"\u7b2c7\u7ae0 \u64a4\u9500\u91cd\u505a\u6a21\u5f0f",permalink:"/docs/\u64a4\u9500\u91cd\u505a\u6a21\u5f0f/"}},s=[{value:"\u4f7f\u7528\u9884\u5b9a\u4e49\u5b8f\u62fc\u63a5GLSL",id:"\u4f7f\u7528\u9884\u5b9a\u4e49\u5b8f\u62fc\u63a5glsl",children:[{value:"\u9700\u6c42",id:"\u9700\u6c42",children:[],level:3},{value:"\u5b9e\u73b0\u601d\u8def",id:"\u5b9e\u73b0\u601d\u8def",children:[],level:3},{value:"\u7ed9\u51faUML",id:"\u7ed9\u51fauml",children:[],level:3},{value:"\u7ed9\u51fa\u4ee3\u7801",id:"\u7ed9\u51fa\u4ee3\u7801",children:[{value:"Client\u7684\u4ee3\u7801",id:"client\u7684\u4ee3\u7801",children:[],level:4},{value:"\u521b\u5efaEngineState\u7684\u4ee3\u7801",id:"\u521b\u5efaenginestate\u7684\u4ee3\u7801",children:[],level:4},{value:"\u521b\u5efa\u573a\u666f\u7684\u4ee3\u7801",id:"\u521b\u5efa\u573a\u666f\u7684\u4ee3\u7801",children:[],level:4},{value:"\u521d\u59cb\u5316\u6240\u6709\u57fa\u7840\u6750\u8d28\u7684Shader\u7684\u4ee3\u7801",id:"\u521d\u59cb\u5316\u6240\u6709\u57fa\u7840\u6750\u8d28\u7684shader\u7684\u4ee3\u7801",children:[],level:4},{value:"\u521d\u59cb\u5316\u6240\u6709PBR\u6750\u8d28\u7684Shader\u7684\u4ee3\u7801",id:"\u521d\u59cb\u5316\u6240\u6709pbr\u6750\u8d28\u7684shader\u7684\u4ee3\u7801",children:[],level:4},{value:"\u6e32\u67d3\u573a\u666f\u7684\u4ee3\u7801",id:"\u6e32\u67d3\u573a\u666f\u7684\u4ee3\u7801",children:[],level:4},{value:"\u8fd0\u884cClient\u7684\u4ee3\u7801",id:"\u8fd0\u884cclient\u7684\u4ee3\u7801",children:[],level:4}],level:3},{value:"\u63d0\u51fa\u95ee\u9898",id:"\u63d0\u51fa\u95ee\u9898",children:[],level:3}],level:2},{value:"\u4f7f\u7528\u62fc\u63a5\u6a21\u5f0f\u6765\u6539\u8fdb",id:"\u4f7f\u7528\u62fc\u63a5\u6a21\u5f0f\u6765\u6539\u8fdb",children:[{value:"\u6982\u8ff0\u89e3\u51b3\u65b9\u6848",id:"\u6982\u8ff0\u89e3\u51b3\u65b9\u6848",children:[],level:3},{value:"\u7ed9\u51faUML",id:"\u7ed9\u51fauml-1",children:[],level:3},{value:"\u7ed3\u5408UML\u56fe\uff0c\u63cf\u8ff0\u5982\u4f55\u5177\u4f53\u5730\u89e3\u51b3\u95ee\u9898",id:"\u7ed3\u5408uml\u56fe\u63cf\u8ff0\u5982\u4f55\u5177\u4f53\u5730\u89e3\u51b3\u95ee\u9898",children:[],level:3},{value:"\u7ed9\u51fa\u4ee3\u7801",id:"\u7ed9\u51fa\u4ee3\u7801-1",children:[{value:"GLSL Config\u7684\u4ee3\u7801",id:"glsl-config\u7684\u4ee3\u7801",children:[],level:4},{value:"Client\u7684\u4ee3\u7801",id:"client\u7684\u4ee3\u7801-1",children:[],level:4},{value:"\u521b\u5efaEngineState\u7684\u4ee3\u7801",id:"\u521b\u5efaenginestate\u7684\u4ee3\u7801-1",children:[],level:4},{value:"GLSL Chunk\u7684\u8bf4\u660e",id:"glsl-chunk\u7684\u8bf4\u660e",children:[],level:4},{value:"Merged GLSL Chunk\u7684\u4ee3\u7801",id:"merged-glsl-chunk\u7684\u4ee3\u7801",children:[],level:4},{value:"\u521d\u59cb\u5316\u6240\u6709\u57fa\u7840\u6750\u8d28\u7684Shader\u7684\u4ee3\u7801",id:"\u521d\u59cb\u5316\u6240\u6709\u57fa\u7840\u6750\u8d28\u7684shader\u7684\u4ee3\u7801-1",children:[],level:4},{value:"\u521d\u59cb\u5316\u6240\u6709PBR\u6750\u8d28\u7684Shader\u7684\u4ee3\u7801",id:"\u521d\u59cb\u5316\u6240\u6709pbr\u6750\u8d28\u7684shader\u7684\u4ee3\u7801-1",children:[],level:4},{value:"\u6e32\u67d3\u573a\u666f\u7684\u4ee3\u7801",id:"\u6e32\u67d3\u573a\u666f\u7684\u4ee3\u7801-1",children:[],level:4},{value:"\u8fd0\u884cClient\u7684\u4ee3\u7801",id:"\u8fd0\u884cclient\u7684\u4ee3\u7801-1",children:[],level:4}],level:3}],level:2},{value:"\u5b9a\u4e49",id:"\u5b9a\u4e49",children:[{value:"\u4e00\u53e5\u8bdd\u5b9a\u4e49",id:"\u4e00\u53e5\u8bdd\u5b9a\u4e49",children:[],level:3},{value:"\u8865\u5145\u8bf4\u660e",id:"\u8865\u5145\u8bf4\u660e",children:[],level:3},{value:"\u901a\u7528UML",id:"\u901a\u7528uml",children:[],level:3},{value:"\u89d2\u8272\u7684\u62bd\u8c61\u4ee3\u7801",id:"\u89d2\u8272\u7684\u62bd\u8c61\u4ee3\u7801",children:[{value:"Target Chunk\u7684\u62bd\u8c61\u4ee3\u7801",id:"target-chunk\u7684\u62bd\u8c61\u4ee3\u7801",children:[],level:4},{value:"ChunkConverter\u7684\u62bd\u8c61\u4ee3\u7801",id:"chunkconverter\u7684\u62bd\u8c61\u4ee3\u7801",children:[],level:4},{value:"Merged Target Chunk\u7684\u62bd\u8c61\u4ee3\u7801",id:"merged-target-chunk\u7684\u62bd\u8c61\u4ee3\u7801",children:[],level:4},{value:"\u7cfb\u7edf\u7684gulp\u4efb\u52a1\u7684\u62bd\u8c61\u4ee3\u7801",id:"\u7cfb\u7edf\u7684gulp\u4efb\u52a1\u7684\u62bd\u8c61\u4ee3\u7801",children:[],level:4},{value:"Target Config\u7684\u62bd\u8c61\u4ee3\u7801",id:"target-config\u7684\u62bd\u8c61\u4ee3\u7801",children:[],level:4},{value:"Client\u7684\u62bd\u8c61\u4ee3\u7801",id:"client\u7684\u62bd\u8c61\u4ee3\u7801",children:[],level:4},{value:"\u7cfb\u7edf\u7684\u62bd\u8c61\u4ee3\u7801",id:"\u7cfb\u7edf\u7684\u62bd\u8c61\u4ee3\u7801",children:[],level:4},{value:"ChunkHandler\u7684\u62bd\u8c61\u4ee3\u7801",id:"chunkhandler\u7684\u62bd\u8c61\u4ee3\u7801",children:[],level:4}],level:3},{value:"\u9075\u5faa\u7684\u8bbe\u8ba1\u539f\u5219\u5728UML\u4e2d\u7684\u4f53\u73b0",id:"\u9075\u5faa\u7684\u8bbe\u8ba1\u539f\u5219\u5728uml\u4e2d\u7684\u4f53\u73b0",children:[],level:3}],level:2},{value:"\u5e94\u7528",id:"\u5e94\u7528",children:[{value:"\u4f18\u70b9",id:"\u4f18\u70b9",children:[],level:3},{value:"\u7f3a\u70b9",id:"\u7f3a\u70b9",children:[],level:3},{value:"\u4f7f\u7528\u573a\u666f",id:"\u4f7f\u7528\u573a\u666f",children:[{value:"\u573a\u666f\u63cf\u8ff0",id:"\u573a\u666f\u63cf\u8ff0",children:[],level:4},{value:"\u5177\u4f53\u6848\u4f8b",id:"\u5177\u4f53\u6848\u4f8b",children:[],level:4}],level:3},{value:"\u6ce8\u610f\u4e8b\u9879",id:"\u6ce8\u610f\u4e8b\u9879",children:[],level:3}],level:2},{value:"\u6269\u5c55",id:"\u6269\u5c55",children:[{value:"\u81ea\u5b9a\u4e49Target Chunk",id:"\u81ea\u5b9a\u4e49target-chunk",children:[],level:3},{value:"\u5728GLSL Config\u4e2d\u5b9a\u4e49\u6ca1\u6709\u6750\u8d28\u7684Shader\u7684Target GLSL",id:"\u5728glsl-config\u4e2d\u5b9a\u4e49\u6ca1\u6709\u6750\u8d28\u7684shader\u7684target-glsl",children:[],level:3},{value:"\u6784\u9020DX12\u3001Vulkan\u3001WebGPU\u7b49\u73b0\u4ee3\u56fe\u5f62API\u7684\u7740\u8272\u5668\u4ee3\u7801",id:"\u6784\u9020dx12vulkanwebgpu\u7b49\u73b0\u4ee3\u56fe\u5f62api\u7684\u7740\u8272\u5668\u4ee3\u7801",children:[],level:3},{value:"\u5347\u7ea7\u4e3a\u7740\u8272\u5668\u8bed\u8a00",id:"\u5347\u7ea7\u4e3a\u7740\u8272\u5668\u8bed\u8a00",children:[],level:3}],level:2},{value:"\u6700\u4f73\u5b9e\u8df5",id:"\u6700\u4f73\u5b9e\u8df5",children:[{value:"\u54ea\u4e9b\u573a\u666f\u4e0d\u9700\u8981\u4f7f\u7528\u6a21\u5f0f",id:"\u54ea\u4e9b\u573a\u666f\u4e0d\u9700\u8981\u4f7f\u7528\u6a21\u5f0f",children:[],level:3}],level:2},{value:"\u66f4\u591a\u8d44\u6599\u63a8\u8350",id:"\u66f4\u591a\u8d44\u6599\u63a8\u8350",children:[],level:2}],p={toc:s},u="wrapper";function c(e){let{components:n,...l}=e;return(0,r.kt)(u,(0,t.Z)({},p,l,{components:n,mdxType:"MDXLayout"}),(0,r.kt)("h1",{id:"\u7b2c8\u7ae0-\u62fc\u63a5\u6a21\u5f0f"},"\u7b2c8\u7ae0 \u62fc\u63a5\u6a21\u5f0f"),(0,r.kt)("h2",{id:"\u4f7f\u7528\u9884\u5b9a\u4e49\u5b8f\u62fc\u63a5glsl"},"\u4f7f\u7528\u9884\u5b9a\u4e49\u5b8f\u62fc\u63a5GLSL"),(0,r.kt)("h3",{id:"\u9700\u6c42"},"\u9700\u6c42"),(0,r.kt)("p",null,"\u6211\u4eec\u9700\u8981\u5b9e\u73b0\u4e00\u4e2a\u6750\u8d28\u7cfb\u7edf\uff0c\u5305\u62ec\u4e24\u79cd\u6750\u8d28\uff1a\u57fa\u7840\u6750\u8d28\u3001PBR\u6750\u8d28\uff0c\u5b83\u4eec\u80fd\u9009\u62e9\u6027\u5730\u4f7f\u7528\u8d34\u56fe\uff0c\u53ea\u662f\u5b83\u4eec\u4f7f\u7528\u7684\u8d34\u56fe\u4e0d\u4e00\u6837\u3002\u5176\u4e2d\u57fa\u7840\u6750\u8d28\u4f7f\u7528\u7684\u8d34\u56fe\u662f\u666e\u901a\u8d34\u56fe\uff0cPBR\u6750\u8d28\u4f7f\u7528\u7684\u8d34\u56fe\u662fdiffuse\u8d34\u56fe\u3002\u53e6\u5916\uff0c\u7531\u5f15\u64ce\u51b3\u5b9a\u662f\u5426\u652f\u6301Instance\uff0c\u5b83\u662f\u4e00\u79cd\u6279\u91cf\u6e32\u67d3\u7684\u6280\u672f"),(0,r.kt)("h3",{id:"\u5b9e\u73b0\u601d\u8def"},"\u5b9e\u73b0\u601d\u8def"),(0,r.kt)("p",null,(0,r.kt)("img",{alt:"\u6750\u8d28\u4e0eGLSL\u7684\u5bf9\u5e94\u5173\u7cfb\u56fe",src:a(3776).Z})),(0,r.kt)("p",null,"\u5982\u4e0a\u56fe\u6240\u793a\uff0c\u4e00\u4e2a\u6750\u8d28\u4f7f\u7528\u4e00\u4e2aShader\uff0c\u4e00\u4e2aShader\u6709\u4e00\u5957GLSL\uff0c\u5373\u4e00\u4e2aVS GLSL\uff08\u9876\u70b9\u7740\u8272\u5668\u7684GLSL\uff09\u548c\u4e00\u4e2aFS GLSL\uff08\u7247\u5143\u7740\u8272\u5668\u7684GLSL\uff09"),(0,r.kt)("p",null,"\u8fd9\u4e24\u79cd\u6750\u8d28\u5bf9\u5e94\u7684Shader\u652f\u6301\u7684\u529f\u80fd\u6709\u4e09\u4e2a\uff1a\u666e\u901a\u8d34\u56fe\u3001diffuse\u8d34\u56fe\u3001Instance\u3002\u4e00\u5171\u6709\u516b\u79cd\u60c5\u51b5\uff0c\u5177\u4f53\u5982\u4e0b\uff1a",(0,r.kt)("br",{parentName:"p"}),"\n","\u5bf9\u4e8e\u57fa\u7840\u6750\u8d28\u7684Shader\u800c\u8a00\uff0c\u6709\u4e0b\u9762\u56db\u79cd\u60c5\u51b5\uff1a  "),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"[\u6709\u666e\u901a\u8d34\u56fe\uff0c\u652f\u6301Instance]"),(0,r.kt)("li",{parentName:"ul"},"[\u6709\u666e\u901a\u8d34\u56fe\uff0c\u4e0d\u652f\u6301Instance]"),(0,r.kt)("li",{parentName:"ul"},"[\u6ca1\u6709\u666e\u901a\u8d34\u56fe\uff0c\u652f\u6301Instance]"),(0,r.kt)("li",{parentName:"ul"},"[\u6ca1\u6709\u666e\u901a\u8d34\u56fe\uff0c\u4e0d\u652f\u6301Instance]")),(0,r.kt)("p",null,"\u5bf9\u4e8ePBR\u6750\u8d28\u7684Shader\u800c\u8a00\uff0c\u6709\u4e0b\u9762\u56db\u79cd\u60c5\u51b5\uff1a  "),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"[\u6709diffuse\u8d34\u56fe\uff0c\u652f\u6301Instance]"),(0,r.kt)("li",{parentName:"ul"},"[\u6709diffuse\u8d34\u56fe\uff0c\u4e0d\u652f\u6301Instance]"),(0,r.kt)("li",{parentName:"ul"},"[\u6ca1\u6709diffuse\u8d34\u56fe\uff0c\u652f\u6301Instance]"),(0,r.kt)("li",{parentName:"ul"},"[\u6ca1\u6709diffuse\u8d34\u56fe\uff0c\u4e0d\u652f\u6301Instance]")),(0,r.kt)("p",null,"\u6211\u4eec\u9700\u8981\u4e3a\u6bcf\u4e00\u79cd\u60c5\u51b5\u90fd\u5199\u4e00\u5957GLSL\uff0c\u5171\u9700\u5199\u516b\u5957GLSL"),(0,r.kt)("p",null,"\u8fd9\u4e2a\u65b9\u6848\u7684\u95ee\u9898\u662fShader\u6bcf\u652f\u6301\u4e00\u79cd\u65b0\u7684\u529f\u80fd\uff0cGLSL\u7684\u5957\u6570\u5c31\u8981\u7ffb\u500d\uff1b\u6bcf\u589e\u52a0\u4e00\u79cd\u6750\u8d28\uff0c\u5c31\u9700\u8981\u589e\u52a0\u4e00\u79cdShader\uff0c\u4ece\u800c\u4e3a\u6bcf\u79cd\u60c5\u51b5\u589e\u52a0\u4e00\u5957GLSL\u7684\u5957\u6570\u3002\u56e0\u4e3a\u6bcf\u5957GLSL\u90fd\u9700\u8981\u4ece\u96f6\u5199\uff0c\u6240\u4ee5\u4f1a\u6709\u5de8\u5927\u7684\u5b9e\u73b0\u6210\u672c"),(0,r.kt)("p",null,"\u53ef\u4ee5\u901a\u8fc7\u201c\u4f7f\u7528\u9884\u5b9a\u4e49\u7684\u5b8f\u201d\u6765\u89e3\u51b3\u8fd9\u4e2a\u95ee\u9898\uff0c\u5177\u4f53\u7684\u65b9\u6848\u5982\u4e0b\uff1a",(0,r.kt)("br",{parentName:"p"}),"\n",'\u6211\u4eec\u53ea\u9700\u8981\u4e3a\u6bcf\u79cd\u6750\u8d28\u7684Shader\u5199\u4e00\u5957\u9ed8\u8ba4\u7684\u80fd\u652f\u6301\u5404\u79cd\u529f\u80fd\u7684GLSL\uff0c\u5728\u5176\u4e2d\u7528\u5927\u91cf\u201c#ifdef \u529f\u80fd\u540d/#else/#endif\x7f\u201d\u5c06\u5404\u4e2a\u529f\u80fd\u5206\u5f00\u5904\u7406\uff1b\u7136\u540e\u5728\u521d\u59cb\u5316\u65f6\uff0c\u5224\u65ad\u6750\u8d28\u662f\u5426\u652f\u6301\u67d0\u4e2a\u529f\u80fd\uff0c\u652f\u6301\u7684\u8bdd\u5219\u5728\u9ed8\u8ba4\u7684GLSL\u7684\u57fa\u7840\u4e0a\u52a0\u5165"#define \u529f\u80fd\u540d"\u6765\u5f00\u542f\u8be5\u529f\u80fd\uff0c\u6210\u4e3a\u4e00\u5957\u65b0\u7684\u652f\u6301\u8be5\u529f\u80fd\u7684GLSL\u3002\u8fd9\u6837\u7684\u8bdd\u5c31\u53ef\u4ee5\u5728\u9ed8\u8ba4\u7684GLSL\u57fa\u7840\u4e0a\u521b\u5efa\u51fa\u5206\u522b\u652f\u6301\u5404\u79cd\u60c5\u51b5\u7684\u516b\u5957GLSL\u4e86  '),(0,r.kt)("p",null,'\u73b0\u5728\u8981\u5b9e\u73b0\u516b\u5957GLSL\uff0c\u4e0d\u9700\u8981\u4ece\u96f6\u5b9e\u73b0\uff0c\u800c\u53ea\u9700\u5199\u4e00\u5957\u9ed8\u8ba4\u7684GLSL\uff0c\u7136\u540e\u5728\u5b83\u7684\u57fa\u7840\u4e0a\u52a0\u5165\u4e0d\u540c\u7684"#define \u529f\u80fd\u540d"\u5373\u53ef\uff0c\u5927\u5927\u51cf\u5c11\u4e86\u5b9e\u73b0\u6210\u672c'),(0,r.kt)("h3",{id:"\u7ed9\u51fauml"},"\u7ed9\u51faUML"),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"\u9886\u57df\u6a21\u578b")),(0,r.kt)("p",null,(0,r.kt)("img",{alt:"\u9886\u57df\u6a21\u578b\u56fe",src:a(1732).Z})),(0,r.kt)("p",null,"\u603b\u4f53\u6765\u770b\uff0c\u9886\u57df\u6a21\u578b\u5206\u4e3a\u7528\u6237\u3001GLSL\u3001\u5f15\u64ce\u8fd9\u4e09\u4e2a\u90e8\u5206"),(0,r.kt)("p",null,"\u6211\u4eec\u770b\u4e0b\u7528\u6237\u8fd9\u4e2a\u90e8\u5206\uff1a"),(0,r.kt)("p",null,"Client\u662f\u7528\u6237"),(0,r.kt)("p",null,"\u6211\u4eec\u770b\u4e0bGLSL\u8fd9\u4e2a\u90e8\u5206\uff1a"),(0,r.kt)("p",null,"BasicMaterialShaderGLSL\uff08Default\uff09\u662f\u9ed8\u8ba4\u7684\u901a\u8fc7\u9884\u5b9a\u4e49\u5b8f\u6765\u652f\u6301\u57fa\u7840\u6750\u8d28\u7684Shader\u7684\u5404\u79cd\u529f\u80fd\u7684\u4e00\u5957GLSL"),(0,r.kt)("p",null,"BasicMaterialShaderGLSL\uff08Add Define\uff09\u662f\u5728BasicMaterialShaderGLSL\uff08Default\uff09\u57fa\u7840\u4e0a\u52a0\u5165Define\u53d8\u91cf\uff0c\u6765\u652f\u6301\u57fa\u7840\u6750\u8d28\u7684Shader\u7684\u67d0\u4e9b\u529f\u80fd\u7684\u4e00\u5957GLSL\u3002\u6700\u591a\u6709\u56db\u5957BasicMaterialShaderGLSL\uff08Add Define\uff09\uff0c\u5206\u522b\u5bf9\u5e94\u57fa\u7840\u6750\u8d28\u7684Shader\u7684\u56db\u79cd\u60c5\u51b5"),(0,r.kt)("p",null,"PBRMaterialShaderGLSL\uff08Default\uff09\u662f\u9ed8\u8ba4\u7684\u901a\u8fc7\u9884\u5b9a\u4e49\u5b8f\u6765\u652f\u6301PBR\u6750\u8d28\u7684\u5404\u79cd\u529f\u80fd\u7684\u4e00\u5957GLSL"),(0,r.kt)("p",null,"PBRMaterialShaderGLSL\uff08Add Define\uff09\u662f\u5728PBRMaterialShaderGLSL\uff08Default\uff09\u57fa\u7840\u4e0a\u52a0\u5165Define\u53d8\u91cf\uff0c\u6765\u652f\u6301PBR\u6750\u8d28\u7684Shader\u7684\u67d0\u4e9b\u529f\u80fd\u7684\u4e00\u5957GLSL\u3002\u6700\u591a\u6709\u56db\u5957PBRMaterialShaderGLSL\uff08Add Define\uff09\uff0c\u5206\u522b\u5bf9\u5e94PBR\u6750\u8d28\u7684Shader\u7684\u56db\u79cd\u60c5\u51b5"),(0,r.kt)("p",null,"\u6211\u4eec\u770b\u4e0b\u5f15\u64ce\u8fd9\u4e2a\u90e8\u5206\uff1a"),(0,r.kt)("p",null,"Engine\u662f\u5f15\u64ce\u7684\u95e8\u6237\uff0c\u8d1f\u8d23\u63d0\u4f9bAPI\u7ed9Client"),(0,r.kt)("p",null,"InitBasicMaterialShader\u8d1f\u8d23\u521d\u59cb\u5316\u6240\u6709\u57fa\u7840\u6750\u8d28\u7684Shader\uff0c\u5b83\u5224\u65ad\u57fa\u7840\u6750\u8d28\u7684Shader\u662f\u5426\u652f\u6301\u529f\u80fd\uff0c\u652f\u6301\u7684\u8bdd\u5c31\u5c06BasicMaterialShaderGLSL\uff08Default\uff09\u4fee\u6539\u4e3aBasicMaterialShaderGLSL\uff08Add Define\uff09\uff0c\u7136\u540e\u4f7f\u7528\u5b83\u6765\u521b\u5efa\u5bf9\u5e94\u7684Shader\u3002"),(0,r.kt)("p",null,"InitPBRMaterialShader\u8ddfInitBasicMaterialShader\u7c7b\u4f3c\uff0c\u4e0d\u540c\u7684\u5730\u65b9\u662f\u521d\u59cb\u5316\u7684\u5bf9\u8c61\u7531\u57fa\u7840\u6750\u8d28\u53d8\u4e3aPBR\u6750\u8d28"),(0,r.kt)("p",null,"Render\u8d1f\u8d23\u6e32\u67d3\uff0c\u5b83\u4f1a\u904d\u5386\u6240\u6709\u7684GameObjects\uff0c\u83b7\u5f97\u5e76\u53d1\u9001\u5b83\u4eec\u7684\u9876\u70b9\u6570\u636e\u548cUniform\u6570\u636e"),(0,r.kt)("h3",{id:"\u7ed9\u51fa\u4ee3\u7801"},"\u7ed9\u51fa\u4ee3\u7801"),(0,r.kt)("p",null,"\u9996\u5148\uff0c\u6211\u4eec\u770b\u4e0bClient\u7684\u4ee3\u7801",(0,r.kt)("br",{parentName:"p"}),"\n","\u7136\u540e\uff0c\u6211\u4eec\u4f9d\u6b21\u770b\u4e0bClient\u4ee3\u7801\u4e2d\u6bcf\u4e2a\u6b65\u9aa4\u7684\u4ee3\u7801\uff0c\u5b83\u4eec\u5305\u62ec\uff1a"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"\u521b\u5efaEngineState\u7684\u4ee3\u7801"),(0,r.kt)("li",{parentName:"ul"},"\u521b\u5efa\u573a\u666f\u7684\u4ee3\u7801"),(0,r.kt)("li",{parentName:"ul"},"\u521d\u59cb\u5316\u6240\u6709\u57fa\u7840\u6750\u8d28\u7684Shader\u7684\u4ee3\u7801"),(0,r.kt)("li",{parentName:"ul"},"\u521d\u59cb\u5316\u6240\u6709PBR\u6750\u8d28\u7684Shader\u7684\u4ee3\u7801"),(0,r.kt)("li",{parentName:"ul"},"\u6e32\u67d3\u573a\u666f\u7684\u4ee3\u7801")),(0,r.kt)("p",null,"\u6700\u540e\uff0c\u6211\u4eec\u8fd0\u884cClient\u7684\u4ee3\u7801"),(0,r.kt)("h4",{id:"client\u7684\u4ee3\u7801"},"Client\u7684\u4ee3\u7801"),(0,r.kt)("p",null,"Client"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-ts"},"let state = Engine.createState()\n\nlet sceneData = ClientUtils.createScene(state)\nstate = sceneData[0]\nlet [allBasicMaterials, allPBRMaterials, _] = sceneData[1]\n\nstate = Engine.initBasicMaterialShader(state, allBasicMaterials)\n\nstate = Engine.initPBRMaterialShader(state, allPBRMaterials)\n\nstate = Engine.initCamera(state)\n\nstate = Engine.render(state)\n")),(0,r.kt)("p",null,"Client\u9996\u5148\u521b\u5efa\u4e86\u5f15\u64ce\u7684EngineState\uff0c\u7528\u6765\u4fdd\u5b58\u5f15\u64ce\u7684\u6240\u6709\u6570\u636e\uff1b\u7136\u540e\u521b\u5efa\u4e86\u573a\u666f\uff1b\u7136\u540e\u521d\u59cb\u5316\u6240\u6709\u57fa\u7840\u6750\u8d28\u7684Shader\uff1b\u7136\u540e\u521d\u59cb\u5316\u6240\u6709PBR\u6750\u8d28\u7684Shader\uff1b\u63a5\u7740\u521d\u59cb\u5316\u76f8\u673a\uff0c\u8bbe\u7f6e\u4e0e\u5047\u7684\u89c6\u56fe\u77e9\u9635\u548c\u900f\u89c6\u77e9\u9635\uff1b\u6700\u540e\u6e32\u67d3\u573a\u666f"),(0,r.kt)("h4",{id:"\u521b\u5efaenginestate\u7684\u4ee3\u7801"},"\u521b\u5efaEngineState\u7684\u4ee3\u7801"),(0,r.kt)("p",null,"Engine"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-ts"},"export let createState = (): state => {\n    return {\n        ...\n        isSupportInstance: true,\n        ...\n    }\n}\n")),(0,r.kt)("p",null,"createState\u51fd\u6570\u521b\u5efa\u4e86EngineState\u3002\u5728\u521b\u5efa\u7684EngineState\u4e2d\uff0c\u901a\u8fc7\u8bbe\u7f6e\u5b57\u6bb5isSupportInstance\u6765\u8bbe\u7f6e\u662f\u5426\u652f\u6301Instance\uff08\u6b64\u5904\u8bbe\u7f6e\u4e3a\u652f\u6301\uff09"),(0,r.kt)("h4",{id:"\u521b\u5efa\u573a\u666f\u7684\u4ee3\u7801"},"\u521b\u5efa\u573a\u666f\u7684\u4ee3\u7801"),(0,r.kt)("p",null,"ClientUtils"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-ts"},"export let createScene = (state) => {\n    \u521b\u5efagameObject1\n\n    \u521b\u5efa\u57fa\u7840\u6750\u8d28basicMaterial1\n    \u8bbe\u7f6ebasicMaterial1\u7684\u8d34\u56fe\n\n    \u521b\u5efatransform1\n    \u8bbe\u7f6etransform1\u7684\u6570\u636e\n\n    \u6302\u8f7dbasicMaterial1\u3001transform1\u5230gameObject1\n\n\n    \u521b\u5efagameObject2\n\n    \u521b\u5efaPBR\u6750\u8d28pbrMaterial1\n\n    \u521b\u5efatransform2\n    \u8bbe\u7f6etransform2\u7684\u6570\u636e\n\n    \u6302\u8f7dpbrMaterial1\u3001transform2\u5230gameObject2\n\n\n    \u521b\u5efagameObject3\n\n    \u521b\u5efa\u57fa\u7840\u6750\u8d28basicMaterial2\n    \u8bbe\u7f6ebasicMaterial2\u7684\u8d34\u56fe\n\n    \u521b\u5efatransform3\n    \u8bbe\u7f6etransform3\u7684\u6570\u636e\n\n    \u6302\u8f7dbasicMaterial2\u3001transform3\u5230gameObject3\n\n    \u8fd4\u56destate\u548c\u521b\u5efa\u7684\u6240\u6709\u7ec4\u4ef6\n}\n")),(0,r.kt)("p",null,"createScene\u51fd\u6570\u521b\u5efa\u4e86\u573a\u666f\uff0c\u573a\u666f\u5305\u62ec3\u4e2agameObject\uff0c2\u4e2a\u57fa\u7840\u6750\u8d28\u7ec4\u4ef6\uff08basicMaterial1\u3001basicMaterial2\uff09\u30011\u4e2aPBR\u6750\u8d28\u7ec4\u4ef6\uff08pbrMaterial1\uff09\u30013\u4e2atransform\u7ec4\u4ef6\u3002\u5176\u4e2dbasicMaterial1\u3001basicMaterial2\u6709\u8d34\u56fe\uff0cpbrMaterial1\u6ca1\u6709\u8d34\u56fe\uff1bgameObject1\u3001gameObject3\u6302\u8f7d\u4e86\u57fa\u7840\u6750\u8d28\u7ec4\u4ef6\uff0cgameObject2\u6302\u8f7d\u4e86PBR\u6750\u8d28\u7ec4\u4ef6"),(0,r.kt)("p",null,"\u503c\u5f97\u8bf4\u660e\u7684\u662f\uff1a",(0,r.kt)("br",{parentName:"p"}),"\n","\u6211\u4eec\u8fd9\u91cc\u4f7f\u7528ECS\u6a21\u5f0f\u7684\u601d\u8def\uff0c\u5728\u573a\u666f\u4e2d\u521b\u5efa\u7684\u6240\u6709\u7684GameObject\u548c\u7ec4\u4ef6\u90fd\u53ea\u662f\u4e00\u4e2anumber\u7c7b\u578b\u7684\u503c\u800c\u5df2"),(0,r.kt)("h4",{id:"\u521d\u59cb\u5316\u6240\u6709\u57fa\u7840\u6750\u8d28\u7684shader\u7684\u4ee3\u7801"},"\u521d\u59cb\u5316\u6240\u6709\u57fa\u7840\u6750\u8d28\u7684Shader\u7684\u4ee3\u7801"),(0,r.kt)("p",null,"InitBasicMaterialShader"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-ts"},"export let initBasicMaterialShader =\n  (state: state, allMaterials: Array<material>): state => {\n    let [newProgramMap, newShaderIndexMap, newMaxShaderIndex] = InitMaterialShaderUtils.initMaterialShader(state, _buildGLSL, state.basicMaterialShaderIndexMap, allMaterials)\n\n    return {\n      ...state,\n      programMap: newProgramMap,\n      maxShaderIndex: newMaxShaderIndex,\n      basicMaterialShaderIndexMap: newShaderIndexMap\n    }\n  }\n")),(0,r.kt)("p",null,"InitMaterialShaderUtils"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-ts"},'export let initMaterialShader = (state, buildGLSL, shaderIndexMap, allMaterials) => {\n    let [newProgramMap, newShaderIndexMap, _, newMaxShaderIndex] = allMaterials.reduce(([programMap, shaderIndexMap, glslMap, maxShaderIndex]: any, material) => {\n        let glsl = buildGLSL(state, material)\n\n        let [shaderIndex, newMaxShaderIndex] = ShaderUtils.generateShaderIndex(glslMap, glsl, maxShaderIndex)\n\n        if (!programMap.has(shaderIndex)) {\n            programMap = programMap.set(shaderIndex, ShaderUtils.createFakeProgram(glsl))\n        }\n\n        if (!glslMap.has(shaderIndex)) {\n            glslMap = glslMap.set(shaderIndex, glsl)\n        }\n\n        console.log("shaderIndex:", shaderIndex)\n\n        return [\n            programMap,\n            ShaderUtils.setShaderIndex(shaderIndexMap, material, shaderIndex),\n            glslMap,\n            newMaxShaderIndex\n        ]\n    }, [state.programMap, shaderIndexMap, Map(), state.maxShaderIndex])\n\n    return [newProgramMap, newShaderIndexMap, newMaxShaderIndex]\n}\n')),(0,r.kt)("p",null,"initBasicMaterialShader\u51fd\u6570\u521d\u59cb\u5316\u6240\u6709\u57fa\u7840\u6750\u8d28\u7684Shader\uff0c\u5b83\u8c03\u7528InitMaterialShaderUtils\u7684initMaterialShader\u51fd\u6570\u6765\u904d\u5386\u4e86\u6240\u6709\u7684\u57fa\u7840\u6750\u8d28\uff0c\u521b\u5efa\u4e86\u57fa\u7840\u6750\u8d28\u5bf9\u5e94\u7684shaderIndex\u548cprogram\uff0c\u5c06\u5176\u5206\u522b\u4fdd\u5b58\u5728EngineState\u7684basicMaterialShaderIndexMap\u3001programMap\u4e2d"),(0,r.kt)("p",null,"\u8fd9\u91cc\u65b0\u63d0\u51fa\u4e86shaderIndex\u7684\u6982\u5ff5\uff0c\u5b83\u662fshader\u7684\u7d22\u5f15\uff0c\u4e00\u4e2ashaderIndex\u5bf9\u5e94\u4e00\u4e2aShader\u3002\u5b83\u4eec\u7684\u5bf9\u5e94\u5173\u7cfb\u5982\u4e0b\u56fe\u6240\u793a\uff1a",(0,r.kt)("br",{parentName:"p"}),"\n",(0,r.kt)("img",{alt:"Material\u3001ShaderIndex\u3001Program\u3001GLSL\u5bf9\u5e94\u5173\u7cfb\u56fe",src:a(7249).Z})),(0,r.kt)("p",null,"\u5728\u540e\u9762\u6e32\u67d3\u65f6\uff0c\u6211\u4eec\u4f1a\u9996\u5148\u901a\u8fc7Material\u62ff\u5230ShaderIndex\uff0c\u7136\u540e\u901a\u8fc7ShaderIndex\u518d\u62ff\u5230Program\uff0c\u6700\u540euse\u8be5Program"),(0,r.kt)("p",null,"initBasicMaterialShader\u51fd\u6570\u8c03\u7528\u4e86_buildGLSL\u51fd\u6570\u6765\u6784\u9020BasicMaterialShaderGLSL\uff08Add Define\uff09\uff0c\u5b83\u7684\u5b9e\u73b0\u4ee3\u7801\u5982\u4e0b\uff1a",(0,r.kt)("br",{parentName:"p"}),"\n","initBasicMaterialShader"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-ts"},'let _buildDefaultVSGLSL = () => {\n    return `\n...\n#ifdef INSTANCE\n...\n#endif\n\n#ifdef NO_INSTANCE\n...\n#endif\n\nattribute vec3 a_position;\n\n#ifdef MAP\n...\n#endif\n\nuniform mat4 u_vMatrix;\nuniform mat4 u_pMatrix;\n\n...\nvoid main(void){\n#ifdef INSTANCE\n  mat4 mMatrix = ...\n#endif\n\n#ifdef NO_INSTANCE\n  mat4 mMatrix = ...\n#endif\n\n  gl_Position = u_pMatrix * u_vMatrix * mMatrix * vec4(a_position, 1.0);\n\n#ifdef MAP\n  ...\n#endif\n}\n    `\n}\n\nlet _buildDefaultFSGLSL = () => {\n    return `\n...\n#ifdef MAP\n...\n#endif\n\n...\n\nvoid main(void){\n#ifdef MAP\n  vec4 totalColor = ...\n#endif\n\n#ifdef NO_MAP\n  vec4 totalColor = ...\n#endif\n\n  gl_FragColor = vec4(totalColor.rgb, totalColor.a);\n}\n    `\n}\n\nlet _addDefine = (glsl: string, name: string): string => {\n    return "#define " + name + "\\n" + glsl\n}\n\nlet _buildGLSL = (state: state, material: material): [string, string] => {\n    let vsGLSL = _buildDefaultVSGLSL()\n    let fsGLSL = _buildDefaultFSGLSL()\n\n    if (state.isSupportInstance) {\n        vsGLSL = _addDefine(vsGLSL, "INSTANCE")\n    }\n    else {\n        vsGLSL = _addDefine(vsGLSL, "NO_INSTANCE")\n    }\n\n    if (hasBasicMap(state.basicMaterialState, material)) {\n        vsGLSL = _addDefine(vsGLSL, "MAP")\n        fsGLSL = _addDefine(fsGLSL, "MAP")\n    }\n    else {\n        vsGLSL = _addDefine(vsGLSL, "NO_MAP")\n        fsGLSL = _addDefine(fsGLSL, "NO_MAP")\n    }\n\n    return [vsGLSL, fsGLSL]\n}\n')),(0,r.kt)("p",null,"_buildGLSL\u51fd\u6570\u9996\u5148\u6784\u9020\u4e86BasicMaterialShaderGLSL\uff08Default\uff09\uff1b\u7136\u540e\u6839\u636e\u5bf9Instance\u7684\u652f\u6301\u60c5\u51b5\u4ee5\u53ca\u6750\u8d28\u662f\u5426\u6709\u8d34\u56fe\u7684\u5224\u65ad\uff0c\u5728BasicMaterialShaderGLSL\uff08Default\uff09\u7684\u57fa\u7840\u4e0a\u52a0\u5165\u5bf9\u5e94\u7684Define\u53d8\u91cf\uff1b\u6700\u540e\u8fd4\u56de\u4fee\u6539\u540e\u7684\u4e00\u5957GLSL\uff0c\u5373\u8fd4\u56deBasicMaterialShaderGLSL\uff08Add Define\uff09"),(0,r.kt)("p",null,"\u6211\u4eec\u7ee7\u7eed\u56de\u5230InitMaterialShaderUtils\u7684initMaterialShader\u51fd\u6570\uff0c\u5b83\u5728\u8c03\u7528\u4f20\u8fdb\u6765\u7684buildGLSL\u51fd\u6570\uff08\u4e5f\u5c31\u662fInitBasicMaterialShader\u7684_buildGLSL\u51fd\u6570\uff09\u540e\uff0c\u8c03\u7528\u4e86generateShaderIndex\u51fd\u6570\u6765\u751f\u6210shaderIndex\uff0c\u76f8\u5173\u4ee3\u7801\u5982\u4e0b\uff1a",(0,r.kt)("br",{parentName:"p"}),"\n","InitMaterialShaderUtils"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-ts"},"export let initMaterialShader = (state, buildGLSL, shaderIndexMap, allMaterials) => {\n        ...\n        let glsl = buildGLSL(state, material)\n\n        let [shaderIndex, newMaxShaderIndex] = ShaderUtils.generateShaderIndex(glslMap, glsl, maxShaderIndex)\n\n        //\u5982\u679c\u662f\u4e4b\u524d\u7684shaderIndex\uff0c\u5219\u4e0d\u521b\u5efa\u65b0\u7684Program\n        if (!programMap.has(shaderIndex)) {\n            programMap = programMap.set(shaderIndex, ShaderUtils.createFakeProgram(glsl))\n        }\n        ...\n}\n")),(0,r.kt)("p",null,"ShaderUtils"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-ts"},"type vsGLSL = string\ntype fsGLSL = string\n\ntype glsl = [vsGLSL, fsGLSL]\n\ntype glslMap = Map<shaderIndex, glsl>\n\nexport let generateShaderIndex = (glslMap: glslMap, glsl: glsl, maxShaderIndex: shaderIndex): [shaderIndex, shaderIndex] => {\n    let result = glslMap.findEntry((value) => {\n        return value[0] == glsl[0] && value[1] == glsl[1]\n    })\n\n    if (result === undefined) {\n        return [maxShaderIndex, maxShaderIndex + 1]\n    }\n\n    return [getExnFromStrictUndefined(result[0]), maxShaderIndex]\n}\n")),(0,r.kt)("p",null,"generateShaderIndex\u51fd\u6570\u6bd4\u8f83\u4e86\u65b0\u7684GLSL\u662f\u5426\u4e0e\u4e4b\u524d\u7684GLSL\u76f8\u540c\uff0c\u5982\u679c\u4e0d\u76f8\u540c\uff0c\u5219\u8fd4\u56de\u65b0\u7684shaderIndex\uff1b\u5426\u5219\u8fd4\u56de\u4e4b\u524d\u7684GLSL\u5bf9\u5e94\u7684shaderIndex\u3002\u8fd9\u6837\u505a\u7684\u76ee\u7684\u662f\u4e3a\u4e86\u4f18\u5316\uff0c\u4f7f\u5f97\u652f\u6301\u540c\u6837\u529f\u80fd\u7684\u6750\u8d28\u5171\u4eab\u540c\u4e00\u4e2aShaderIndex\uff0c\u4ece\u800c\u5171\u4eab\u540c\u4e00\u4e2aProgram"),(0,r.kt)("h4",{id:"\u521d\u59cb\u5316\u6240\u6709pbr\u6750\u8d28\u7684shader\u7684\u4ee3\u7801"},"\u521d\u59cb\u5316\u6240\u6709PBR\u6750\u8d28\u7684Shader\u7684\u4ee3\u7801"),(0,r.kt)("p",null,"InitPBRMaterialShader\u7684initPBRMaterialShader\u51fd\u6570\u5b9e\u73b0\u4e86\u521d\u59cb\u5316\u6240\u6709PBR\u6750\u8d28\u7684shader\uff0c\u5b83\u4e0eInitPBRMaterialShader\u7684initBasicMaterialShader\u51fd\u6570\u7c7b\u4f3c\uff0c\u6545\u7701\u7565\u4e86\u4ee3\u7801\u3002\u5b83\u4eec\u4e0d\u540c\u7684\u5730\u65b9\u4e3b\u8981\u5982\u4e0b\uff1a"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"\u4f20\u5165\u7684allMaterials\u662f\u6240\u6709\u7684PBR\u6750\u8d28\u7ec4\u4ef6\u800c\u4e0d\u662f\u6240\u6709\u7684\u57fa\u7840\u6750\u8d28\u7ec4\u4ef6\uff1b"),(0,r.kt)("li",{parentName:"ul"},"\u4f20\u5165InitMaterialShaderUtils.initMaterialShader\u51fd\u6570\u7684buildGLSL\u51fd\u6570\u4e0d\u4e00\u6837\uff0c\u8be5\u51fd\u6570\u662f\u4fee\u6539PBRMaterialShaderGLSL\uff08Default\uff09\u800c\u4e0d\u662f\u4fee\u6539BasicMaterialShaderGLSL\uff08Default\uff09\uff1b"),(0,r.kt)("li",{parentName:"ul"},"\u751f\u6210\u7684shaderIndex\u6539\u4e3a\u4fdd\u5b58\u5230EngineState\u7684pbrMaterialShaderIndexMap\u4e2d")),(0,r.kt)("h4",{id:"\u6e32\u67d3\u573a\u666f\u7684\u4ee3\u7801"},"\u6e32\u67d3\u573a\u666f\u7684\u4ee3\u7801"),(0,r.kt)("p",null,"Render"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-ts"},'export let render = (state: state): state => {\n    let gl = state.gl\n    let programMap = state.programMap\n\n    getAllGameObjects(state.gameObjectState).forEach(gameObject => {\n        let [material, materialType_] = getMaterial(state.gameObjectState, gameObject)\n        let transform = getTransform(state.gameObjectState, gameObject)\n\n        //\u4e0d\u540c\u7684\u6750\u8d28\u4ece\u4e0d\u540c\u7684shaderIndexMap\u4e2d\u53d6\u5f97shaderIndex\n        let shaderIndex = null\n        switch (materialType_) {\n            case materialType.Basic:\n                shaderIndex = ShaderUtils.getShaderIndex(state.basicMaterialShaderIndexMap, material)\n                break\n            case materialType.PBR:\n                shaderIndex = ShaderUtils.getShaderIndex(state.pbrMaterialShaderIndexMap, material)\n                break\n        }\n\n        let program = getExnFromStrictUndefined(programMap.get(shaderIndex))\n\n        gl.useProgram(program)\n\n        _sendAttributeData(state, shaderIndex, gl, program)\n        _sendUniformData(state, transform, [material, materialType_], gl, program)\n\n        console.log("\u5176\u5b83\u6e32\u67d3\u903b\u8f91...")\n    })\n\n    return state\n}\n')),(0,r.kt)("p",null,"render\u51fd\u6570\u5b9e\u73b0\u4e86\u6e32\u67d3\u573a\u666f\uff0c\u5b83\u904d\u5386\u6240\u6709\u7684GameObject\uff0c\u6e32\u67d3\u6bcf\u4e2aGameObject\u3002\u5728\u6bcf\u6b21\u7684\u904d\u5386\u4e2d\uff0c\u9996\u5148\u83b7\u5f97\u6bcf\u4e2agameObject\u7684\u7ec4\u4ef6\u4ee5\u53cashaderIndex\u3001program\uff1b\u7136\u540e\u53d1\u9001\u9876\u70b9\u6570\u636e\u548cUniform\u6570\u636e\uff1b\u6700\u540e\u6267\u884c\u5176\u5b83\u7684\u6e32\u67d3\u903b\u8f91"),(0,r.kt)("p",null,"\u6211\u4eec\u770b\u4e0b\u53d1\u9001\u9876\u70b9\u6570\u636e\u7684\u4ee3\u7801\uff1a",(0,r.kt)("br",{parentName:"p"}),"\n","Render"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-ts"},"let _sendAttributeData = (state: state, shaderIndex: shaderIndex, gl: WebGLRenderingContext, program: WebGLProgram) => {\n    if(GLSL\u4e2d\u5b9a\u4e49\u4e86a_position)\n        \u83b7\u5f97\u5e76\u53d1\u9001Position\u7684VBO\n    }\n    if(GLSL\u4e2d\u5b9a\u4e49\u4e86a_texCoord)\n        \u83b7\u5f97\u5e76\u53d1\u9001TexCoord\u7684VBO\n    }\n\n    if (state.isSupportInstance) {\n        \u83b7\u5f97\u5e76\u53d1\u9001instance\u76f8\u5173\u7684VBO\n    }\n\n    if (\u6709ElementArrayBuffer) {\n         \u7ed1\u5b9aElementArrayBuffer\n    }\n}\n")),(0,r.kt)("p",null,"_sendAttributeData\u51fd\u6570\u5224\u65ad\u4e86GLSL\u5bf9\u9876\u70b9\u6570\u636e\u7684\u5b9a\u4e49\u60c5\u51b5\u548c\u5f15\u64ce\u5bf9Instance\u7684\u652f\u6301\u60c5\u51b5\uff0c\u83b7\u5f97\u5e76\u53d1\u9001\u4e86\u5bf9\u5e94\u7684VBO\u6570\u636e"),(0,r.kt)("p",null,"\u6211\u4eec\u770b\u4e0b\u53d1\u9001Uniform\u6570\u636e\u7684\u4ee3\u7801\uff1a",(0,r.kt)("br",{parentName:"p"}),"\n","Render"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-ts"},"let _sendUniformData = (state: state, transform, [material, materialType_], gl: WebGLRenderingContext, program: WebGLProgram) => {\n    \u83b7\u5f97\u5e76\u53d1\u9001\u76f8\u673a\u6570\u636e\n\n    switch (materialType_) {\n        case materialType.Basic:\n            \u83b7\u5f97\u5e76\u53d1\u9001\u57fa\u7840\u6750\u8d28\u7684color\u6570\u636e\n\n            if (hasBasicMap(state.basicMaterialState, material)) {\n                \u83b7\u5f97\u5e76\u53d1\u9001\u57fa\u7840\u6750\u8d28\u7684\u666e\u901a\u8d34\u56fe\u6570\u636e\n            }\n            break\n        case materialType.PBR:\n            \u83b7\u5f97\u5e76\u53d1\u9001PBR\u6750\u8d28\u7684diffuse\u6570\u636e\n\n            if (hasDiffuseMap(state.pbrMaterialState, material)) {\n                \u83b7\u5f97\u5e76\u53d1\u9001PBR\u6750\u8d28\u7684diffuse\u8d34\u56fe\u6570\u636e\n            }\n            break\n        default:\n            throw new Error()\n    }\n\n    if (!state.isSupportInstance) {\n        \u83b7\u5f97\u5e76\u53d1\u9001\u6a21\u578b\u77e9\u9635\n    }\n}\n")),(0,r.kt)("p",null,"_sendUniformData\u51fd\u6570\u9996\u5148\u83b7\u5f97\u5e76\u53d1\u9001\u4e86\u76f8\u673a\u6570\u636e\uff1b\u7136\u540e\u5728\u5224\u65ad\u6750\u8d28\u7684\u79cd\u7c7b\u540e\uff0c\u6839\u636e\u6750\u8d28\u5bf9\u529f\u80fd\u7684\u652f\u6301\u60c5\u51b5\uff0c\u83b7\u5f97\u5e76\u53d1\u9001\u4e86\u8be5\u7c7b\u6750\u8d28\u7684\u6570\u636e\uff1b\u6700\u540e\u5224\u65ad\u5bf9Instance\u7684\u652f\u6301\u60c5\u51b5\uff0c\u5982\u679c\u4e0d\u652f\u6301\u7684\u8bdd\u5219\u83b7\u5f97\u5e76\u53d1\u9001\u6a21\u578b\u77e9\u9635"),(0,r.kt)("h4",{id:"\u8fd0\u884cclient\u7684\u4ee3\u7801"},"\u8fd0\u884cClient\u7684\u4ee3\u7801"),(0,r.kt)("p",null,"\u4e0b\u9762\uff0c\u6211\u4eec\u8fd0\u884cClient\u7684\u4ee3\u7801\uff0c\u6d4f\u89c8\u5668\u63a7\u5236\u53f0\u6253\u5370\u7684\u7ed3\u679c\u5982\u4e0b\uff1a"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-js"},"//\u521d\u59cb\u5316Shader\uff0c\u6253\u5370shaderIndex\nshaderIndex: 0\nshaderIndex: 0\nshaderIndex: 1\n//\u5f00\u59cb\u6e32\u67d3\u7b2c\u4e00\u4e2agameObject\nuseProgram\n//\u53d1\u9001Position\u7684VBO\nbindBuffer\nvertexAttribPointer\nenableVertexAttribArray\n//\u53d1\u9001TexCoord\u7684VBO\nbindBuffer\nvertexAttribPointer\nenableVertexAttribArray\n//\u53d1\u9001instance\u76f8\u5173\u7684VBO\n\u53d1\u9001instance\u76f8\u5173\u7684\u9876\u70b9\u6570\u636e1...\n\u53d1\u9001instance\u76f8\u5173\u7684\u9876\u70b9\u6570\u636e2...\n\u53d1\u9001instance\u76f8\u5173\u7684\u9876\u70b9\u6570\u636e3...\n\u53d1\u9001instance\u76f8\u5173\u7684\u9876\u70b9\u6570\u636e4...\n//\u7ed1\u5b9aElementArrayBuffer\nbindBuffer\n//\u53d1\u9001\u76f8\u673a\u6570\u636e\nuniformMatrix4fv\nuniformMatrix4fv\n//\u53d1\u9001\u57fa\u7840\u6750\u8d28\u7684color\nuniform3f\n//\u53d1\u9001\u57fa\u7840\u6750\u8d28\u7684\u666e\u901a\u8d34\u56fe\u6570\u636e\nuniform1i\n\u5176\u5b83\u6e32\u67d3\u903b\u8f91...\n//\u5f00\u59cb\u6e32\u67d3\u7b2c\u4e8c\u4e2agameObject\n...\n//\u53d1\u9001PBR\u6750\u8d28\u7684diffuse\nuniform3f\n//\u53d1\u9001PBR\u6750\u8d28\u7684diffuse\u8d34\u56fe\u6570\u636e\nuniform1i\n\u5176\u5b83\u6e32\u67d3\u903b\u8f91...\n//\u5f00\u59cb\u6e32\u67d3\u7b2c\u4e09\u4e2agameObject\uff0c\u6253\u5370\u7684\u7ed3\u679c\u8ddf\u201c\u6e32\u67d3\u7b2c\u4e00\u4e2agameObject\u201d\u6253\u5370\u7684\u8f93\u51fa\u4e00\u6837\n...\n")),(0,r.kt)("p",null,"\u8fd9\u91cc\u9996\u5148\u521d\u59cb\u5316Shader\uff0c\u6253\u5370\u751f\u6210\u7684shaderIndex\u3002\u5177\u4f53\u7684\u6253\u5370\u60c5\u51b5\u5982\u4e0b\uff1a",(0,r.kt)("br",{parentName:"p"}),"\n","1.\u9996\u5148\u6253\u5370\u4e86\u751f\u6210\u7684\u6240\u6709\u57fa\u7840\u6750\u8d28\uff08basicMaterial1\u3001basicMaterial2\uff09\u7684shaderIndex\uff0c\u5b83\u4eec\u90fd\u662f0\uff0c\u8bf4\u660e\u8fd9\u4e24\u4e2a\u6750\u8d28\u6b63\u786e\u5730\u5171\u4eab\u4e86\u540c\u4e00\u4e2aShader\uff08\u56e0\u4e3a\u5b83\u4eec\u90fd\u662f\u57fa\u7840\u6750\u8d28\u7684","[\u6709\u666e\u901a\u8d34\u56fe\uff0c\u652f\u6301Instance]","\u7684\u60c5\u51b5\uff09",(0,r.kt)("br",{parentName:"p"}),"\n","2.\u7136\u540e\u6253\u5370\u4e86\u751f\u6210\u7684\u6240\u6709PBR\u6750\u8d28\uff08pbrMaterial1\uff09\u7684shaderIndex\uff0c\u5b83\u662f1\uff0c\u8bf4\u660e\u8fd9\u4e2aPBR\u6750\u8d28\u4e0e\u53e6\u5916\u4e24\u4e2a\u57fa\u7840\u6750\u8d28\u7684Shader\u4e0d\u4e00\u6837\uff08\u56e0\u4e3a\u5b83\u662fPBR\u6750\u8d28\u7684","[\u6ca1\u6709diffuse\u8d34\u56fe\uff0c\u652f\u6301Instance]","\u7684\u60c5\u51b5\uff09"),(0,r.kt)("p",null,"\u7136\u540e\u6e32\u67d3\u6240\u6709\u7684gameObject\uff0c\u56e0\u4e3a\u5171\u67093\u4e2agameObject\uff0c\u6240\u4ee5\u6e32\u67d3\u4e863\u6b21\u3002\u5177\u4f53\u7684\u6e32\u67d3\u60c5\u51b5\u5982\u4e0b\uff1a",(0,r.kt)("br",{parentName:"p"}),"\n","1.\u7b2c\u4e00\u6b21\u6e32\u67d3\u7684\u662fgameObject1\uff0c\u5b83\u6302\u8f7d\u4e86basicMaterial1\u7ec4\u4ef6\uff0c\u8fd9\u6b21\u6e32\u67d3\u5206\u522b\u8fdb\u884c\u4e86\u4e0b\u9762\u7684\u64cd\u4f5c\uff1a\u9996\u5148use program\uff1b\u7136\u540e\u53d1\u9001\u4e86a_position\u3001a_texCoord\u7684VBO\uff1b\u7136\u540e\u53d1\u9001\u4e86instance\u76f8\u5173\u7684VBO\uff1b\u7136\u540e\u7ed1\u5b9a\u4e86Element Array Buffer;\u7136\u540e\u53d1\u9001\u4e86\u4e00\u6b21\u76f8\u673a\u7684\u89c6\u56fe\u77e9\u9635u_vMatrix\u548c\u900f\u89c6\u77e9\u9635u_pMatrix\u6570\u636e\uff1b\u7136\u540e\u53d1\u9001\u4e86\u4e00\u6b21basicMaterial1\u7684color\u6570\u636e\uff1b\u7136\u540e\u53d1\u9001\u4e86\u4e00\u6b21basicMaterial1\u7684\u666e\u901a\u8d34\u56fe\u6570\u636e\uff1b\u6700\u540e\u6267\u884c\u5176\u5b83\u6e32\u67d3\u903b\u8f91",(0,r.kt)("br",{parentName:"p"}),"\n","2.\u7b2c\u4e8c\u6b21\u6e32\u67d3\u7684\u662fgameObject2\uff0c\u5b83\u6302\u8f7d\u4e86pbrMaterial1\u7ec4\u4ef6\uff0c\u8fd9\u6b21\u6e32\u67d3\u4e0e\u7b2c\u4e00\u6b21\u6e32\u67d3\u4e0d\u540c\u7684\u5730\u65b9\u662f\u53d1\u9001\u7684\u6750\u8d28\u6570\u636e\u4e0d\u540c",(0,r.kt)("br",{parentName:"p"}),"\n","3.\u7b2c\u4e09\u6b21\u6e32\u67d3\u7684\u662fgameObject3\uff0c\u5b83\u6302\u8f7d\u4e86basicMaterial3\u7ec4\u4ef6\uff0c\u8fd9\u6b21\u6e32\u67d3\u6253\u5370\u7684\u7ed3\u679c\u4e0e\u7b2c\u4e00\u6b21\u6e32\u67d3\u6253\u5370\u7684\u7ed3\u679c\u4e00\u6837"),(0,r.kt)("h3",{id:"\u63d0\u51fa\u95ee\u9898"},"\u63d0\u51fa\u95ee\u9898"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"GLSL\u5728\u5f15\u64ce\u7aef\u5199\u6b7b\u4e86\uff0c\u7528\u6237\u4e0d\u80fd\u81ea\u5b9a\u4e49GLSL")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"\u5728\u6bcf\u6b21\u6e32\u67d3\u7684\u53d1\u9001\u9876\u70b9\u6570\u636e\u548cUniform\u6570\u636e\u65f6\uff0c\u8981\u8fdb\u884c\u5206\u652f\u5224\u65ad\uff0c\u8fd9\u6837\u5373\u589e\u52a0\u4e86\u4ee3\u7801\u7684\u7ef4\u62a4\u6210\u672c\uff08GLSL\u6bcf\u589e\u52a0\u4e00\u4e2a#ifdef\u5206\u652f\uff0c\u6e32\u67d3\u65f6\u4e5f\u8981\u5bf9\u5e94\u589e\u52a0\u8be5\u5206\u652f\u7684\u5224\u65ad\uff09\uff0c\u4e5f\u964d\u4f4e\u4e86\u6027\u80fd\uff08\u56e0\u4e3a\u6709\u5404\u79cd\u5206\u652f\u8df3\u8f6c\uff0c\u6240\u4ee5\u964d\u4f4e\u4e86CPU\u7684\u7f13\u5b58\u547d\u4e2d\uff09"))),(0,r.kt)("h2",{id:"\u4f7f\u7528\u62fc\u63a5\u6a21\u5f0f\u6765\u6539\u8fdb"},"\u4f7f\u7528\u62fc\u63a5\u6a21\u5f0f\u6765\u6539\u8fdb"),(0,r.kt)("h3",{id:"\u6982\u8ff0\u89e3\u51b3\u65b9\u6848"},"\u6982\u8ff0\u89e3\u51b3\u65b9\u6848"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"\u5c06\u652f\u6301\u5404\u79cd\u529f\u80fd\u7684\u9ed8\u8ba4GLSL\u5206\u89e3\u4e3a\u591a\u4e2a\u5c0f\u5757"),(0,r.kt)("li",{parentName:"ul"},"\u7528\u6237\u7ed9\u51faGLSL\u7684JSON\u914d\u7f6e\u6587\u4ef6\uff0c\u6307\u5b9a\u5982\u4f55\u62fc\u63a5\u5c0f\u5757\u7684GLSL\uff0c\u4ee5\u53ca\u6307\u5b9a\u5728\u6e32\u67d3\u65f6\u9700\u8981\u53d1\u9001\u7684\u9876\u70b9\u6570\u636e\u548cUniform\u6570\u636e\u7684\u914d\u7f6e\u6570\u636e")),(0,r.kt)("h3",{id:"\u7ed9\u51fauml-1"},"\u7ed9\u51faUML"),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"\u9886\u57df\u6a21\u578b")),(0,r.kt)("p",null,(0,r.kt)("img",{alt:"\u9886\u57df\u6a21\u578b\u56fe",src:a(5103).Z})),(0,r.kt)("p",null,"\u603b\u4f53\u6765\u770b\uff0c\u9886\u57df\u6a21\u578b\u5206\u4e3a\u7528\u6237\u3001\u6570\u636e\u3001ChunkConverter\u3001ChunkHandler\u3001\u5f15\u64ce\u8fd9\u4e94\u4e2a\u90e8\u5206"),(0,r.kt)("p",null,"\u6211\u4eec\u770b\u4e0b\u7528\u6237\u8fd9\u4e2a\u90e8\u5206\uff1a"),(0,r.kt)("p",null,"Client\u662f\u7528\u6237"),(0,r.kt)("p",null,"\u6211\u4eec\u770b\u4e0b\u6570\u636e\u548cChunkConverter\u8fd9\u4e24\u4e2a\u90e8\u5206\uff1a"),(0,r.kt)("p",null,"Target GLSL\u662f\u652f\u6301\u67d0\u4e9b\u529f\u80fd\u7684\u4e00\u5957GLSL\uff0c\u76f8\u5f53\u4e8e\u4e4b\u524d\u7684BasicMaterialShaderGLSL\uff08Add Define\uff09\u6216\u8005PBRMaterialShaderGLSL\uff08Add Define\uff09\uff0c\u4e24\u8005\u7684\u533a\u522b\u662f\u56e0\u4e3aTarget GLSL\u6ca1\u6709\u9884\u5b9a\u4e49\u7684\u5b8f\uff0c\u6240\u4ee5\u5b83\u6ca1\u6709\u5206\u652f\uff0c\u53ea\u6709\u652f\u6301\u7684\u529f\u80fd\u7684GLSL\u3002\u4e00\u4e2aTarget GLSL\u5305\u62ec\u4e86\u4e00\u4e2aVS GLSL\u548c\u4e00\u4e2aFS GLSL\u3002\u8fd9\u91cc\u6700\u591a\u6709\u516b\u4e2aTarget GLSL\uff0c\u5bf9\u5e94\u4e86\u57fa\u7840\u6750\u8d28\u7684Shader\u7684\u56db\u79cd\u60c5\u51b5\u548cPBR\u6750\u8d28\u7684Shader\u7684\u56db\u79cd\u60c5\u51b5"),(0,r.kt)("p",null,"Send Metadata\u662f\u83b7\u5f97\u548c\u53d1\u9001\u9876\u70b9\u6570\u636e\u548cUniform\u6570\u636e\u7684\u5143\u6570\u636e\u3002\u5177\u4f53\u6765\u8bf4\uff0c\u6bcf\u4e2aSend Metadata\u5305\u62ec\u4e86\u591a\u4e2agetData\u51fd\u6570\u548c\u591a\u4e2asendData\u51fd\u6570\uff0c\u524d\u8005\u83b7\u5f97\u5bf9\u5e94\u7684\u9876\u70b9\u6570\u636e\u6216\u8005Uniform\u6570\u636e\uff0c\u540e\u8005\u53d1\u9001\u5b83\u4eec\u3002\u56e0\u4e3a\u4e00\u4e2aSend Metadata\u5bf9\u5e94\u4e00\u4e2aTarget GLSL\uff0c\u6240\u4ee5\u6700\u591a\u67098\u4e2aSend Metadata"),(0,r.kt)("p",null,"GLSL Config\u662fGLSL\u7684JSON\u914d\u7f6e\u6587\u4ef6\uff0c\u7528\u6765\u6307\u5b9a\u5982\u4f55\u62fc\u63a5Target GLSL\uff0c\u5e76\u5305\u62ec\u4e86Send Metadata\u7684\u914d\u7f6e\u6570\u636e\u3002GLSL Config\u7684\u5185\u5bb9\u7531\u7528\u6237\u7ed9\u51fa\uff0c\u683c\u5f0f\uff08\u4e5f\u5c31\u662f\u7c7b\u578b\uff09\u7531ChunkHandler\u5b9a\u4e49"),(0,r.kt)("p",null,"GLSL Chunk\u662f\u4e00\u5c0f\u5757\u7684GLSL\uff0c\u6709\u591a\u4e2aGLSL Chunk\uff0c\u5b83\u4eec\u7531\u5f15\u64ce\u7ed9\u51fa\u3002\u4e00\u4e2aGLSL Chunk\u53ef\u4ee5\u662fVS GLSL\u4e2d\u4e00\u5c0f\u5757GLSL\u6587\u4ef6\uff0c\u4e5f\u53ef\u4ee5\u662fFS GLSL\u4e2d\u4e00\u5c0f\u5757GLSL\u6587\u4ef6"),(0,r.kt)("p",null,"ChunkConverter\u8d1f\u8d23\u8f6c\u6362GLSL Chunk\u3002\u56e0\u4e3aGLSL Chunk\u662f\u81ea\u5b9a\u4e49\u6587\u4ef6\uff0c\u6709\u4e00\u4e9b\u81ea\u5b9a\u4e49\u7684\u8bed\u6cd5\uff0c\u4e0d\u80fd\u76f4\u63a5\u4f7f\u7528\uff0c\u6240\u4ee5\u5f15\u64ce\u9700\u8981\u8c03\u7528gulp\u4efb\u52a1\u6765\u5bf9\u5176\u9884\u5904\u7406\u3002gulp\u4efb\u52a1\u8c03\u7528\u4e86ChunkConverter\u6765\u5904\u7406\u6240\u6709\u7684GLSL Chunk\uff0c\u5e76\u5c06\u5176\u5408\u5e76\u4e3a\u4e00\u4e2aMerged GLSL Chunk\uff0c\u6210\u4e3a\u4e00\u4e2aTypescript\u6216\u8005Rescript\u6587\u4ef6"),(0,r.kt)("p",null,"\u6211\u4eec\u770b\u4e0bChunkHandler\u548c\u5f15\u64ce\u8fd9\u4e24\u4e2a\u90e8\u5206\uff1a"),(0,r.kt)("p",null,"ChunkHandler\u8d1f\u8d23\u62fc\u63a5Target GLSL\u548c\u6784\u9020Send Metadata"),(0,r.kt)("p",null,"Engine\u3001Render\u8ddf\u4e4b\u524d\u4e00\u6837\uff0c\u4e0d\u4e00\u6837\u7684\u5730\u65b9\u662fRender\u73b0\u5728\u4f1a\u4f7f\u7528Send Metadata\u6765\u83b7\u5f97\u5e76\u53d1\u9001\u9876\u70b9\u6570\u636e\u548cUniform\u6570\u636e"),(0,r.kt)("p",null,"InitMaterialShader\u8d1f\u8d23\u521d\u59cb\u5316\u6240\u6709\u6750\u8d28\u7684Shader\uff0c\u5b83\u6709\u4e24\u4e2a\u51fd\u6570\uff1ainitBasicMaterialShader\u3001initPBRMaterialShader\uff0c\u5206\u522b\u8d1f\u8d23\u521d\u59cb\u5316\u6240\u6709\u57fa\u7840\u6750\u8d28\u7684Shader\u548c\u521d\u59cb\u5316\u6240\u6709PBR\u6750\u8d28\u7684Shader\u3002\u8fd9\u4e24\u4e2a\u51fd\u6570\u904d\u5386\u4e86\u6240\u6709\u7684\u57fa\u7840\u6750\u8d28\u6216\u8005PBR\u6750\u8d28\uff0c\u5728\u6bcf\u6b21\u904d\u5386\u4e2d\u7684\u6b65\u9aa4\u4e00\u6837\uff0c\u5177\u4f53\u6b65\u9aa4\u5982\u4e0b\uff1a",(0,r.kt)("br",{parentName:"p"}),"\n","1.\u901a\u8fc7\u8c03\u7528ChunkHandler\u7684buildGLSL\u51fd\u6570\uff0c\u6309\u7167GLSL Config\u5c06Merged GLSL Chunk\u4e2d\u5bf9\u5e94\u7684GLSL Chunk\u62fc\u63a5\u4e3a\u4e00\u4e2aTarget GLSL\uff0c\u7136\u540e\u4f7f\u7528\u5b83\u6765\u521b\u5efa\u6750\u8d28\u5bf9\u5e94\u7684shaderIndex\u548cprogram",(0,r.kt)("br",{parentName:"p"}),"\n","2.\u901a\u8fc7\u8c03\u7528ChunkHandler\u7684buildSendMetadata\u51fd\u6570\uff0c\u6309\u7167GLSL Config\u6784\u9020Send Metadata"),(0,r.kt)("h3",{id:"\u7ed3\u5408uml\u56fe\u63cf\u8ff0\u5982\u4f55\u5177\u4f53\u5730\u89e3\u51b3\u95ee\u9898"},"\u7ed3\u5408UML\u56fe\uff0c\u63cf\u8ff0\u5982\u4f55\u5177\u4f53\u5730\u89e3\u51b3\u95ee\u9898"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"\u73b0\u5728\u7528\u6237\u53ef\u4ee5\u901a\u8fc7GLSL Config\u6765\u81ea\u5b9a\u4e49GLSL")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"\u5728\u6bcf\u6b21\u6e32\u67d3\u7684\u53d1\u9001\u9876\u70b9\u6570\u636e\u548cUniform\u6570\u636e\u65f6\uff0c\u73b0\u5728\u4e0d\u9700\u8981\u8fdb\u884c\u5206\u652f\u5224\u65ad\uff0c\u800c\u662f\u76f4\u63a5\u904d\u5386Send Metadata\uff0c\u901a\u8fc7\u5b83\u7684getData\u3001sendData\u51fd\u6570\u6765\u83b7\u5f97\u548c\u53d1\u9001\u6570\u636e"))),(0,r.kt)("h3",{id:"\u7ed9\u51fa\u4ee3\u7801-1"},"\u7ed9\u51fa\u4ee3\u7801"),(0,r.kt)("p",null,"\u9996\u5148\uff0c\u6211\u4eec\u770b\u4e0bGLSL Config\u7684\u4ee3\u7801",(0,r.kt)("br",{parentName:"p"}),"\n","\u7136\u540e\uff0c\u6211\u4eec\u770b\u4e0bClient\u7684\u4ee3\u7801",(0,r.kt)("br",{parentName:"p"}),"\n","\u7136\u540e\uff0c\u6211\u4eec\u770b\u4e0bClient\u4ee3\u7801\u4e2d\u7b2c\u4e8c\u4e2a\u6b65\u9aa4\u7684\u4ee3\u7801\uff1a\u521b\u5efaEngineState\u7684\u4ee3\u7801",(0,r.kt)("br",{parentName:"p"}),"\n","\u7136\u540e\uff0c\u56e0\u4e3aEngineState\u4fdd\u5b58\u4e86Merged GLSL Chunk\uff0c\u800c\u5b83\u662f\u5408\u5e76GLSL Chunk\u800c\u6765\uff0c\u6240\u4ee5\u6211\u4eec\u5148\u770b\u4e0bGLSL Chunk\u7684\u8bf4\u660e\uff0c\u518d\u770b\u4e0bMerged GLSL Chunk\u7684\u4ee3\u7801",(0,r.kt)("br",{parentName:"p"}),"\n","\u7136\u540e\uff0c\u6211\u4eec\u770b\u4e0bClient\u4ee3\u7801\u4e2d\u5269\u4f59\u6b65\u9aa4\u7684\u4ee3\u7801\uff0c\u5b83\u4eec\u5305\u62ec\uff1a"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"\u521d\u59cb\u5316\u6240\u6709\u57fa\u7840\u6750\u8d28\u7684Shader\u7684\u4ee3\u7801"),(0,r.kt)("li",{parentName:"ul"},"\u521d\u59cb\u5316\u6240\u6709PBR\u6750\u8d28\u7684Shader\u7684\u4ee3\u7801"),(0,r.kt)("li",{parentName:"ul"},"\u6e32\u67d3\u573a\u666f\u7684\u4ee3\u7801")),(0,r.kt)("p",null,"\u6700\u540e\uff0c\u6211\u4eec\u8fd0\u884cClient\u7684\u4ee3\u7801"),(0,r.kt)("h4",{id:"glsl-config\u7684\u4ee3\u7801"},"GLSL Config\u7684\u4ee3\u7801"),(0,r.kt)("p",null,"GLSL Config\u5305\u62ec\u4e24\u4e2aJSON\u6587\u4ef6\uff1ashaders.json\u548cshader_chunks.json\uff0c\u5b83\u4eec\u7684\u683c\u5f0f\u5b9a\u4e49\u5728ChunkHandler\u7684GLSLConfigType\u4e2d\uff0c\u5b83\u4eec\u7684\u5185\u5bb9\u7531\u7528\u6237\u7ed9\u51fa\u3002\u5176\u4e2dshaders.json\u6587\u4ef6\u5b9a\u4e49\u4e86\u6240\u6709\u79cd\u7c7b\u7684Shader\u7684GLSL\u914d\u7f6e\u6570\u636e\uff0cshader_chunks.json\u6587\u4ef6\u662f\u5b9a\u4e49\u4e86\u6240\u6709\u7684GLSL Chunk\u7684\u914d\u7f6e\u6570\u636e"),(0,r.kt)("p",null,"\u56e0\u4e3a\u4e00\u79cdShader\u5bf9\u5e94\u4e00\u79cd\u6750\u8d28\uff0c\u76ee\u524d\u53ea\u6709\u4e24\u79cd\u6750\u8d28\uff0c\u6240\u4ee5\u5171\u6709\u4e24\u79cdShader\uff0c\u56e0\u6b64shaders.json\u6587\u4ef6\u5b9a\u4e49\u4e86\u4e24\u79cdShader\u7684GLSL\u914d\u7f6e\u6570\u636e"),(0,r.kt)("p",null,"shader_chunks.json\u662f\u4e00\u4e2a\u6570\u7ec4\uff0c\u5176\u4e2d\u7684\u6bcf\u4e2a\u5143\u7d20\u5b9a\u4e49\u4e86\u4e00\u5957GLSL Chunk\u7684\u914d\u7f6e\u6570\u636e\uff0c\u5b83\u6700\u591a\u5173\u8054\u4e24\u4e2aGLSL Chunk\uff08\u5206\u522b\u5c5e\u4e8eVS GLSL\u3001FS GLSL\uff09\uff0c\u5e76\u5305\u62ec\u4e86\u5176\u4e2d\u7684\u9876\u70b9\u3001Uniform\u7684Send Metadata\u7684\u914d\u7f6e\u6570\u636e"),(0,r.kt)("p",null,"\u8fd9\u4e24\u4e2a\u6587\u4ef6\u7684\u5173\u7cfb\u662f\u201c\u603b-\u5206\u201d\u7684\u5173\u7cfb\u3002\u5177\u4f53\u6765\u8bf4\uff0c\u56e0\u4e3a\u6bcf\u79cdShader\u7684GLSL\u7531\u591a\u4e2aGLSL Chunk\u7ec4\u5408\u62fc\u63a5\u800c\u6210\uff0c\u6240\u4ee5shaders.json\u662f\u201c\u603b\u201d\uff0cshader_chunks.json\u662f\u201c\u5206\u201d\u3002\u4e0b\u9762\u6211\u4eec\u6765\u770b\u4e0b\u8fd9\u4e24\u4e2a\u6587\u4ef6\u7684\u4e3b\u8981\u4ee3\u7801\uff1a",(0,r.kt)("br",{parentName:"p"}),"\n","shaders.json\u7684\u4e3b\u8981\u4ee3\u7801\u5982\u4e0b\uff1a  "),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-ts"},'{\n  "static_branchs": [\n    {\n      "name": "modelMatrix_instance",\n      "value": [\n        "modelMatrix_noInstance",\n        "modelMatrix_instance"\n      ]\n    }\n  ],\n  "dynamic_branchs": [\n    {\n      "name": "basic_map",\n      "condition": "basic_has_map",\n      "pass": "basic_map",\n      "fail": "no_basic_map"\n    },\n    {\n      "name": "diffuse_map",\n      "condition": "diffuse_has_map",\n      "pass": "diffuse_map",\n      "fail": "no_diffuse_map"\n    }\n  ],\n  "groups": [\n    {\n      "name": "top",\n      "value": [\n        "common",\n        ...\n      ]\n    },\n    ...\n  ],\n  "shaders": [\n    {\n      "name": "render_basic",\n      "shader_chunks": [\n        {\n          "type": "group",\n          "name": "top"\n        },\n        ...\n        {\n          "type": "dynamic_branch",\n          "name": "basic_map"\n        },\n        {\n          "type": "static_branch",\n          "name": "modelMatrix_instance"\n        },\n        {\n          "name": "basic_end"\n        },\n        ...\n      ]\n    },\n    {\n      "name": "render_pbr",\n      "shader_chunks": [\n        {\n          "type": "group",\n          "name": "top"\n        },\n        ...\n        {\n          "type": "dynamic_branch",\n          "name": "diffuse_map"\n        },\n        {\n          "type": "static_branch",\n          "name": "modelMatrix_instance"\n        },\n        ...\n      ]\n    }\n  ]\n}\n')),(0,r.kt)("p",null,"\u4e0b\u9762\u4ecb\u7ecd\u5404\u4e2a\u4e00\u7ea7\u5b57\u6bb5\uff1a"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"static_branchs\u5b57\u6bb5\u5b9a\u4e49\u4e86\u6240\u6709\u5728\u8fd0\u884c\u65f6\u4e0d\u4f1a\u53d8\u5316\u7684\u5206\u652f\u5224\u65ad\u7684\u914d\u7f6e\u6570\u636e\u3002\u6bd4\u5982\u201c\u662f\u5426\u652f\u6301Instance\u201d\u5c31\u5c5e\u4e8e\u8fd9\u7c7b\u5224\u65ad\uff0c\u56e0\u4e3a\u5b83\u8ddf\u5f15\u64ce\u662f\u5426\u652f\u6301Instance\u6709\u5173\uff0c\u4e0d\u4f1a\u5728\u8fd0\u884c\u65f6\u53d8\u5316\u3002static_branchs\u5b57\u6bb5\u4e2d\u7684value\u5b57\u6bb5\u5305\u62ec\u4e86\u5404\u4e2a\u5206\u652f\u5bf9\u5e94\u7684GLSL Chunk\uff0c\u5b83\u4eec\u8ddfshader_chunks.json\u7684\u6570\u7ec4\u5143\u7d20\u7684name\u5173\u8054")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"dynamic_branchs\u5b57\u6bb5\u5b9a\u4e49\u4e86\u6240\u6709\u5728\u8fd0\u884c\u65f6\u4f1a\u53d8\u5316\u7684\u5206\u652f\u5224\u65ad\u7684\u914d\u7f6e\u6570\u636e\u3002\u6bd4\u5982\u57fa\u7840\u6750\u8d28\u548cPBR\u6750\u8d28\u7684\u201c\u662f\u5426\u6709\u8d34\u56fe\u201d\u5c31\u5c5e\u4e8e\u8fd9\u7c7b\u5224\u65ad\uff0c\u56e0\u4e3a\u53ef\u80fd\u5728\u8fd0\u884c\u65f6\u8bbe\u7f6e\u6216\u8005\u79fb\u9664\u6750\u8d28\u7684\u8d34\u56fe\u3002dynamic_branchs\u5b57\u6bb5\u4e2d\u7684condition\u3001pass\u3001fail\u5b57\u6bb5\u7684\u503c\u5206\u522b\u4e3a\u6761\u4ef6\u5224\u65ad\u3001\u6210\u529f\u3001\u5931\u8d25\u5bf9\u5e94\u7684GLSL Chunk\uff0c\u5b83\u4eec\u8ddfshader_chunks.json\u7684\u6570\u7ec4\u5143\u7d20\u7684name\u5173\u8054")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"groups\u5b57\u6bb5\u5b9a\u4e49\u4e86\u591a\u7ec4GLSL Chunk\uff0c\u6bcf\u7ec4\u7684value\u5b57\u6bb5\u5305\u62ec\u4e86\u591a\u4e2aGLSL Chunk\uff0c\u5b83\u4eec\u8ddfshader_chunks.json\u7684\u6570\u7ec4\u5143\u7d20\u7684name\u5173\u8054")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"shaders\u5b57\u6bb5\u662f\u4e00\u4e2a\u6570\u7ec4\uff0c\u5b9a\u4e49\u4e86\u6240\u6709\u79cd\u7c7b\u7684Shader\u7684GLSL\u914d\u7f6e\u6570\u636e\uff0c\u5177\u4f53\u5305\u62ecname\u4e3arender_basic\u7684\u57fa\u7840\u6750\u8d28\u7684Shader\u548cname\u4e3arender_pbr\u7684PBR\u6750\u8d28\u7684Shader\u7684GLSL\u914d\u7f6e\u6570\u636e\u3002\u6bcf\u79cdShader\u7684GLSL\u7531\u591a\u4e2aGLSL Chunk\u7ec4\u5408\u62fc\u63a5\u800c\u6210\uff0c\u5b83\u4eec\u5b9a\u4e49\u5728shaders\u5b57\u6bb5\u7684\u6570\u7ec4\u5143\u7d20\u7684shader_chunks\u5b57\u6bb5\u4e2d",(0,r.kt)("br",{parentName:"p"}),"\n","\u503c\u5f97\u8bf4\u660e\u7684\u662f\uff1a",(0,r.kt)("br",{parentName:"p"}),"\n","\u5b9e\u9645\u4e0a\u4e5f\u5b58\u5728\u6ca1\u6709\u6750\u8d28\u7684Shader\uff0c\u5982\u540e\u5904\u7406\uff08\u5982\u7ed8\u5236\u8f6e\u5ed3\uff09\u7684Shader\u3001\u5929\u7a7a\u76d2\u7684Shader\u7b49\uff0c\u8fd9\u4e9b\u79cd\u7c7b\u7684Shader\u4e5f\u5b9a\u4e49\u5728shaders\u5b57\u6bb5\uff0c\u53ea\u662f\u6ca1\u6709\u5bf9\u5e94\u6750\u8d28\u800c\u5df2\u3002\u8fd9\u79cdShader\u6211\u4eec\u4f1a\u5728\u540e\u9762\u7684\u6269\u5c55\u4e2d\u8ba8\u8bba  "),(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},"\u5728shader_chunks\u5b57\u6bb5\u4e2d\uff0c\u5982\u679ctype\u4e3astatic_branch\uff0c\u90a3\u4e48\u5c31\u901a\u8fc7name\u5173\u8054\u5230static_branchs\u5b57\u6bb5\uff1b\u5982\u679ctype\u4e3adynamic_branch\uff0c\u90a3\u4e48\u5c31\u901a\u8fc7name\u5173\u8054\u5230dynamic_branchs\u5b57\u6bb5\uff1b\u5982\u679ctype\u4e3agroup\uff0c\u90a3\u4e48\u5c31\u901a\u8fc7name\u5173\u8054\u5230groups\u5b57\u6bb5\uff1b\u5982\u679c\u6ca1\u6709\u5b9a\u4e49type\uff0c\u90a3\u4e48\u5c31\u901a\u8fc7name\u5173\u8054\u5230shader_chunks.json\u7684\u6570\u7ec4\u5143\u7d20\u7684name")))),(0,r.kt)("p",null,"\u8fd9\u4e9b\u4e00\u7ea7\u5b57\u6bb5\u7684\u5173\u7cfb\u5982\u4e0b\uff1a",(0,r.kt)("br",{parentName:"p"}),"\n","shaders\u5b57\u6bb5\u662f\u4e3b\u5b57\u6bb5\uff0c\u5176\u5b83\u7684\u4e00\u7ea7\u5b57\u6bb5\u90fd\u53ea\u662fshaders\u5b57\u6bb5\u7684\u6570\u7ec4\u5143\u7d20\u7684shader_chunks\u4e2d\u5bf9\u5e94type\u7684\u914d\u7f6e\u6570\u636e\u800c\u5df2"),(0,r.kt)("p",null,"shader_chunks.json\u7684\u4e3b\u8981\u4ee3\u7801\u5982\u4e0b\uff1a"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-ts"},'[\n  {\n    "name": "common",\n    "glsls": [\n      {\n        "type": "vs",\n        "name": "common_vertex"\n      },\n      {\n        "type": "fs",\n        "name": "common_fragment"\n      }\n    ],\n    "variables": {\n      "uniforms": [\n        {\n          "name": "u_vMatrix",\n          "field": "vMatrix",\n          "type": "mat4",\n          "from": "camera"\n        },\n        ...\n      ]\n    }\n  },\n  ...\n  {\n    "name": "modelMatrix_instance",\n    "glsls": [\n      {\n        "type": "vs",\n        "name": "modelMatrix_instance_vertex"\n      }\n    ],\n    "variables": {\n      "attributes": [\n        {\n          "name": "a_mVec4_0",\n          "buffer": 4,\n          "type": "vec4"\n        },\n        ...\n      ]\n    }\n  },\n  ...\n]\n')),(0,r.kt)("p",null,"\u4e0b\u9762\u4ecb\u7ecd\u6570\u7ec4\u5143\u7d20\u4e2d\u5404\u4e2a\u4e00\u7ea7\u5b57\u6bb5\uff1a"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"name\u5b57\u6bb5\u662f\u4e00\u5957GLSL Chunk\u7684\u540d\u79f0\uff0c\u4e0eshaders.json\u5173\u8054"),(0,r.kt)("li",{parentName:"ul"},"glsls\u5b57\u6bb5\u662f\u4e00\u4e2a\u6570\u7ec4\uff0c\u6700\u591a\u6709\u4e24\u4e2a\u6570\u7ec4\u5143\u7d20\uff0c\u5b9a\u4e49\u4e86\u4e00\u5957GLSL Chunk\uff0c\u5176\u4e2d\u5982\u679c\u5b83\u7684\u6570\u7ec4\u5143\u7d20\u7684type\u4e3avs\u6216\u8005fs\uff0c\u5219name\u5206\u522b\u4e3a\u5c5e\u4e8eVS GLSL\u7684GLSL Chunk\u6216\u8005\u5c5e\u4e8eFS GLSL\u7684GLSL Chunk\u7684\u6587\u4ef6\u540d\uff1b"),(0,r.kt)("li",{parentName:"ul"},"variables\u5b57\u6bb5\u5b9a\u4e49\u4e86\u8fd9\u5957GLSL Chunk\u4e2d\u9876\u70b9\u3001Uniform\u6570\u636e\u7684Send Metadata\u7684\u914d\u7f6e\u6570\u636e")),(0,r.kt)("h4",{id:"client\u7684\u4ee3\u7801-1"},"Client\u7684\u4ee3\u7801"),(0,r.kt)("p",null,"Client"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-ts"},"let parsedConfig = Engine.parseConfig(shadersJson, shaderChunksJson)\n")),(0,r.kt)("p",null,"shadersJson\u3001shadersChunkJson\u662f\u52a0\u8f7dshaders.json\u3001shader_chunks.json\u6587\u4ef6\u540e\u5f97\u5230\u7684JSON"),(0,r.kt)("p",null,"Client\u901a\u8fc7Engine\u7684parseConfig\u51fd\u6570\u6765\u8c03\u7528ChunkHandler\u7684parseConfig\u51fd\u6570\uff0c\u5bf9GLSL Config\u8fdb\u884c\u89e3\u6790\u3002\u56e0\u4e3aChunkHandler\u662fRescript\u5199\u7684\uff0c\u6240\u4ee5\u9700\u8981\u5728parseConfig\u51fd\u6570\u4e2d\u5c06JSON\u8f6c\u6362\u4e3aRescript\u7684\u6570\u636e\u683c\u5f0f-Record\u3002\u5982\u679cChunkHandler\u662f\u4f7f\u7528Typescript\u5199\u7684\uff0c\u5219\u4e0d\u9700\u8981ChunkHandler\u4e0d\u9700\u8981parseConfig\u51fd\u6570\uff0cClient\u4e5f\u4e0d\u9700\u8981\u8c03\u7528parseConfig\u51fd\u6570"),(0,r.kt)("p",null,"\u7ee7\u7eed\u770bClient\u540e\u9762\u7684\u4ee3\u7801\uff1a"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-ts"},'let state = Engine.createState(parsedConfig)\n\nlet sceneData = ClientUtils.createScene(state)\nstate = sceneData[0]\nlet [allBasicMaterials, allPBRMaterials, _] = sceneData[1]\n\nstate = Engine.initBasicMaterialShader(state, [allBasicMaterials, "render_basic"])\n\nstate = Engine.initPBRMaterialShader(state, [allPBRMaterials, "render_pbr"])\n\nstate = Engine.initCamera(state)\n\nstate = Engine.render(state)\n')),(0,r.kt)("p",null,"\u8fd9\u91cc\u7684\u6b65\u9aa4\u8ddf\u4e4b\u524d\u4e00\u6837\uff0c\u4e0d\u4e00\u6837\u7684\u5730\u65b9\u662f\uff1a"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},'\u5728\u8c03\u7528initBasicMaterialShader\u3001initPBRMaterialShader\u51fd\u6570\u65f6\uff0c\u5206\u522b\u65b0\u4f20\u5165\u4e86"render_basic"\u3001"render_pbr"\u8fd9\u4e2a\u53c2\u6570\uff0c\u5b83\u7528\u6765\u6307\u5b9a\u4f7f\u7528shaders.json\u7684shaders\u5b57\u6bb5\u4e2d\u5bf9\u5e94\u7684Shader\u79cd\u7c7b\u7684GLSL\u914d\u7f6e\u6570\u636e')),(0,r.kt)("h4",{id:"\u521b\u5efaenginestate\u7684\u4ee3\u7801-1"},"\u521b\u5efaEngineState\u7684\u4ee3\u7801"),(0,r.kt)("p",null,"Engine"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-ts"},"export let createState = ([shaders, shaderChunks]): state => {\n    return {\n        ...\n        shaders,\n        shaderChunks,\n        isSupportInstance: true,\n        ...\n        chunk: MergedGLSLChunk.getData(),\n        ...\n    }\n}\n")),(0,r.kt)("p",null,"createState\u51fd\u6570\u521b\u5efa\u4e86EngineState\u3002\u5728\u521b\u5efa\u7684EngineState\u4e2d\uff0c\u4e3b\u8981\u65b0\u589e\u4e86\u4e0b\u9762\u7684\u5185\u5bb9\uff1a"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"\u4fdd\u5b58\u4e86GLSL Config\uff08shaders\u3001shaderChunks\uff09\uff1b"),(0,r.kt)("li",{parentName:"ul"},"\u8c03\u7528\u4e86Merged GLSL Chunk\u7684getData\u51fd\u6570\u6765\u83b7\u5f97\u5b83\u7684\u6570\u636e\uff0c\u4e5f\u5c31\u662f\u5408\u5e76\u540e\u7684\u6240\u6709\u7684GLSL Chunk\uff0c\u5c06\u5176\u4fdd\u5b58\u5230chunk\u5b57\u6bb5\u4e2d")),(0,r.kt)("h4",{id:"glsl-chunk\u7684\u8bf4\u660e"},"GLSL Chunk\u7684\u8bf4\u660e"),(0,r.kt)("p",null,"\u5f15\u64ce\u5b9a\u4e49\u7684GLSL Chunk\u6587\u4ef6\u5177\u4f53\u662f\u540e\u7f00\u540d\u4e3a.glsl\u7684\u6587\u4ef6\u3002\u6211\u4eec\u901a\u8fc7\u81ea\u5b9a\u4e49\u7684\u5b57\u7b26\uff1a@top\u3001@define\u3001@varDeclare\u3001@funcDeclare\u3001@funcDefine\u3001@body\u4ee5\u53ca\u5bf9\u5e94\u7684@end\uff0c\u5c06\u4e00\u4e2a\u5b8c\u6574\u7684GLSL\u5206\u5272\u4e3a\u4ece\u4e0a\u5f80\u4e0b\u7684\u4e0d\u540c\u533a\u57df\u7684\u4ee3\u7801\u7247\u6bb5\uff0c\u8fd9\u6837\u4fbf\u4e8e\u66f4\u7ec6\u7c92\u5ea6\u7684\u7ec4\u5408\u62fc\u63a5"),(0,r.kt)("p",null,"\u4e00\u4e2aGLSL Chunk\u53ef\u4ee5\u5305\u62ec\u591a\u4e2a\u533a\u57df\u7684\u4ee3\u7801\u7247\u6bb5\u3002\u4e3e\u4f8b\u6765\u8bf4\uff0c\u6211\u4eec\u770b\u4e0bdiffuse\u8d34\u56fe\u76f8\u5173\u7684.glsl\u6587\u4ef6\uff1a",(0,r.kt)("br",{parentName:"p"}),"\n","webgl1_diffuse_map_fragment.glsl"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-ts"},"@varDeclare\nvarying vec2 v_diffuseMapCoord0;\n@end\n\n@body\n    vec4 texelColor = texture2D(u_diffuseMapSampler, v_diffuseMapCoord0);\n\n    vec4 totalColor = vec4(texelColor.rgb * u_color, texelColor.a);\n@end\n")),(0,r.kt)("p",null,"\u8be5GLSL Chunk\u5305\u62ec\u4e86\u4e24\u4e2a\u533a\u57df\uff08@varDeclare\u3001@body\uff09\u7684\u4ee3\u7801\u7247\u6bb5\uff0c\u5176\u4e2d@varDeclare\u5305\u62ec\u4e86\u53d8\u91cf\u58f0\u660e\u7684\u4ee3\u7801\uff0c@body\u5305\u62ec\u4e86main\u51fd\u6570\u4e2d\u7684\u4ee3\u7801"),(0,r.kt)("p",null,"\u5176\u5b83\u533a\u57df\u5305\u62ec\u7684\u4ee3\u7801\u5982\u4e0b\uff1a"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"@top\u5305\u62ec\u4e86define\u4e4b\u524d\u7684\u4ee3\u7801\uff0c\u5982\u7cbe\u5ea6\u4ee3\u7801\uff0c\u5177\u4f53\u5982\u4e0b:")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-glsl"},"@top\nprecision highp float;\n@end\n")),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"@define\u5305\u62ec\u4e86define\u7684\u4ee3\u7801\uff0c\u5177\u4f53\u5982\u4e0b\uff1a")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-glsl"},"@define\ndefine B 2;\n@end\n")),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"@funcDeclare\u5305\u62ec\u4e86\u51fd\u6570\u58f0\u660e\u7684\u4ee3\u7801\uff0c\u5177\u4f53\u5982\u4e0b\uff1a")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-glsl"},"@funcDeclare\nvec3 getDirectionLightDirByLightPos(vec3 lightPos);\n@end\n")),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"@funcDefine\u5305\u62ec\u4e86\u51fd\u6570\u5b9e\u73b0\u7684\u4ee3\u7801\uff0c\u5177\u4f53\u5982\u4e0b\uff1a")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-glsl"},"@funcDefine\nvec3 getDirectionLightDirByLightPos(vec3 lightPos){\n  return lightPos - vec3(0.0);\n}\n@end\n")),(0,r.kt)("p",null,'\u4e00\u4e2aGLSL Chunk\u8fd8\u53ef\u4ee5\u901a\u8fc7"#import \u76f8\u5bf9\u8def\u5f84"\u6765\u5f15\u5165\u5176\u5b83\u7684GLSL Chunk\uff0c\u5982common_vertex.glsl\uff1a'),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-glsl"},'@define\n#import "common_define"\n@end\n\n@funcDefine\n#import "common_function"\n@end\n')),(0,r.kt)("p",null,"\u5b83\u5f15\u5165\u4e86\u5728\u540c\u4e00\u4e2a\u76ee\u5f55\u4e0b\u7684common_define\u7684define\u4ee3\u7801\u7247\u6bb5\u548ccommon_function\u7684funcDefine\u4ee3\u7801\u7247\u6bb5"),(0,r.kt)("p",null,"\u6211\u4eec\u518d\u6765\u770b\u4e0b\u5b9a\u4e49\u4e86\u6240\u6709\u7247\u6bb5\u7684GLSL Chunk\u662f\u4ec0\u4e48\u6837\u7684\uff1a"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-glsl"},"@top\nprecision highp float;\n@end\n\n@define\ndefine B 2;\n@end\n\n@varDeclare\nvarying vec2 v_mapCoord2;\n@end\n\n@funcDeclare\nvec3 func2(vec3 lightPos);\n@end\n\n@funcDefine\nvec3 func2(vec3 lightPos){\n    return vec3(0.5);\n}\n@end\n\n@body\ngl_FragColor = vec4(1.0,0.5,1.0,1.0);\n@end\n")),(0,r.kt)("p",null,"\u5b83\u5176\u5b9e\u662f\u5bf9\u4e0b\u9762\u8fd9\u4e2a\u5b8c\u6574\u7684GLSL\u4ee3\u7801\u7684\u5206\u5272\uff1a"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-glsl"},"precision highp float;\n\ndefine B 2;\n\nvarying vec2 v_mapCoord2;\n\nvec3 func2(vec3 lightPos);\n\nvec3 func2(vec3 lightPos){\n    return vec3(0.5);\n}\n\nvoid main() {\n    gl_FragColor = vec4(1.0,0.5,1.0,1.0);\n}\n")),(0,r.kt)("p",null,"\u6211\u4eec\u6765\u770b\u4e0b\u5982\u4f55\u7ec4\u5408\u591a\u4e2aGLSL Chunk\uff0c\u5176\u5b9e\u5c31\u662f\u5c06\u5b83\u4eec\u5bf9\u5e94\u533a\u57df\u7684\u4ee3\u7801\u53e0\u52a0\u800c\u5df2\uff0c\u6211\u4eec\u770b\u4e0b\u5177\u4f53\u7684\u4f8b\u5b50\uff1a",(0,r.kt)("br",{parentName:"p"}),"\n","\u6709\u4e24\u4e2aGLSL Chunk\uff0c\u5b83\u4eec\u7684\u4ee3\u7801\u5982\u4e0b\uff1a",(0,r.kt)("br",{parentName:"p"}),"\n","chunk1.glsl"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-glsl"},"@varDeclare\nvarying vec4 v_a;\n@end\n\n@body\n    vec4 c = v_a;\n@end\n")),(0,r.kt)("p",null,"chunk2.glsl"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-glsl"},"@varDeclare\nvarying vec4 v_b;\n@end\n\n@body\n    vec4 d = c + v_b;\n@end\n")),(0,r.kt)("p",null,"\u7ec4\u5408chunk1.glsl\u548cchunk2.glsl\u540e\uff0c\u5f97\u5230\u7684\u4ee3\u7801\u5982\u4e0b\uff1a"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-glsl"},"@varDeclare\nvarying vec4 v_a;\nvarying vec4 v_b;\n@end\n\n@body\n    vec4 c = v_a;\n    vec4 d = c + v_b;\n@end\n")),(0,r.kt)("h4",{id:"merged-glsl-chunk\u7684\u4ee3\u7801"},"Merged GLSL Chunk\u7684\u4ee3\u7801"),(0,r.kt)("p",null,"MergedGLSLChunk.ts"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-ts"},'  let _buildChunk =\n      (\n        [ top, define ]:[string, string],\n        varDeclare: string,\n        [ funcDeclare, funcDefine ]:[string, string],\n        body: string\n      ) => {\n    return {\n      top,\n      define,\n      varDeclare,\n      funcDeclare,\n      funcDefine,\n      body\n    }\n  };\n\n  export let getData = () =>{\n  \n        return {\n            "modelMatrix_noInstance_vertex": _buildChunk([``, ``],``,[``, ``],`mat4 mMatrix = u_mMatrix;`,), "modelMatrix_instance_vertex": _buildChunk([``, ``],``,[``, ``],`mat4 mMatrix = mat4(a_mVec4_0, a_mVec4_1, a_mVec4_2, a_mVec4_3);`,), ...\n        }\n  }\n')),(0,r.kt)("p",null,"\u53ef\u4ee5\u6839\u636e\u9700\u8981\uff08\u4e5f\u5c31\u662f\u770b\u5f15\u64ce\u662f\u7528Typescript\u8fd8\u662fRescript\u5199\u7684\uff09\u8c03\u7528\u4e0d\u540c\u7684gulp\u4efb\u52a1\uff0c\u5c06GLSL Chunk\u5408\u5e76\u4e3aTypescript\u6216\u8005Rescript\u5199\u7684Merged GLSL Chunk\u6587\u4ef6\u3002\u8fd9\u91cc\u6211\u4eec\u7ed9\u51fa\u7684Typescript\u6587\u4ef6"),(0,r.kt)("p",null,"\u6211\u4eec\u53ef\u4ee5\u770b\u5230\uff0cMergedGLSLChunk\u7684getData\u51fd\u6570\u8fd4\u56de\u4e86Merged GLSL Chunk\u8fd9\u4e2a\u6570\u636e\uff0c\u5b83\u662f\u4e00\u4e2aHash Map\uff0c\u5176\u4e2dKey\u662fshader_chunks.json\u7684glsls\u5b57\u6bb5\u4e2d\u6570\u7ec4\u5143\u7d20\u7684name\uff0c\u4e5f\u5c31\u662fGLSL Chunk\u7684\u6587\u4ef6\u540d\uff1bValue\u662f\u8be5GLSL Chunk\u5305\u62ec\u7684\u533a\u57df\u7684\u7247\u6bb5\u4ee3\u7801"),(0,r.kt)("h4",{id:"\u521d\u59cb\u5316\u6240\u6709\u57fa\u7840\u6750\u8d28\u7684shader\u7684\u4ee3\u7801-1"},"\u521d\u59cb\u5316\u6240\u6709\u57fa\u7840\u6750\u8d28\u7684Shader\u7684\u4ee3\u7801"),(0,r.kt)("p",null,"InitMaterialShader"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-ts"},'let _initOneMaterialTypeShader = (\n    state: state,\n    [\n      \u5f15\u64ce\u5b9e\u73b0\u7684\u4e00\u4e9b\u51fd\u6570...\n    ]: any,\n    allMaterials: Array<material>,\n    shaderName: shaderName,\n    shaderIndexMap: Map<material, shaderIndex>\n) => {\n    let [newProgramMap, newSendMetadataMap, newShaderIndexMap, _allGLSLs, newMaxShaderIndex] = allMaterials.reduce(([programMap, sendMetadataMap, shaderIndexMap, glslMap, maxShaderIndex]: any, material) => {\n        //\u8fd4\u56de\u7684glsl\u662f\u62fc\u63a5\u540e\u7684\u4e00\u4e2aTarget GLSL\n        let [shaderChunks, glsl] = ChunkHandler.buildGLSL(\n            [\n              \u4f20\u5165\u5f15\u64ce\u5b9e\u73b0\u7684\u4e00\u4e9b\u51fd\u6570...\n            ],\n            state.shaders,\n            state.shaderChunks,\n            state.chunk,\n            shaderName,\n            state.precision\n        )\n\n        let [shaderIndex, newMaxShaderIndex] = ShaderUtils.generateShaderIndex(glslMap, glsl, maxShaderIndex)\n\n        if (!programMap.has(shaderIndex)) {\n            programMap = programMap.set(shaderIndex, ShaderUtils.createFakeProgram(glsl))\n        }\n\n        ...\n\n        let sendMetadata = ChunkHandler.buildSendMetadata(\n            [\n              \u4f20\u5165\u5f15\u64ce\u5b9e\u73b0\u7684\u4e00\u4e9b\u51fd\u6570...\n            ],\n            shaderChunks\n        )\n\n        if (!glslMap.has(shaderIndex)) {\n            glslMap = glslMap.set(shaderIndex, glsl)\n        }\n\n        console.log("shaderIndex:", shaderIndex)\n\n        return [\n            programMap,\n            sendMetadataMap.set(shaderIndex, sendMetadata),\n            ShaderUtils.setShaderIndex(shaderIndexMap, material, shaderIndex),\n            glslMap,\n            newMaxShaderIndex\n        ]\n    }, [state.programMap, state.sendMetadataMap, shaderIndexMap, Map(), state.maxShaderIndex])\n\n    return [newProgramMap, newSendMetadataMap, newShaderIndexMap, newMaxShaderIndex]\n}\n\nexport let initBasicMaterialShader = (\n    state: state,\n    [allMaterials, shaderName]: [\n        Array<basicMaterial>,\n        shaderName\n    ]\n): state => {\n    let [newProgramMap, newSendMetadataMap, newShaderIndexMap, newMaxShaderIndex] = _initOneMaterialTypeShader(state,\n        [\n            \u4f20\u5165\u5f15\u64ce\u5b9e\u73b0\u7684\u4e00\u4e9b\u51fd\u6570...\n        ],\n        allMaterials, shaderName, state.basicMaterialShaderIndexMap)\n\n    return {\n        ...state,\n        programMap: newProgramMap,\n        sendMetadataMap: newSendMetadataMap,\n        basicMaterialShaderIndexMap: newShaderIndexMap,\n        maxShaderIndex: newMaxShaderIndex\n    }\n}\n')),(0,r.kt)("p",null,"initBasicMaterialShader\u51fd\u6570\u521d\u59cb\u5316\u6240\u6709\u57fa\u7840\u6750\u8d28\u7684shader\uff0c\u5b83\u7684\u6b65\u9aa4\u8ddf\u4e4b\u524d\u5dee\u4e0d\u591a\uff0c\u4e0d\u4e00\u6837\u7684\u5730\u65b9\u4e3b\u8981\u662f\uff1a"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"\u5728\u6bcf\u6b21\u904d\u5386\u65f6\u8c03\u7528buildGLSL\u51fd\u6570\u6784\u9020\u7684glsl\u662f\u4e00\u4e2aTarget GLSL\uff0c\u4e0d\u662f\u4e00\u4e2aBasicMaterialShaderGLSL\uff08Add Define\uff09"),(0,r.kt)("li",{parentName:"ul"},"\u5728\u6bcf\u6b21\u904d\u5386\u65f6\u589e\u52a0\u4e86\u4e00\u6b65\uff1a\u8c03\u7528ChunkHandler\u7684buildSendMetadata\u51fd\u6570\u6765\u6784\u9020SendMetadata")),(0,r.kt)("p",null,"\u5177\u4f53\u6765\u8bf4\uff0c_initOneMaterialTypeShader\u51fd\u6570\u5728\u6bcf\u6b21\u904d\u5386\u65f6\uff0c\u9996\u5148\u8c03\u7528\u4e86ChunkHandler\u7684buildGLSL\u51fd\u6570\uff0c\u6309\u7167shaders.json\u548cshader_chunks.json\u7684\u914d\u7f6e\u6570\u636e\u5c06EngineState\u7684chunk\uff08\u5373Merged GLSL Chunk\uff09\u4e2d\u5bf9\u5e94\u7684GLSL Chunk\u62fc\u63a5\u4e3a\u4e00\u4e2aTarget GLSL\uff1b\u7136\u540e\u8c03\u7528\u4e86ChunkHandler\u7684buildSendMetadata\u51fd\u6570\uff0c\u6309\u7167GLSL Config\uff08\u5373shaderChunks\u53d8\u91cf\uff09\u6765\u6784\u9020\u76f8\u5173\u7684\u9876\u70b9\u3001Uniform\u6570\u636e\u7684Send Metadata\uff0c\u5c06\u5176\u4fdd\u5b58\u5728EngineState\u7684sendMetadataMap\u4e2d"),(0,r.kt)("p",null,"ChunkHandler\u7684buildGLSL\u51fd\u6570\u548cbuildSendMetadata\u51fd\u6570\u90fd\u63a5\u53d7\u4e86\u5f15\u64ce\u5b9e\u73b0\u7684\u51fd\u6570\uff0c\u5b83\u4eec\u88ab\u7528\u4e8e\u5904\u7406shaders.json\u548cshader_chunks.json\u4e2d\u7684\u4e00\u4e9b\u5b57\u6bb5\uff0c\u4ece\u800c\u5b9e\u73b0\u5206\u652f\u5904\u7406\u6216\u8005\u4ece\u4e2d\u6784\u9020Send Metadata\u3002\u56e0\u4e3a\u8fd9\u4e9b\u5b57\u6bb5\u7684\u503c\u662f\u79bb\u6563\u7684\uff0c\u5b83\u4eec\u7684\u8303\u56f4\u662f\u5f15\u64ce\u5b9a\u4e49\u7684\uff0c\u7528\u6237\u53ea\u80fd\u4ece\u8303\u56f4\u5185\u9009\u62e9\u67d0\u4e2a\u5177\u4f53\u7684\u503c\uff0c\u6240\u4ee5\u8fd9\u4e9b\u5b57\u6bb5\u7684\u7c7b\u578b\u662f\u5b9a\u4e49\u5728\u5f15\u64ce\u7aef\uff0c\u5728\u7c7b\u578b\u4e2d\u660e\u786e\u4e86\u503c\u7684\u8303\u56f4\u3002\u7c7b\u578b\u5b9a\u4e49\u7684\u90e8\u5206\u4ee3\u7801\u5982\u4e0b\uff1a",(0,r.kt)("br",{parentName:"p"}),"\n","GLSLConfigType"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-ts"},'...\nexport type condition = "basic_has_map" | "diffuse_has_map"\n\nexport enum attributeBuffer {\n    Vertex = 0,\n    Normal = 1,\n    TexCoord = 2,\n    Index = 3,\n    Instance_model_matrix = 4\n}\n\n...\n')),(0,r.kt)("p",null,"\u8fd9\u91cc\u5206\u522b\u5b9a\u4e49\u4e86shaders.json\u7684dynamic_branchs\u5b57\u6bb5\u4e2d\u7684condition\u548cshader_chunks.json\u7684variables\u5b57\u6bb5\u7684attributes\u7684buffer\u7684\u8303\u56f4\uff0c\u5b83\u4eec\u7684\u76f8\u5173\u4ee3\u7801\u5982\u4e0b\uff1a",(0,r.kt)("br",{parentName:"p"}),"\n","shaders.json"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-ts"},'{\n  "dynamic_branchs": [\n    {\n      ...\n      "condition": "basic_has_map",\n      ...\n    },\n    ...\n  ],\n  ...\n}\n')),(0,r.kt)("p",null,"shader_chunks.json"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-ts"},'[\n  {\n    ...\n    "variables": {\n      "attributes": [\n        {\n          ...\n          "buffer": 4,\n          ...\n        },\n        ...\n      ]\n    }\n  },\n]\n')),(0,r.kt)("h4",{id:"\u521d\u59cb\u5316\u6240\u6709pbr\u6750\u8d28\u7684shader\u7684\u4ee3\u7801-1"},"\u521d\u59cb\u5316\u6240\u6709PBR\u6750\u8d28\u7684Shader\u7684\u4ee3\u7801"),(0,r.kt)("p",null,"InitMaterialShader\u7684initPBRMaterialShader\u51fd\u6570\u5b9e\u73b0\u4e86\u521d\u59cb\u5316\u6240\u6709PBR\u6750\u8d28\u7684Shader\uff0c\u5b83\u4e0e\u540c\u4e00\u4e2a\u6a21\u5757\u7684initBasicMaterialShader\u51fd\u6570\u7c7b\u4f3c\uff0c\u4e0d\u540c\u7684\u5730\u65b9\u4e3b\u8981\u5982\u4e0b\uff1a"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"\u4f20\u5165\u7684allMaterials\u662f\u6240\u6709\u7684PBR\u6750\u8d28\u7ec4\u4ef6\u800c\u4e0d\u662f\u6240\u6709\u7684\u57fa\u7840\u6750\u8d28\u7ec4\u4ef6\uff1b"),(0,r.kt)("li",{parentName:"ul"},"\u4f20\u5165\u7684shaderName\u4e0d\u4e00\u6837\uff0c\u503c\u4e3a\u201crender_pbr\u201d\u800c\u4e0d\u662f\u201crender_basic\u201d\uff1b"),(0,r.kt)("li",{parentName:"ul"},"\u4f20\u5165_initOneMaterialTypeShader\u51fd\u6570\u7684\u201c\u5f15\u64ce\u5b9e\u73b0\u7684\u51fd\u6570\u201d\u4e0d\u4e00\u6837\uff1b"),(0,r.kt)("li",{parentName:"ul"},"\u751f\u6210\u7684shaderIndex\u6539\u4e3a\u4fdd\u5b58\u5230EngineState\u7684pbrMaterialShaderIndexMap\u4e2d")),(0,r.kt)("h4",{id:"\u6e32\u67d3\u573a\u666f\u7684\u4ee3\u7801-1"},"\u6e32\u67d3\u573a\u666f\u7684\u4ee3\u7801"),(0,r.kt)("p",null,"Render"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-ts"},'export let render = (state: state): state => {\n    let gl = state.gl\n    let sendMetadataMap = state.sendMetadataMap\n    let programMap = state.programMap\n\n    getAllGameObjects(state.gameObjectState).forEach(gameObject => {\n        \u8ddf\u4e4b\u524d\u4e00\u6837...\n\n        let sendMetadata = getExnFromStrictUndefined(sendMetadataMap.get(shaderIndex))\n\n        gl.useProgram(program)\n\n        let [attributeSendMetadata, uniformSendMetadata] = sendMetadata\n\n        _sendAttributeData(attributeSendMetadata, state, shaderIndex, gl)\n        _sendUniformData(uniformSendMetadata, state, transform, material, gl)\n\n        console.log("\u5176\u5b83\u6e32\u67d3\u903b\u8f91...")\n    })\n\n    return state\n}\n')),(0,r.kt)("p",null,"render\u51fd\u6570\u8ddf\u4e4b\u524d\u51e0\u4e4e\u662f\u4e00\u6837\u7684\uff0c\u53ea\u662f\u591a\u4e86\u201c\u4eceEngineState\u7684sendMetadataMap\u4e2d\u83b7\u5f97Send Metadata\u201d\u8fd9\u4e00\u6b65\u7684\u4ee3\u7801\uff0c\u5e76\u5c06\u5176\u4f20\u7ed9\u4e86_sendAttributeData\u3001_sendUniformData\u51fd\u6570"),(0,r.kt)("p",null,"\u6211\u4eec\u770b\u4e0b\u53d1\u9001\u9876\u70b9\u6570\u636e\u7684\u4ee3\u7801\uff1a",(0,r.kt)("br",{parentName:"p"}),"\n","Render"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-ts"},"let _sendAttributeData = (attributeSendMetadata: Array<attributeSendMetadata>, state: state, shaderIndex: shaderIndex, gl: WebGLRenderingContext) => {\n    attributeSendMetadata.forEach(data => {\n        //\u201c!!\u201d\u8868\u793adata.elementSendMetadata\u5b58\u5728\uff0c\u5373\u975enull\u4e14\u975eundefined\n        if (!!data.elementSendMetadata) {\n            // \u7ed1\u5b9aElementArrayBuffer\n\n            data.elementSendMetadata.sendBuffer(gl, _getFakeElementArrayBuffer(state, shaderIndex))\n        }\n        if (!!data.instanceSendMetadata) {\n            \u83b7\u5f97\u5e76\u53d1\u9001instance\u76f8\u5173\u7684VBO\n        }\n        if (!!data.otherSendMetadata) {\n            // \u83b7\u5f97\u5e76\u53d1\u9001Position\u3001TexCoord\u7684VBO\n\n            let { pos, size, sendBuffer, buffer } = data.otherSendMetadata\n\n            sendBuffer(gl, size, pos, _getFakeArrayBuffer(state, buffer, shaderIndex))\n        }\n    })\n}\n")),(0,r.kt)("p",null,"\u73b0\u5728_sendAttributeData\u51fd\u6570\u6ca1\u6709\u5206\u652f\u5224\u65ad\u4e86\uff0c\u800c\u662f\u76f4\u63a5\u904d\u5386\u9876\u70b9\u6570\u636e\u7684Send Metadata\uff0c\u83b7\u5f97\u5e76\u53d1\u9001\u5bf9\u5e94\u7684VBO\u6570\u636e"),(0,r.kt)("p",null,"\u6211\u4eec\u770b\u4e0b\u53d1\u9001Uniform\u6570\u636e\u7684\u4ee3\u7801\uff1a",(0,r.kt)("br",{parentName:"p"}),"\n","Render"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-ts"},"let _sendUniformData = (uniformSendMetadata: Array<uniformSendMetadata>, state: state, transform, material, gl: WebGLRenderingContext) => {\n    uniformSendMetadata.forEach(data => {\n        if (!!data.shaderSendMetadata) {\n            // \u83b7\u5f97\u5e76\u53d1\u9001\u76f8\u673a\u6570\u636e\n\n            let { pos, getData, sendData } = data.shaderSendMetadata\n\n            sendData(gl, pos, getData(state))\n        }\n        if (!!data.renderObjectSendMaterialData) {\n            // \u83b7\u5f97\u5e76\u53d1\u9001\u6750\u8d28\u6570\u636e\n\n            let { pos, getData, sendData } = data.renderObjectSendMaterialData\n\n            sendData(gl, pos, getData(state, material))\n        }\n        if (!!data.renderObjectSendModelData) {\n            // \u83b7\u5f97\u5e76\u53d1\u9001\u6a21\u578b\u7684\u6570\u636e\uff08\u5982\u6a21\u578b\u77e9\u9635\uff09\n\n            let { pos, getData, sendData } = data.renderObjectSendModelData\n\n            sendData(gl, pos, getData(state, transform))\n        }\n    })\n}\n")),(0,r.kt)("p",null,"\u73b0\u5728_sendUniformData\u51fd\u6570\u6ca1\u6709\u5206\u652f\u5224\u65ad\u4e86\uff0c\u800c\u662f\u76f4\u63a5\u904d\u5386Uniform\u6570\u636e\u7684Send Metadata\uff0c\u83b7\u5f97\u5e76\u53d1\u9001\u5bf9\u5e94\u7684Uniform\u6570\u636e"),(0,r.kt)("h4",{id:"\u8fd0\u884cclient\u7684\u4ee3\u7801-1"},"\u8fd0\u884cClient\u7684\u4ee3\u7801"),(0,r.kt)("p",null,"\u6211\u4eec\u8fd0\u884cClient\u7684\u4ee3\u7801\uff0c\u6d4f\u89c8\u5668\u63a7\u5236\u53f0\u6253\u5370\u7684\u7ed3\u679c\u8ddf\u4e4b\u524d\u57fa\u672c\u4e0a\u4e00\u6837\uff0c\u6545\u7701\u7565"),(0,r.kt)("h2",{id:"\u5b9a\u4e49"},"\u5b9a\u4e49"),(0,r.kt)("h3",{id:"\u4e00\u53e5\u8bdd\u5b9a\u4e49"},"\u4e00\u53e5\u8bdd\u5b9a\u4e49"),(0,r.kt)("p",null,"\u5206\u89e3\u6709\u5404\u79cd\u5206\u652f\u7684\u5927\u6570\u636e\u4e3a\u591a\u4e2a\u5c0f\u5757\u6570\u636e\uff0c\u6309\u7167\u914d\u7f6e\u6587\u4ef6\u6765\u62fc\u63a5"),(0,r.kt)("h3",{id:"\u8865\u5145\u8bf4\u660e"},"\u8865\u5145\u8bf4\u660e"),(0,r.kt)("p",null,"\u5927\u6570\u636e\u4e2d\u7684\u6bcf\u4e2a\u5206\u652f\u90fd\u53ef\u4ee5\u5206\u89e3\u4e3a\u4e00\u5757\u6570\u636e\uff0c\u5982\u6709\u4e0b\u9762\u7684\u4e00\u4e2a\u5927\u6570\u636e\uff1a"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-ts"},"#ifdef INSTANCE\n\u6570\u636e1\n#endif\n\n#ifdef NO_INSTANCE\n\u6570\u636e2\n#endif\n")),(0,r.kt)("p",null,"\u5b83\u6709\u4e24\u4e2a\u5206\u652f\uff0c\u53ef\u4ee5\u5c06\u5176\u5206\u89e3\u4e3a\u6570\u636e1\u3001\u6570\u636e2\u8fd9\u4e24\u4e2a\u5c0f\u5757\u6570\u636e"),(0,r.kt)("p",null,"\u914d\u7f6e\u6587\u4ef6\u7531\u7528\u6237\u7ed9\u51fa\uff0c\u5305\u62ec\u4e0b\u9762\u7684\u5185\u5bb9\uff1a",(0,r.kt)("br",{parentName:"p"}),"\n","\u6709\u54ea\u4e9b\u5206\u652f\u3001\u8981\u6784\u9020\u54ea\u4e9bTarget\u6570\u636e\u3001\u6bcf\u4e2aTarget\u6570\u636e\u5305\u62ec\u54ea\u4e9b\u5757\u3001\u6bcf\u5757\u6709\u54ea\u4e9b\u914d\u7f6e\u6570\u636e"),(0,r.kt)("h3",{id:"\u901a\u7528uml"},"\u901a\u7528UML"),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"\u9886\u57df\u6a21\u578b")),(0,r.kt)("p",null,(0,r.kt)("img",{alt:"\u9886\u57df\u6a21\u578b\u56fe",src:a(7576).Z})),(0,r.kt)("p",null,"\u603b\u4f53\u6765\u770b\uff0c\u9886\u57df\u6a21\u578b\u5206\u4e3a\u7528\u6237\u3001\u6570\u636e\u3001ChunkConverter\u3001ChunkHandler\u3001\u7cfb\u7edf\u8fd9\u4e94\u4e2a\u90e8\u5206"),(0,r.kt)("p",null,"\u6211\u4eec\u770b\u4e0b\u7528\u6237\u8fd9\u4e2a\u90e8\u5206\uff1a"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Client",(0,r.kt)("br",{parentName:"li"}),"\u8be5\u89d2\u8272\u662f\u7528\u6237")),(0,r.kt)("p",null,"\u6211\u4eec\u770b\u4e0b\u6570\u636e\u548cChunkConverter\u8fd9\u4e24\u4e2a\u90e8\u5206\uff1a"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"Target",(0,r.kt)("br",{parentName:"p"}),"\n","\u8be5\u89d2\u8272\u662f\u7b26\u5408\u67d0\u79cd\u7279\u5b9a\u5206\u652f\u6761\u4ef6\u7684\u6570\u636e\uff0c\u5982","[\u6709\u666e\u901a\u8d34\u56fe\uff0c\u652f\u6301Instance]","\u7684GLSL\u5c31\u662f\u4e00\u4e2aTarget")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"Runtime Metadata",(0,r.kt)("br",{parentName:"p"}),"\n","\u8be5\u89d2\u8272\u662f\u64cd\u4f5c\u8fd0\u884c\u65f6\u6570\u636e\u7684\u5143\u6570\u636e\u3002\u5177\u4f53\u6765\u8bf4\uff0c\u6bcf\u4e2aRuntime Metadata\u5305\u62ec\u4e86\u591a\u4e2agetData\u51fd\u6570\u548c\u591a\u4e2asendData\u51fd\u6570\uff0c\u5176\u4e2d\u524d\u8005\u83b7\u5f97\u5bf9\u5e94\u7684\u8fd0\u884c\u65f6\u6570\u636e\uff0c\u540e\u8005\u53d1\u9001\u5b83\u4eec"))),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"Target Config",(0,r.kt)("br",{parentName:"p"}),"\n","\u8be5\u89d2\u8272\u662f\u914d\u7f6e\u6570\u636e\uff0c\u7528\u6765\u6307\u5b9a\u5982\u4f55\u62fc\u63a5Target\uff0c\u5e76\u5305\u62ec\u4e86Runtime Metadata\u7684\u914d\u7f6e\u6570\u636e\u3002\u5b83\u7684\u5185\u5bb9\u7531\u7528\u6237\u7ed9\u51fa\uff0c\u5b83\u7684\u683c\u5f0f\uff08\u4e5f\u5c31\u662f\u7c7b\u578b\uff09\u7531ChunkHandler\u5b9a\u4e49\u3002Target Config\u4e2d\u67d0\u4e9b\u5b57\u6bb5\u7684\u503c\u662f\u79bb\u6563\u7684\uff0c\u5b83\u4eec\u7684\u8303\u56f4\u662f\u7cfb\u7edf\u5b9a\u4e49\u7684\uff0c\u7528\u6237\u53ea\u80fd\u4ece\u8303\u56f4\u5185\u9009\u62e9\u67d0\u4e2a\u5177\u4f53\u7684\u503c")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"Target Chunk",(0,r.kt)("br",{parentName:"p"}),"\n","\u8be5\u89d2\u8272\u662f\u5c0f\u5757\u7684\u6570\u636e\uff0c\u7531\u7cfb\u7edf\u7ed9\u51fa"))),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"ChunkConverter",(0,r.kt)("br",{parentName:"li"}),"\u8be5\u89d2\u8272\u8d1f\u8d23\u5904\u7406Target Chunk\uff0c\u5e76\u5c06\u5176\u5408\u5e76\u4e3a\u4e00\u4e2aMerged Target Chunk\u3002\u56e0\u4e3aTarget Chunk\u662f\u81ea\u5b9a\u4e49\u6587\u4ef6\uff0c\u6709\u4e00\u4e9b\u81ea\u5b9a\u4e49\u7684\u8bed\u6cd5\uff0c\u4e0d\u80fd\u76f4\u63a5\u4f7f\u7528\uff0c\u6240\u4ee5\u7cfb\u7edf\u9700\u8981\u8c03\u7528ChunkConverter\u5bf9\u5176\u9884\u5904\u7406")),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Merged Target Chunk",(0,r.kt)("br",{parentName:"li"}),"\u8be5\u89d2\u8272\u662f\u5408\u5e76\u4e86\u6240\u6709\u7684Target Chunk\u540e\u7684\u6570\u636e\uff0c\u5b83\u662f\u4e00\u4e2aTypescript\u6216\u8005Rescript\u6587\u4ef6")),(0,r.kt)("p",null,"\u6211\u4eec\u770b\u4e0bChunkHandler\u548c\u7cfb\u7edf\u8fd9\u4e24\u4e2a\u90e8\u5206\uff1a"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"ChunkHandler",(0,r.kt)("br",{parentName:"p"}),"\n","\u8be5\u89d2\u8272\u8d1f\u8d23\u62fc\u63a5Target\u548c\u6784\u9020Runtime Metadata")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"System",(0,r.kt)("br",{parentName:"p"}),"\n","\u8be5\u89d2\u8272\u4e3a\u7cfb\u7edf\u7684\u95e8\u6237\uff0c\u63d0\u4f9bAPI\u7ed9Client")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"Init",(0,r.kt)("br",{parentName:"p"}),"\n","\u8be5\u89d2\u8272\u5b9e\u73b0\u7cfb\u7edf\u7684\u521d\u59cb\u5316\uff0c\u5b83\u5305\u62ec\u4e0b\u9762\u7684\u6b65\u9aa4\uff1a",(0,r.kt)("br",{parentName:"p"}),"\n","1.\u8c03\u7528ChunkHandler\u7684buildTarget\u51fd\u6570\uff0c\u6309\u7167Target Config\u5c06Merged Target Chunk\u4e2d\u5bf9\u5e94\u7684Target Chunk\u62fc\u63a5\u4e3a\u4e00\u4e2aTarget\uff0c\u7136\u540e\u4f7f\u7528\u5b83",(0,r.kt)("br",{parentName:"p"}),"\n","2.\u8c03\u7528ChunkHandler\u7684buildRuntimeMetadata\u51fd\u6570\uff0c\u6309\u7167Target Config\u6784\u9020Runtime Metadata"))),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"OperateWhenRuntime",(0,r.kt)("br",{parentName:"li"}),"\u8be5\u89d2\u8272\u662f\u8fd0\u884c\u65f6\u8fdb\u884c\u7684\u67d0\u4e2a\u64cd\u4f5c\uff08\u5982\u6e32\u67d3\uff09\uff0c\u4f7f\u7528\u4e86Runtime Metadata\u6765\u64cd\u4f5c\u8fd0\u884c\u65f6\u6570\u636e")),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"\u89d2\u8272\u4e4b\u95f4\u7684\u5173\u7cfb")),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"\u6709\u591a\u4e2aTarget Chunk")),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"\u53ea\u6709\u4e00\u4e2aMerged Target Chunk\uff0c\u7531\u6240\u6709\u7684Target Chunk\u5408\u5e76\u800c\u6765")),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Target Config\u901a\u5e38\u5305\u542b\u4e24\u4e2a\u914d\u7f6e\u6587\u4ef6\uff1atargets_config\u3001chunks_config",(0,r.kt)("br",{parentName:"li"}),"\u8fd9\u4e24\u4e2a\u6587\u4ef6\u7684\u5173\u7cfb\u662f\u201c\u603b-\u5206\u201d\u7684\u5173\u7cfb\uff0c\u5176\u4e2dtargets_config\u662f\u201c\u603b\u201d\uff0cchunks_config\u662f\u201c\u5206\u201d\u3002\u5176\u4e2d\u524d\u8005\u5e94\u8be5\u6307\u5b9a\u8981\u6784\u9020\u54ea\u4e9b\u79cd\u7c7b\u7684Target\u3001\u6bcf\u79cdTarget\u6709\u54ea\u4e9bTarget Chunk\uff1b\u540e\u8005\u5e94\u8be5\u6307\u5b9a\u6240\u6709\u7684Target Chunk\u7684\u914d\u7f6e\u6570\u636e")),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"\u6709\u591a\u4e2aTarget\uff0c\u5982","[\u6709\u666e\u901a\u8d34\u56fe\uff0c\u652f\u6301Instance]","\u7684GLSL\u662f\u4e00\u4e2aTarget\uff0c","[\u6ca1\u6709\u666e\u901a\u8d34\u56fe\uff0c\u652f\u6301Instance]","\u7684GLSL\u662f\u53e6\u5916\u4e00\u4e2aTarget")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"\u6709\u591a\u4e2aRuntime Metadata\uff0c\u5176\u4e2d\u4e00\u4e2aRuntime Metadata\u5bf9\u5e94\u4e00\u4e2aTarget"))),(0,r.kt)("h3",{id:"\u89d2\u8272\u7684\u62bd\u8c61\u4ee3\u7801"},"\u89d2\u8272\u7684\u62bd\u8c61\u4ee3\u7801"),(0,r.kt)("p",null,"\u4e0b\u9762\u6211\u4eec\u6765\u770b\u770b\u5404\u4e2a\u89d2\u8272\u7684\u62bd\u8c61\u4ee3\u7801\uff1a"),(0,r.kt)("p",null,"\u9996\u5148\uff0c\u6211\u4eec\u770b\u4e0bTarget Chunk\u7684\u62bd\u8c61\u4ee3\u7801",(0,r.kt)("br",{parentName:"p"}),"\n","\u7136\u540e\uff0c\u56e0\u4e3a\u7cfb\u7edf\u4f1a\u5728\u9884\u5904\u7406\u65f6\u8c03\u7528gulp\u4efb\u52a1\uff0c\u8c03\u7528ChunkConverter\u6765\u5408\u5e76Target Chunk\u4e3aMerged Target Chunk\uff0c\u6240\u4ee5\u6211\u4eec\u770b\u4e0b\u5b83\u4eec\u7684\u62bd\u8c61\u4ee3\u7801\uff1a"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"ChunkConverter\u7684\u62bd\u8c61\u4ee3\u7801"),(0,r.kt)("li",{parentName:"ul"},"Merged Target Chunk\u7684\u62bd\u8c61\u4ee3\u7801"),(0,r.kt)("li",{parentName:"ul"},"\u7cfb\u7edf\u7684gulp\u4efb\u52a1\u7684\u62bd\u8c61\u4ee3\u7801")),(0,r.kt)("p",null,"\u7136\u540e\uff0c\u6211\u4eec\u770b\u4e0bTarget Config\u7684\u62bd\u8c61\u4ee3\u7801",(0,r.kt)("br",{parentName:"p"}),"\n","\u7136\u540e\uff0c\u6211\u4eec\u770b\u4e0bClient\u7684\u62bd\u8c61\u4ee3\u7801",(0,r.kt)("br",{parentName:"p"}),"\n","\u7136\u540e\uff0c\u6211\u4eec\u770b\u4e0b\u7cfb\u7edf\u7684\u62bd\u8c61\u4ee3\u7801",(0,r.kt)("br",{parentName:"p"}),"\n","\u6700\u540e\uff0c\u6211\u4eec\u770b\u4e0bChunkHandler\u7684\u62bd\u8c61\u4ee3\u7801"),(0,r.kt)("h4",{id:"target-chunk\u7684\u62bd\u8c61\u4ee3\u7801"},"Target Chunk\u7684\u62bd\u8c61\u4ee3\u7801"),(0,r.kt)("p",null,"\u4e0b\u9762\u662f\u4e00\u4e2aTarget Chunk\u6587\u4ef6\u7684\u62bd\u8c61\u4ee3\u7801\uff1a",(0,r.kt)("br",{parentName:"p"}),"\n","target_chunk1"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-ts"},"@part1\n\u533a\u57df1\u7684\u6570\u636e\n@end\n\n@part2\n\u533a\u57df2\u7684\u6570\u636e\n@end\n\n...\n")),(0,r.kt)("p",null,"part1\u3001part2\u662f\u62bd\u8c61\u7684\u81ea\u5b9a\u4e49\u5b57\u7b26\uff08\u5b9e\u9645\u4e0a\u53ef\u4ee5\u4e3a\u4efb\u610f\u7684\u5b57\u7b26\uff09\uff0c\u7528\u4e8e\u5c06\u4e00\u4e2a\u5b8c\u6574\u7684\u5927\u6570\u636e\u6309\u7167\u4e00\u5b9a\u7684\u987a\u5e8f\u5206\u5272\u4e3a\u4e0d\u540c\u533a\u57df\u7684\u7247\u6bb5\uff0c\u8fd9\u6837\u4fbf\u4e8e\u66f4\u7ec6\u7c92\u5ea6\u7684\u7ec4\u5408\u62fc\u63a5\u3002\u4e00\u4e2aTarget Chunk\u53ef\u4ee5\u5305\u62ec\u591a\u4e2a\u533a\u57df\u7684\u7247\u6bb5"),(0,r.kt)("h4",{id:"chunkconverter\u7684\u62bd\u8c61\u4ee3\u7801"},"ChunkConverter\u7684\u62bd\u8c61\u4ee3\u7801"),(0,r.kt)("p",null,"ChunkConverter"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-ts"},"//create MergedTargetChunk.ts\nexport declare function createMergedTargetChunkForTs(targetChunkPathArr: Array<string>, destFilePath: string, doneFunc): void\n\n//create MergedTargetChunk.res\nexport declare function createMergedTargetChunkForRes(targetChunkPathArr: Array<string>, destFilePath: string, doneFunc): void\n")),(0,r.kt)("p",null,"ChunkConverter\u7684API\u662f\u8fd9\u4e24\u4e2a\u51fd\u6570\uff0c\u8fd9\u91cc\u53ea\u7ed9\u51fa\u4e86\u51fd\u6570\u7b7e\u540d\u3002\u5176\u4e2d\uff0ccreateMergedTargetChunkForTs\u51fd\u6570\u7528\u4e8e\u521b\u5efaTypescript\u5199\u7684Merged Target Chunk\u6587\u4ef6\uff1bcreateMergedTargetChunkForRes\u51fd\u6570\u7528\u4e8e\u521b\u5efaRescript\u5199\u7684Merged Target Chunk\u6587\u4ef6"),(0,r.kt)("h4",{id:"merged-target-chunk\u7684\u62bd\u8c61\u4ee3\u7801"},"Merged Target Chunk\u7684\u62bd\u8c61\u4ee3\u7801"),(0,r.kt)("p",null,"MergedTargetChunk.ts"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-ts"},'let _buildChunk =\n    (\n        part1: string,\n        part2: string,\n        ...\n    ) => {\n        return {\n            part1,\n            part2,\n            ...\n        }\n    };\n\nexport let getData = (): ... => {\n\n    return {\n        "target_chunk1": _buildChunk("...", "...", ...),\n        ... \n    }\n}\n')),(0,r.kt)("p",null,"\u8fd9\u662fTypescript\u5199\u7684Merged Target Chunk\u6587\u4ef6\u7684\u62bd\u8c61\u4ee3\u7801"),(0,r.kt)("h4",{id:"\u7cfb\u7edf\u7684gulp\u4efb\u52a1\u7684\u62bd\u8c61\u4ee3\u7801"},"\u7cfb\u7edf\u7684gulp\u4efb\u52a1\u7684\u62bd\u8c61\u4ee3\u7801"),(0,r.kt)("p",null,"\u7cfb\u7edf\u5728\u9884\u5904\u7406\u65f6\uff0c\u8c03\u7528\u4e0b\u9762\u7684gulp\u4efb\u52a1\u6765\u521b\u5efaMerged Target Chunk:",(0,r.kt)("br",{parentName:"p"}),"\n","gulpfile.js"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-ts"},'var gulp = require("gulp");\nvar path = require("path");\n\n//create for typescript\ngulp.task("createMergedGLSLChunkFile_ts", function (done) {\n    var chunkConverter = require("chunk_converter");\n\n    var chunkFilePath = path.join(process.cwd(), "src/glsl/MergedGLSLChunk.ts");\n    var glslPathArray = [path.join(process.cwd(), "src/glsl/**/*.glsl")];\n\n    chunkConverter.createMergedGLSLChunkFileForTs(glslPathArray, chunkFilePath, done);\n});\n\n//create for rescript\ngulp.task("createMergedGLSLChunkFile_res", function (done) {\n    var chunkConverter = require("chunk_converter");\n\n    var chunkFilePath = path.join(process.cwd(), "src/glsl/MergedGLSLChunk.res");\n    var glslPathArray = [path.join(process.cwd(), "src/glsl/**/*.glsl")];\n\n    chunkConverter.createMergedGLSLChunkFileForRes(glslPathArray, chunkFilePath, done);\n});\n')),(0,r.kt)("p",null,"\u8fd9\u91cc\u6709\u4e24\u4e2agulp\u4efb\u52a1\uff0c\u5176\u4e2dcreateMergedTargetChunkFile_ts\u4efb\u52a1\u7528\u6765\u521b\u5efaTypescript\u6587\u4ef6\uff0ccreateMergedTargetChunkFile_res\u4efb\u52a1\u7528\u6765\u521b\u5efaRescript\u6587\u4ef6"),(0,r.kt)("h4",{id:"target-config\u7684\u62bd\u8c61\u4ee3\u7801"},"Target Config\u7684\u62bd\u8c61\u4ee3\u7801"),(0,r.kt)("p",null,"Target Config\u901a\u5e38\u5305\u62ectargets_config.json\u548cchunks_config.json\u8fd9\u4e24\u4e2a\u914d\u7f6e\u6587\u4ef6\u3002\u5b83\u4eec\u7684\u62bd\u8c61\u4ee3\u7801\u5982\u4e0b\uff1a",(0,r.kt)("br",{parentName:"p"}),"\n","targets_config.json"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-ts"},'{\n  "static_branchs": [\n    {\n      "name": "static branch name",\n      "value": [\n        "chunk name for condition1",\n        "chunk name for condition2",\n        ...\n      ]\n    },\n    ...\n  ],\n  "dynamic_branchs": [\n    {\n      "name": "dynamic branch name",\n      "condition": "xxx",\n      "pass": "chunk name when condition pass",\n      "fail": "chunk name when condition fail"\n    },\n    ...\n  ],\n  "groups": [\n    {\n      "name": "group name",\n      "value": [\n        "chunk name",\n        "chunk name",\n        ...\n      ]\n    },\n    ...\n  ],\n  "targets": [\n    {\n      "name": "target1",\n      "target_chunks": [\n        {\n          "type": "static_branch || dynamic_branch || group",\n          "name": "static branch name || dynamic branch name || group name"\n        },\n        {\n          "name": "chunk name"\n        },\n        ...\n      ]\n    }\n  ]\n}\n')),(0,r.kt)("p",null,"chunks_config.json"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-ts"},'[\n    {\n        "name": "chunk name",\n        "target chunk": [\n            {\n                "type": "xxx",\n                "name": "target chunk\'s filename(e.g. target_chunk1)"\n            },\n            ...\n        ],\n        "runtime metadata config": {\n            "runtime metadata1 config": [\n                {\n                    xxx\n                },\n            ],\n            ...\n        }\n    },\n    ...\n]\n')),(0,r.kt)("h4",{id:"client\u7684\u62bd\u8c61\u4ee3\u7801"},"Client\u7684\u62bd\u8c61\u4ee3\u7801"),(0,r.kt)("p",null,"Client"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-ts"},"let parsedConfig = System.parseConfig(targetsConfigJson, chunksConfigJson)\n\nlet state = System.createState(parsedConfig)\n\ndeclare let someConfigData\nstate = System.init(state, someConfigData)\n\nstate = System.operateWhenRuntime(state)\n")),(0,r.kt)("h4",{id:"\u7cfb\u7edf\u7684\u62bd\u8c61\u4ee3\u7801"},"\u7cfb\u7edf\u7684\u62bd\u8c61\u4ee3\u7801"),(0,r.kt)("p",null,"System"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-ts"},"declare function _handleConfigFunc1(state: state, someConfigData): any\n\ndeclare function _addRuntimeMetadataFunc1(someRuntimeMetadataFromState, someConfigData): any\n\nexport let parseConfig = ChunkHandler.parseConfig\n\nexport let createState = (parsedConfig): state => {\n    return {\n        parsedConfig: parsedConfig,\n        chunk: getData(),\n\n        \u521b\u5efa\u66f4\u591a\u5b57\u6bb5...\n    }\n}\n\nexport let init = (state: state, someConfigData): state => {\n    let target = ChunkHandler.buildTarget(\n        [_handleConfigFunc1, ...],\n\n        state.parsedConfig,\n        state.chunk,\n        someConfigData\n    )\n\n    \u4f7f\u7528target...\n\n    let runtimeMetadata = ChunkHandler.buildRuntimeMetadata(\n        [_addRuntimeMetadataFunc1, ... ],\n\n        target\n    )\n\n    return {\n        ...state,\n        target: target,\n        runtimeMetadata: runtimeMetadata\n    }\n}\n\nexport let operateWhenRuntime = (state: state): state => {\n    \u4f7f\u7528state.runtimeMetadata...\n\n    return state\n}\n")),(0,r.kt)("p",null,"\u8fd9\u91cc\u5c06\u7cfb\u7edf\u4e2dSystem\u3001Init\u3001OperateWhenRuntime\u8fd9\u4e09\u4e2a\u6a21\u5757\u7684\u62bd\u8c61\u4ee3\u7801\u5408\u5e76\u5230\u4e86System\u7684\u62bd\u8c61\u4ee3\u7801\u4e2d\uff0c\u5176\u4e2dinit\u51fd\u6570\u662fInit\u6a21\u5757\u7684\u51fd\u6570\uff0coperateWhenRuntime\u51fd\u6570\u662fOperateWhenRuntime\u6a21\u5757\u7684\u51fd\u6570"),(0,r.kt)("p",null,"\u503c\u5f97\u6ce8\u610f\u7684\u662f\uff1a",(0,r.kt)("br",{parentName:"p"}),"\n","\u56e0\u4e3a\u8fd9\u91cc\u53ea\u8003\u8651\u4e86\u53ea\u6709\u4e00\u4e2aTarget\u548c\u4e00\u4e2aRuntime Metadata\u7684\u60c5\u51b5\uff0c\u6240\u4ee5init\u51fd\u6570\u4e2d\u6ca1\u6709\u8fdb\u884c\u904d\u5386"),(0,r.kt)("h4",{id:"chunkhandler\u7684\u62bd\u8c61\u4ee3\u7801"},"ChunkHandler\u7684\u62bd\u8c61\u4ee3\u7801"),(0,r.kt)("p",null,"ChunkHandler"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-ts"},"export declare function parseConfig(configJson: JSON): config\n\ntype target = any\n\nexport declare function buildTarget(handleConfigFuncs, parsedConfig: config, targetChunk, someConfigData): target\n\ntype runtimeMetadata = any\n\nexport declare function buildRuntimeMetadata(addRuntimeMetadataFuncs, target: target): runtimeMetadata\n")),(0,r.kt)("p",null,"ChunkHandler\u7684API\u662f\u8fd9\u4e09\u4e2a\u51fd\u6570\uff0c\u8fd9\u91cc\u53ea\u7ed9\u51fa\u4e86\u51fd\u6570\u7b7e\u540d"),(0,r.kt)("h3",{id:"\u9075\u5faa\u7684\u8bbe\u8ba1\u539f\u5219\u5728uml\u4e2d\u7684\u4f53\u73b0"},"\u9075\u5faa\u7684\u8bbe\u8ba1\u539f\u5219\u5728UML\u4e2d\u7684\u4f53\u73b0"),(0,r.kt)("p",null,"\u62fc\u63a5\u6a21\u5f0f\u4e3b\u8981\u9075\u5faa\u4e0b\u9762\u7684\u8bbe\u8ba1\u539f\u5219\uff1a"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"\u5355\u4e00\u804c\u8d23\u539f\u5219",(0,r.kt)("br",{parentName:"li"}),"\u6bcf\u4e2aTarget Chunk\u53ea\u662f\u4e00\u4e2a\u5206\u652f\u7684\u6570\u636e"),(0,r.kt)("li",{parentName:"ul"},"\u5408\u6210\u590d\u7528\u539f\u5219",(0,r.kt)("br",{parentName:"li"}),"Target\u7ec4\u5408\u4e86\u591a\u4e2aTarget Chunk"),(0,r.kt)("li",{parentName:"ul"},"\u4f9d\u8d56\u5012\u7f6e\u539f\u5219",(0,r.kt)("br",{parentName:"li"}),"\u7ec4\u5408Target Chunk\u7684\u987a\u5e8f\u5b9a\u4e49\u5728\u62bd\u8c61\u7684Target Config\u4e2d"),(0,r.kt)("li",{parentName:"ul"},"\u6700\u5c11\u77e5\u8bc6\u539f\u5219",(0,r.kt)("br",{parentName:"li"}),"\u5404\u4e2aRuntimeMetadata\u76f8\u4e92\u72ec\u7acb\uff1b\u5404\u4e2aTarget\u76f8\u4e92\u72ec\u7acb"),(0,r.kt)("li",{parentName:"ul"},"\u5f00\u95ed\u539f\u5219",(0,r.kt)("br",{parentName:"li"}),"\u8981\u6539\u53d8Target Chunk\u7684\u7ec4\u5408\u987a\u5e8f\uff0c\u53ea\u9700\u8981\u4fee\u6539Target Config\uff0c\u65e0\u9700\u4fee\u6539\u4ee3\u7801\uff1b\u8981\u589e\u52a0\u4e00\u79cdTarget\uff0c\u53ea\u9700\u8981\u5728Target Config\u7684targets_config.json\u7684targets\u5b57\u6bb5\u4e2d\u589e\u52a0\u8be5\u79cd\u7c7b\u7684\u914d\u7f6e\u6570\u636e\u3001\u7cfb\u7edf\u589e\u52a0\u5bf9\u5e94\u7684Target Chunk\u3001\u7cfb\u7edf\u7684Init\u589e\u52a0\u5bf9\u5e94\u7684\u521d\u59cb\u5316\u51fd\u6570\uff0c\u65e0\u9700\u4fee\u6539\u4ee3\u7801")),(0,r.kt)("h2",{id:"\u5e94\u7528"},"\u5e94\u7528"),(0,r.kt)("h3",{id:"\u4f18\u70b9"},"\u4f18\u70b9"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"\u7528\u6237\u80fd\u591f\u7075\u6d3b\u5730\u62fc\u63a5Target",(0,r.kt)("br",{parentName:"p"}),"\n","\u7528\u6237\u80fd\u591f\u901a\u8fc7Target Config\u914d\u7f6e\u6587\u4ef6\uff0c\u6307\u5b9a\u62fc\u63a5\u81ea\u5df1\u60f3\u8981\u7684Target")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"\u7cbe\u7b80\u7684Target",(0,r.kt)("br",{parentName:"p"}),"\n","\u62fc\u63a5\u540e\u7684Target\u6ca1\u6709\u5206\u652f\u5224\u65ad\uff0c\u975e\u5e38\u7cbe\u7b80")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"\u63d0\u9ad8\u6027\u80fd",(0,r.kt)("br",{parentName:"p"}),"\n","\u7cfb\u7edf\u80fd\u591f\u5728\u521d\u59cb\u5316\u65f6\u4e00\u6b21\u6027\u4ece\u914d\u7f6e\u6587\u4ef6\u4e2d\u6784\u9020Runtime Metadata\uff0c\u7136\u540e\u5728\u8fd0\u884c\u65f6\u65e0\u9700\u8fdb\u884c\u5206\u652f\u5224\u65ad\uff0c\u800c\u662f\u76f4\u63a5\u904d\u5386Runtime Metadata\uff0c\u901a\u8fc7\u5b83\u7684getData\u3001sendData\u51fd\u6570\u6765\u64cd\u4f5c\u8fd0\u884c\u65f6\u7684\u6570\u636e\uff0c\u4ece\u800c\u63d0\u9ad8\u8fd0\u884c\u65f6\u7684\u6027\u80fd"))),(0,r.kt)("h3",{id:"\u7f3a\u70b9"},"\u7f3a\u70b9"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"Target Config\u7684\u683c\u5f0f\u7531\u7cfb\u7edf\u5b9a\u4e49\uff0c\u7528\u6237\u9700\u8981\u9075\u5b88\u8be5\u683c\u5f0f\u6765\u5199Target Config\u7684\u5185\u5bb9\uff0c\u8fd9\u6837\u4f1a\u6709\u4e00\u4e9b\u9650\u5236")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"\u56e0\u4e3aTarget Chunk\u4f7f\u7528\u4e86\u81ea\u5b9a\u4e49\u7684\u5206\u6bb5\u5b57\u7b26\uff08\u5982@top\uff09\uff0c\u6240\u4ee5\u65e0\u6cd5\u6b63\u786e\u4f7f\u7528\u8be5\u6587\u4ef6\u7684\u7f16\u8bd1\u68c0\u67e5\uff0c\u5982\u65e0\u6cd5\u6b63\u786e\u4f7f\u7528Shader\u7f16\u8bd1\u68c0\u67e5"))),(0,r.kt)("h3",{id:"\u4f7f\u7528\u573a\u666f"},"\u4f7f\u7528\u573a\u666f"),(0,r.kt)("h4",{id:"\u573a\u666f\u63cf\u8ff0"},"\u573a\u666f\u63cf\u8ff0"),(0,r.kt)("p",null,"\u7cfb\u7edf\u9700\u8981\u6784\u9020\u5305\u62ec\u5404\u79cd\u5206\u652f\u7684\u6570\u636e"),(0,r.kt)("h4",{id:"\u5177\u4f53\u6848\u4f8b"},"\u5177\u4f53\u6848\u4f8b"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"\u6784\u9020\u5f15\u64ce\u7684\u7740\u8272\u5668\u4ee3\u7801\uff0c\u5176\u4e2d\u6784\u9020\u7684\u7740\u8272\u5668\u4ee3\u7801\u4e0d\u4ec5\u5305\u62ecGLSL\uff0c\u4e5f\u5305\u62ecHLSL\u3001WGSL\u7b49")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"\u6784\u9020\u6e38\u620f\u7684\u5730\u56fe\u6570\u636e",(0,r.kt)("br",{parentName:"p"}),"\n","\u4e00\u5f20\u5927\u7684\u4e16\u754c\u5730\u56fe\u53ef\u4ee5\u6839\u636e\u5404\u79cd\u5206\u652f\u6761\u4ef6\u6765\u751f\u6210\uff0c\u5176\u4e2d\u5206\u652f\u6761\u4ef6\u53ef\u4ee5\u4e3a\u201c\u662f\u5426\u6709\u6c34\u201d\u3001\u201c\u662f\u5426\u6709\u6811\u201d\u7b49\u3002\u53ef\u4ee5\u5c06\u4e16\u754c\u5730\u56fe\u6309\u7167\u5206\u652f\u5206\u4e3a\u591a\u4e2a\u5c0f\u5757\u6570\u636e\u3002\u5176\u4e2d\uff0c\u5305\u542b\u67d0\u4e9b\u5206\u652f\u7684\u4e00\u4e2a\u4e16\u754c\u5730\u56fe\u662f\u4e00\u4e2aTarget\uff1b\u6bcf\u4e2a\u5c0f\u5757\u6570\u636e\u662f\u4e00\u4e2aTarget Chunk\u3002",(0,r.kt)("br",{parentName:"p"}),"\n","\u53e6\u5916\uff0c\u56e0\u4e3a\u4e16\u754c\u5730\u56fe\u5305\u62ec\u4e86\u4e0d\u540c\u7684\u533a\u57df\uff0c\u56e0\u6b64\u53ef\u4ee5\u901a\u8fc7\u81ea\u5b9a\u4e49\u5b57\u7b26\uff0c\u5c06\u4e00\u4e2a\u5b8c\u6574\u7684Target\u5206\u5272\u4e3a\u4e0d\u540c\u533a\u57df\u7684\u6570\u636e\u3002\u4e00\u4e2aTarget Chunk\u53ef\u4ee5\u5305\u62ec\u591a\u4e2a\u533a\u57df\u7684\u6570\u636e\u3002\u5982\u4e0b\u9762\u662f\u6839\u636e\u201c\u662f\u5426\u6709\u6c34\u201d\u7684\u5206\u652f\u5206\u89e3\u800c\u6210\u7684\u4e24\u4e2aTarget Chunk\u7684\u53c2\u8003\u4ee3\u7801\uff1a",(0,r.kt)("br",{parentName:"p"}),"\n","\u6709\u6c34.map"),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre",className:"language-ts"},"@\u533a\u57df1\n\u6709\u6c34\u7684\u533a\u57df1\u7684\u6570\u636e\n@end\n\n@\u533a\u57df2\n\u6709\u6c34\u7684\u533a\u57df2\u7684\u6570\u636e\n@end\n")),(0,r.kt)("p",{parentName:"li"},"  \u65e0\u6c34.map"),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre",className:"language-ts"},"@\u533a\u57df1\n\u65e0\u6c34\u7684\u533a\u57df1\u7684\u6570\u636e\n@end\n\n@\u533a\u57df2\n\u65e0\u6c34\u7684\u533a\u57df2\u7684\u6570\u636e\n@end\n")),(0,r.kt)("p",{parentName:"li"},"  \u7528\u6237\u8d1f\u8d23\u7ed9\u51faTarget Config\uff0c\u5176\u4e2d\u7684targets_config.json\u5e94\u8be5\u6307\u5b9a\u8981\u6784\u9020\u54ea\u4e9b\u79cd\u7c7b\u7684\u4e16\u754c\u5730\u56fe\u3001\u6bcf\u79cd\u4e16\u754c\u5730\u56fe\u6709\u54ea\u4e9bTarget Chunk\uff1bchunks_config.json\u5e94\u8be5\u6307\u5b9a\u6240\u6709\u7684Target Chunk\u7684\u914d\u7f6e\u6570\u636e"))),(0,r.kt)("h3",{id:"\u6ce8\u610f\u4e8b\u9879"},"\u6ce8\u610f\u4e8b\u9879"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"Target Chunk\u5e94\u8be5\u8fdb\u884c\u4e86\u9002\u5f53\u62bd\u8c61\uff0c\u4ece\u800c\u80fd\u591f\u4fdd\u8bc1\u5728\u7ec4\u5408\u62fc\u63a5\u4e3aTarget\u540e\u662f\u6b63\u786e\u7684",(0,r.kt)("br",{parentName:"p"}),"\n","\u5982\u6709\u4e09\u4e2a\u5c5e\u4e8eVS GLSL\u7684GLSL Chunk\uff1abasic_map_fragment.glsl, no_basic_map_fragment.glsl, basic_end_fragment.glsl\uff0c\u5176\u4e2d\u524d\u4e24\u4e2a\u5206\u522b\u5904\u7406\u6709\u8d34\u56fe\u548c\u6ca1\u6709\u8d34\u56fe\u7684\u60c5\u51b5\uff0c\u7b2c\u4e09\u4e2a\u8d1f\u8d23\u8f93\u51fa\u5230gl_FragColor\u3002\u6211\u4eec\u9700\u8981\u7ec4\u5408\u524d\u4e24\u4e2a\u4e2d\u4efb\u610f\u7684\u4e00\u4e2aGLSL Chunk\u548c\u7b2c\u4e09\u4e2aGLSL Chunk\u3002\u5982\u679c\u6ca1\u6709\u8fdb\u884c\u62bd\u8c61\u7684\u8bdd\uff0c\u524d\u4e24\u4e2a\u7684\u4ee3\u7801\u53ef\u80fd\u662f\uff1a",(0,r.kt)("br",{parentName:"p"}),"\n","basic_map_fragment.glsl"),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre",className:"language-glsl"},"@body\n    vec4 texelColor = texture2D(u_mapSampler, v_mapCoord0);\n\n    \u5bf9texelColor\u8fdb\u884c\u4e00\u4e9b\u5904\u7406...\n@end\n")),(0,r.kt)("p",{parentName:"li"},"  no_basic_map_fragment.glsl"),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre",className:"language-glsl"},"@body\n    vec4 color = vec4(u_color, u_alpha);\n@end\n")),(0,r.kt)("p",{parentName:"li"},"  \u8fd9\u91cc\u7684\u95ee\u9898\u662f\u9700\u8981\u5728basic_end_fragment.glsl\u4e2d\u8f93\u51fa\u989c\u8272\uff0c\u56e0\u4e3a\u8fd9\u4e24\u4e2a\u4e2d\u7684\u989c\u8272\u53d8\u91cf\u540d\u4e0d\u4e00\u6837\uff0c\u6240\u4ee5\u65e0\u6cd5\u7edf\u4e00\u5730\u8f93\u51fa\u989c\u8272\u3002\u56e0\u6b64\u9700\u8981\u8fdb\u884c\u62bd\u8c61\uff0c\u62bd\u8c61\u51fa\u540d\u4e3a\u201ctotalColor\u201d\u53d8\u91cf\u4f5c\u4e3a\u8f93\u51fa\u7684\u989c\u8272\u53d8\u91cf\u3002\u90a3\u4e48\u8fd9\u4e09\u4e2aGLSL Chunk\u7684\u4ee3\u7801\u5c31\u5e94\u8be5\u4fee\u6539\u4e3a\uff1a",(0,r.kt)("br",{parentName:"p"}),"\n","basic_map_fragment.glsl"),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre",className:"language-glsl"},"@body\n    vec4 texelColor = texture2D(u_mapSampler, v_mapCoord0);\n\n    \u5bf9texelColor\u8fdb\u884c\u4e00\u4e9b\u5904\u7406...\n\n    vec4 totalColor = texelColor;\n@end\n")),(0,r.kt)("p",{parentName:"li"},"  no_basic_map_fragment.glsl"),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre",className:"language-glsl"},"@body\n    vec4 totalColor = vec4(u_color, u_alpha);\n@end\n")),(0,r.kt)("p",{parentName:"li"},"  basic_end_fragment.glsl"),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre",className:"language-glsl"},"@body\n    gl_FragColor = totalColor;\n@end\n")),(0,r.kt)("p",{parentName:"li"},"  \u8fd9\u4e09\u4e2aGLSL Chunk\u4e00\u5171\u6709\u4e24\u79cd\u7ec4\u5408\u7684\u60c5\u51b5\uff0c\u5b83\u4eec\u7684\u4ee3\u7801\u5982\u4e0b\uff1a",(0,r.kt)("br",{parentName:"p"}),"\n","basic_map_fragment.glsl+basic_end_fragment.glsl"),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre",className:"language-glsl"},"@body\n    vec4 texelColor = texture2D(u_mapSampler, v_mapCoord0);\n\n    \u5bf9texelColor\u8fdb\u884c\u4e00\u4e9b\u5904\u7406...\n\n    vec4 totalColor = texelColor;\n\n    gl_FragColor = totalColor;\n@end\n")),(0,r.kt)("p",{parentName:"li"},"  no_basic_map_fragment.glsl+basic_end_fragment.glsl"),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre",className:"language-glsl"},"@body\n    vec4 totalColor = vec4(u_color, u_alpha);\n\n    gl_FragColor = totalColor;\n@end\n")),(0,r.kt)("p",{parentName:"li"},"  \u6211\u4eec\u770b\u5230\uff0c\u73b0\u5728\u8fd9\u4e24\u79cd\u7ec4\u5408\u540e\u7684\u4ee3\u7801\u90fd\u80fd\u6b63\u786e\u5c06totalColor\u53d8\u91cf\u8f93\u51fa\u5230gl_FragColor"))),(0,r.kt)("h2",{id:"\u6269\u5c55"},"\u6269\u5c55"),(0,r.kt)("h3",{id:"\u81ea\u5b9a\u4e49target-chunk"},"\u81ea\u5b9a\u4e49Target Chunk"),(0,r.kt)("p",null,"\u73b0\u5728Target Chunk\u662f\u7531\u7cfb\u7edf\u5b9a\u4e49\u7684\uff0c\u7528\u6237\u4e0d\u80fd\u5b9a\u4e49\u81ea\u5df1\u7684Target Chunk\u3002\u6709\u4e0b\u9762\u4e24\u4e2a\u601d\u8def\u6765\u5b9e\u73b0\u7528\u6237\u81ea\u5b9a\u4e49Target Chunk\uff1a",(0,r.kt)("br",{parentName:"p"}),"\n","1.\u6269\u5c55Target Config",(0,r.kt)("br",{parentName:"p"}),"\n","\u5982\u6211\u4eec\u53ef\u4ee5\u5728shader_chunks.json\u7684glsls\u5b57\u6bb5\u4e2d\u589e\u52a0\u503c\u4e3a\u201ccustom_vs\u201d\u548c\u201ccustom_fs\u201d\u7684type\uff0c\u4ece\u800c\u5728content\u5b57\u6bb5\u4e2d\u63d2\u5165\u7528\u6237\u81ea\u5b9a\u4e49\u7684\u5c5e\u4e8eVS GLSL\u6216\u8005FS GLSL\u7684GLSL Chunk\u3002shader_chunks.json\u76f8\u5173\u4ee3\u7801\u5982\u4e0b\uff1a"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-ts"},'  {\n    ...,\n    "glsls": [\n      {\n        "type": "custom_vs",\n        "content":{\n            "top":"xxx",\n            "define":"xxx",\n            "varDeclare":"xxx",\n            "funcDeclare":"xxx",\n            "funcDefine":"xxx",\n            "body":"xxx"\n        }\n      },\n      {\n        "type": "custom_fs",\n        "content":{\n            "top":"xxx",\n            "define":"xxx",\n            "varDeclare":"xxx",\n            "funcDeclare":"xxx",\n            "funcDefine":"xxx",\n            "body":"xxx"\n        }\n      },\n    ],\n    ...\n  },\n')),(0,r.kt)("p",null,"\u8981\u5b9e\u73b0\u8fd9\u4e2a\u6269\u5c55\uff0c\u9700\u8981\u8fdb\u884c\u4e0b\u9762\u7684\u4fee\u6539\uff1a  "),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"\u4fee\u6539ChunkHandler\u7684GLSLConfigType\u4e2dglsls\u7684\u7c7b\u578b\uff0c\u4f7f\u5176\u652f\u6301\u8be5type"),(0,r.kt)("li",{parentName:"ul"},"\u4fee\u6539ChunkHanlder\u7684buildGLSL\u51fd\u6570\u7684\u4f20\u5165\u53c2\u6570\uff0c\u589e\u52a0\u201c\u6765\u81ea\u5f15\u64ce\u7684\u65b0\u7684\u51fd\u6570\u201d\u7684\u4f20\u5165\u53c2\u6570\uff1b\u7136\u540e\u5728ChunkHanlder\u7684buildGLSL\u51fd\u6570\u4e2d\u4f7f\u7528\u4f20\u5165\u7684\u65b0\u51fd\u6570\u6765\u5904\u7406type\u4e3acustom_vs\u3001custom_fs\u7684\u60c5\u51b5")),(0,r.kt)("p",null,"2.\u7cfb\u7edf\u63d0\u4f9b\u589e\u52a0Target Chunk\u7684API\u7ed9\u7528\u6237",(0,r.kt)("br",{parentName:"p"}),"\n","\u5982\u5f15\u64ce\u63d0\u4f9b\u4e0b\u9762\u7684API\uff0c\u6765\u52a0\u5165\u4e00\u4e2aGLSL Chunk\uff1a"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-ts"},"addGLSLChunk(engineState, {top, define, varDeclare, funcDeclare, funcDefine, body}, glslChunkFileName)\n")),(0,r.kt)("p",null,"\u7528\u6237\u5728\u8c03\u7528\u8be5API\u52a0\u5165\u4e00\u4e2aGLSL Chunk\u540e\uff0c\u5c31\u53ef\u4ee5\u5728GLSL Config\u4e2d\u4f7f\u7528\u6587\u4ef6\u540d\u4e3a\u6307\u5b9a\u7684glslChunkFileName\u7684GLSL Chunk"),(0,r.kt)("h3",{id:"\u5728glsl-config\u4e2d\u5b9a\u4e49\u6ca1\u6709\u6750\u8d28\u7684shader\u7684target-glsl"},"\u5728GLSL Config\u4e2d\u5b9a\u4e49\u6ca1\u6709\u6750\u8d28\u7684Shader\u7684Target GLSL"),(0,r.kt)("p",null,"\u4e4b\u524d\u63d0\u5230\u4e86\u6ca1\u6709\u6750\u8d28\u7684Shader\uff0c\u73b0\u5728\u6765\u8ba8\u8bba\u4e00\u4e0b\u5b9e\u73b0\u7684\u7ec6\u8282\u3002\u53ef\u4ee5\u901a\u8fc7\u4e0b\u9762\u7684\u6b65\u9aa4\u6765\u5b9e\u73b0\uff1a",(0,r.kt)("br",{parentName:"p"}),"\n","1.\u6211\u4eec\u53ef\u4ee5\u5c06\u6ca1\u6709\u6750\u8d28\u7684Shader\u5b9a\u4e49\u5728shaders.json\u7684shaders\u5b57\u6bb5\u4e2d\uff0c\u4ee3\u7801\u5982\u4e0b\u6240\u793a\uff1a",(0,r.kt)("br",{parentName:"p"}),"\n","shaders.json"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-ts"},'"shaders": [\n  {\n    "name": "no_material_shader1",\n    "shader_chunks": [\n      ...\n    ]\n  },\n  {\n    "name": "no_material_shader2",\n    "shader_chunks": [\n      ...\n    ]\n  },\n  ...\n]\n')),(0,r.kt)("p",null,"\u8fd9\u91cc\u5b9a\u4e49\u4e86\u4e24\u79cd\u6ca1\u6709\u6750\u8d28\u7684Shader",(0,r.kt)("br",{parentName:"p"}),"\n","2.\u5728\u5f15\u64ce\u7684InitMaterialShader\u6a21\u5757\u4e2d\u589e\u52a0initNoMaterialShader\u51fd\u6570\uff0c\u5e76\u5728Client\u4e2d\u8c03\u7528\u5b83\u6765\u521d\u59cb\u5316\uff0c\u76f8\u5173\u4ee3\u7801\u5982\u4e0b\uff1a",(0,r.kt)("br",{parentName:"p"}),"\n","Client"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-ts"},'state = initNoMaterialShader(state,  "no_material_shader1")\nstate = initNoMaterialShader(state,  "no_material_shader2")\n')),(0,r.kt)("p",null,"\u8fd9\u91ccClient\u8c03\u7528\u4e86\u4e24\u6b21InitMaterialShader\u7684initNoMaterialShader\u51fd\u6570\u6765\u5206\u522b\u521d\u59cb\u5316\u7b2c\u4e00\u79cd\u548c\u7b2c\u4e8c\u79cd\u6ca1\u6709\u6750\u8d28\u7684Shader",(0,r.kt)("br",{parentName:"p"}),"\n","\u201c\u521d\u59cb\u5316\u6ca1\u6709\u6750\u8d28\u7684Shader\u201d\u8ddf\u201c\u521d\u59cb\u5316\u6709\u6750\u8d28\u7684Shader\u201d\u7684\u533a\u522b\u662f\uff1a"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"\u4e0d\u9700\u8981\u201c\u6240\u6709\u7684\u6750\u8d28\u201d\u8fd9\u4e2a\u53c2\u6570\uff1b"),(0,r.kt)("li",{parentName:"ul"},'InitMaterialShader\u7684initNoMaterialShader\u51fd\u6570\u8ddf\u521d\u59cb\u5316\u6709\u6750\u8d28\u7684Shader\u7684\u51fd\u6570\uff08\u5982initBasicMaterialShader\uff09\u5dee\u4e0d\u591a\uff0c\u53ea\u662f\u6ca1\u6709\u904d\u5386allMaterials\uff0c\u4e5f\u65e0\u9700\u751f\u6210shaderIndex\uff0c\u800c\u662f\u53ea\u521b\u5efa\u4e86\u4e00\u4e2aShader\uff08\u4e5f\u5c31\u662f\u4e00\u4e2aProgram\uff09\uff0c\u5c06\u5176\u4fdd\u5b58\u5230EngineState\u7684\u4e00\u4e2aHash Map\u4e2d\uff0c\u5b83\u7684Key\u662fshaderName\uff08\u4e5f\u5c31\u662f  "no_material_shader1"\u6216\u8005  "no_material_shader2"\uff09\uff0cValue\u662f\u521b\u5efa\u7684Shader\uff08\u5177\u4f53\u5c31\u662f\u521b\u5efa\u7684Program\uff09')),(0,r.kt)("p",null,"3.\u9700\u8981\u4f7f\u7528\u6ca1\u6709\u6750\u8d28\u7684Shader\u6765\u6e32\u67d3\uff08\u5982\u7ed8\u5236\u8f6e\u5ed3\uff09\u65f6\uff0c\u76f4\u63a5\u901a\u8fc7EngineState\u7684\u8fd9\u4e2aHash Map\u6765\u62ff\u5230Program\uff0c\u4ee3\u7801\u5982\u4e0b\uff1a"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-ts"},'  let program = getExnFromStrictNull(engineState.noMaterialShaderMap.get("no_material_shader1"))\n\n  gl.useProgram(program)\n\n  ...\n')),(0,r.kt)("h3",{id:"\u6784\u9020dx12vulkanwebgpu\u7b49\u73b0\u4ee3\u56fe\u5f62api\u7684\u7740\u8272\u5668\u4ee3\u7801"},"\u6784\u9020DX12\u3001Vulkan\u3001WebGPU\u7b49\u73b0\u4ee3\u56fe\u5f62API\u7684\u7740\u8272\u5668\u4ee3\u7801"),(0,r.kt)("p",null,"\u6784\u9020\u73b0\u4ee3\u56fe\u5f62API\u7684\u7740\u8272\u5668\u4ee3\u7801\uff08\u5982WebGPU\u7684WGSL\uff09\u4e0e\u6784\u9020GLSL\u7684\u533a\u522b\u4e3b\u8981\u662fSend Metadata\u4e0d\u540c\uff0c\u56e0\u6b64\u53ef\u4ee5\u5728\u6784\u9020GLSL\u6848\u4f8b\u4ee3\u7801\u7684\u57fa\u7840\u4e0a\uff0c\u4fee\u6539\u4e0bSend Metadata\u76f8\u5173\u7684\u4ee3\u7801\u548c\u914d\u7f6e\uff0c\u589e\u52a0\u5bf9UBO\u3001SSBO\u7b49\u65b0\u79cd\u7c7b\u7684\u7740\u8272\u5668\u6570\u636e\u7684\u652f\u6301\uff0c\u5373\u53ef\u5b9e\u73b0\u6784\u9020\u73b0\u4ee3\u56fe\u5f62API\u7684\u7740\u8272\u5668\u4ee3\u7801"),(0,r.kt)("h3",{id:"\u5347\u7ea7\u4e3a\u7740\u8272\u5668\u8bed\u8a00"},"\u5347\u7ea7\u4e3a\u7740\u8272\u5668\u8bed\u8a00"),(0,r.kt)("p",null,"\u53ef\u4ee5\u628aTarget Config\u914d\u7f6e\u6587\u4ef6\u5347\u7ea7\u6210\u65b0\u7684\u7740\u8272\u5668\u8bed\u8a00\uff1b\u628aChunkConverter\u3001ChunkHandler\u5347\u7ea7\u4e3a\u7f16\u8bd1\u5668\uff0c\u8d1f\u8d23\u628a\u65b0\u7684\u7740\u8272\u5668\u8bed\u8a00\u7f16\u8bd1\u4e3aGLSL\u3002\u8fd9\u6837\u505a\u7684\u597d\u5904\u662f\u8ba9\u7528\u6237\u80fd\u591f\u66f4\u52a0\u7075\u6d3b\u5730\u81ea\u5b9a\u4e49\u7740\u8272\u5668\u4ee3\u7801\uff0c\u800c\u4e14\u8fd8\u53ef\u4ee5\u5728\u7f16\u8bd1\u5668\u4e2d\u4f7f\u7528Shader\u7f16\u8bd1\u68c0\u67e5"),(0,r.kt)("h2",{id:"\u6700\u4f73\u5b9e\u8df5"},"\u6700\u4f73\u5b9e\u8df5"),(0,r.kt)("h3",{id:"\u54ea\u4e9b\u573a\u666f\u4e0d\u9700\u8981\u4f7f\u7528\u6a21\u5f0f"},"\u54ea\u4e9b\u573a\u666f\u4e0d\u9700\u8981\u4f7f\u7528\u6a21\u5f0f"),(0,r.kt)("p",null,"\u5982\u679c\u5927\u6570\u636e\u6ca1\u6709\u591a\u5c11\u5206\u652f\uff0c\u90a3\u4e48\u4e0d\u9700\u8981\u4f7f\u7528\u8be5\u6a21\u5f0f\u6765\u5c06\u5176\u5206\u89e3\u3002\u5982\u5bf9\u4e8e\u8def\u5f84\u8ffd\u8e2a\u6e32\u67d3\u800c\u8a00\uff0c\u5b83\u662f\u4e00\u4e2a\u7edf\u4e00\u7684\u6846\u67b6\uff0c\u6ca1\u6709\u4ec0\u4e48\u5206\u652f\u5224\u65ad\uff0c\u56e0\u6b64\u53ea\u9700\u8981\u4e00\u5957\u5927\u7684GLSL\u5373\u53ef\u3002"),(0,r.kt)("p",null,"\u4f46\u662f\uff0c\u56e0\u4e3a\u8fd9\u5957\u5927\u7684GLSL\u7684\u4ee3\u7801\u91cf\u53ef\u80fd\u8fbe\u5230\u4e0a\u4e07\u884c\uff0c\u6240\u4ee5\u53ef\u4ee5\u4f7f\u7528slang\u8fd9\u4e2a\u5f00\u6e90\u9879\u76ee\u63d0\u4f9b\u7684\u66f4\u5bb9\u6613\u7ef4\u62a4\u3001\u66f4\u6a21\u5757\u5316\u7684\u7740\u8272\u5668\u8bed\u8a00\u6765\u5199\u7740\u8272\u5668\u4ee3\u7801\u3002"),(0,r.kt)("p",null,"slang\u76f8\u5f53\u4e8e\u7740\u8272\u5668\u8bed\u8a00\u4e2d\u7684Typescript\uff0c\u5b83\u5728\u539f\u59cb\u7684\u7740\u8272\u5668\u8bed\u8a00\u4e4b\u4e0a\u589e\u52a0\u4e86\u4e00\u5c42\u7f16\u8bd1\u5668\uff0c\u5b9e\u73b0\u4e86\u4e00\u4e2a\u65b0\u7684\u7740\u8272\u5668\u8bed\u8a00\u3002slang\u53ef\u4ee5\u5c06\u5176\u7f16\u8bd1\u4e3aGLSL\u3001HLSL\u7b49\u5404\u79cd\u539f\u59cb\u7684\u7740\u8272\u5668\u8bed\u8a00"),(0,r.kt)("h2",{id:"\u66f4\u591a\u8d44\u6599\u63a8\u8350"},"\u66f4\u591a\u8d44\u6599\u63a8\u8350"),(0,r.kt)("p",null,"slang\u662f\u4e00\u4e2a\u5f00\u6e90\u5e93\uff0c\u53ef\u4ee5\u5728\u7f51\u4e0a\u641c\u7d22\u201cshader-slang/slang\u201d\u6765\u627e\u5230\u5b83\u7684Github Repo"),(0,r.kt)("p",null,"Unity\u5b9e\u73b0\u4e86\u62fc\u63a5\u6a21\u5f0f\u7684\u6269\u5c55\uff0c\u63d0\u51fa\u4e86\u81ea\u5df1\u7684\u7740\u8272\u5668\u8bed\u8a00"))}c.isMDXComponent=!0},3776:(e,n,a)=>{a.d(n,{Z:()=>t});const t=a.p+"assets/images/MaterialShaderGLSL-c8dc8483f828bea24e7b2a06eefd8941.png"},7249:(e,n,a)=>{a.d(n,{Z:()=>t});const t=a.p+"assets/images/MaterialShaderIndexProgram-0c85b1ddfbe02a5b2d99460e9b2dc39d.png"},7576:(e,n,a)=>{a.d(n,{Z:()=>t});const t=a.p+"assets/images/UML-0dd2b5bc29d057cd3cd8616140233736.png"},1732:(e,n,a)=>{a.d(n,{Z:()=>t});const t=a.p+"assets/images/UML-a0958a93553798f9189aef50ffff4ce1.png"},5103:(e,n,a)=>{a.d(n,{Z:()=>t});const t=a.p+"assets/images/UML-16de0fb77fb69672e2a9b35efa49890e.png"}}]);