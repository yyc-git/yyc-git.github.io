<!doctype html>
<html class="docs-version-current" lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.14">
<title data-react-helmet="true">第3章 积木模式 | 3D编程模式</title><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" property="og:url" content="https://github.com/yyc-git/3DProgramPattern/3dProgramPattern/docs/积木模式/"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_version" content="current"><meta data-react-helmet="true" name="docusaurus_tag" content="docs-default-current"><meta data-react-helmet="true" property="og:title" content="第3章 积木模式 | 3D编程模式"><meta data-react-helmet="true" name="description" content="一个开发者开发引擎"><meta data-react-helmet="true" property="og:description" content="一个开发者开发引擎"><link data-react-helmet="true" rel="canonical" href="https://github.com/yyc-git/3DProgramPattern/3dProgramPattern/docs/积木模式/"><link data-react-helmet="true" rel="alternate" href="https://github.com/yyc-git/3DProgramPattern/3dProgramPattern/docs/积木模式/" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://github.com/yyc-git/3DProgramPattern/3dProgramPattern/docs/积木模式/" hreflang="x-default"><link rel="stylesheet" href="/3dProgramPattern/assets/css/styles.e233dcee.css">
<link rel="preload" href="/3dProgramPattern/assets/js/runtime~main.a26eabbf.js" as="script">
<link rel="preload" href="/3dProgramPattern/assets/js/main.c6dc4a90.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div><a href="#" class="skipToContent_OuoZ">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/3dProgramPattern/"><b class="navbar__title">3D编程模式</b></a><a class="navbar__item navbar__link navbar__link--active" href="/3dProgramPattern/docs/前言">内容</a><a href="https://github.com/yyc-git/3DProgramPattern" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></div><div class="navbar__items navbar__items--right"><div class="toggle_iYfV toggle_2i4l toggleDisabled_xj38"><div class="toggleTrack_t-f2" role="button" tabindex="-1"><div class="toggleTrackCheck_mk7D"><span class="toggleIcon_pHJ9">🌜</span></div><div class="toggleTrackX_dm8H"><span class="toggleIcon_pHJ9">🌞</span></div><div class="toggleTrackThumb_W6To"></div></div><input type="checkbox" class="toggleScreenReader_h9qa" aria-label="Switch between dark and light mode"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper docs-wrapper docs-doc-page"><div class="docPage_lDyR"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_i9tI" type="button"></button><aside class="docSidebarContainer_0YBq"><div class="sidebar_a3j0"><nav class="menu thin-scrollbar menu_cyFh"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menuLinkText_OKON">开篇</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/3dProgramPattern/docs/前言">前言</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menuLinkText_OKON">第一部分 第1章 再看设计原则</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/3dProgramPattern/docs/再看设计原则/设计基础/">1.1 设计基础</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/3dProgramPattern/docs/再看设计原则/单一职责原则/">1.2 单一职责原则</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/3dProgramPattern/docs/再看设计原则/合成复用原则/">1.3 合成复用原则</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/3dProgramPattern/docs/再看设计原则/接口隔离原则/">1.4 接口隔离原则</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/3dProgramPattern/docs/再看设计原则/依赖倒置原则/">1.5 依赖倒置原则</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/3dProgramPattern/docs/再看设计原则/最少知识原则/">1.6 最少知识原则</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/3dProgramPattern/docs/再看设计原则/开闭原则/">1.7 开闭原则</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--active menuLinkText_OKON">第二部分 7种编程模式</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/3dProgramPattern/docs/依赖隔离模式/">第2章 依赖隔离模式</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/3dProgramPattern/docs/积木模式/">第3章 积木模式</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/3dProgramPattern/docs/管道模式/">第4章 管道模式</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/3dProgramPattern/docs/ECS模式/">第5章 ECS模式</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/3dProgramPattern/docs/多线程模式/">第6章 多线程模式</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/3dProgramPattern/docs/撤销重做模式/">第7章 撤销重做模式</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/3dProgramPattern/docs/拼接模式/">第8章 拼接模式</a></li></ul></li></ul></nav></div></aside><main class="docMainContainer_r8cw"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_zHA2"><div class="docItemContainer_oiyr"><article><div class="tocCollapsible_aw-L theme-doc-toc-mobile tocMobile_Tx6Y"><button type="button" class="clean-btn tocCollapsibleButton_zr6a">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>第3章 积木模式</h1></header><h2 class="anchor anchorWithStickyNavbar_y2LR" id="一个开发者开发引擎">一个开发者开发引擎<a class="hash-link" href="#一个开发者开发引擎" title="Direct link to heading">​</a></h2><h3 class="anchor anchorWithStickyNavbar_y2LR" id="需求">需求<a class="hash-link" href="#需求" title="Direct link to heading">​</a></h3><p>开发者甲要从零开始，开发一个引擎</p><h3 class="anchor anchorWithStickyNavbar_y2LR" id="实现思路">实现思路<a class="hash-link" href="#实现思路" title="Direct link to heading">​</a></h3><p>首先，甲实现了一个引擎的Demo，使用图形API绘制出了一个最简单的场景；然后，甲从Demo中提炼出了引擎的最基本的框架，实现了初始化、主循环这两个步骤</p><h3 class="anchor anchorWithStickyNavbar_y2LR" id="给出uml">给出UML<a class="hash-link" href="#给出uml" title="Direct link to heading">​</a></h3><p><strong>领域模型</strong></p><p><img alt="领域模型图" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAp8AAAA9CAYAAADrowLEAAAEQ3RFWHRteGZpbGUAJTNDbXhmaWxlJTIwaG9zdCUzRCUyMkVsZWN0cm9uJTIyJTIwbW9kaWZpZWQlM0QlMjIyMDIzLTA1LTE1VDA4JTNBMzMlM0EyNi43NjRaJTIyJTIwYWdlbnQlM0QlMjI1LjAlMjAoTWFjaW50b3NoJTNCJTIwSW50ZWwlMjBNYWMlMjBPUyUyMFglMjAxMV80XzApJTIwQXBwbGVXZWJLaXQlMkY1MzcuMzYlMjAoS0hUTUwlMkMlMjBsaWtlJTIwR2Vja28pJTIwZHJhdy5pbyUyRjE0LjYuMTMlMjBDaHJvbWUlMkY4OS4wLjQzODkuMTI4JTIwRWxlY3Ryb24lMkYxMi4wLjclMjBTYWZhcmklMkY1MzcuMzYlMjIlMjBldGFnJTNEJTIyQ2F4c25vYl9seVRrS0pHMDlKWVQlMjIlMjB2ZXJzaW9uJTNEJTIyMTQuNi4xMyUyMiUyMHR5cGUlM0QlMjJkZXZpY2UlMjIlM0UlM0NkaWFncmFtJTIwaWQlM0QlMjJOR2V5TV9LeGZGLXM2eC1KU2NoYiUyMiUyMG5hbWUlM0QlMjIlRTclQUMlQUMlMjAxJTIwJUU5JUExJUI1JTIyJTNFM1ZaTlQ0TkFFUDAxSERWOHRGU3YwcXFKZW1xaTNzeW1PNFhWWmFmWkRpMzExN3ZJSUNDUmFHTFV5QVgyemR1UDkyWW1peGNsZVhsaHhTYTdRUW5hQzMxWmV0SGNDOE1nOEdQM3FwQkRqWnhNd3hwSXJaSk1hb0dsZWdZR2ZVWUxKV0hiSXhLaUpyWHBneXMwQmxiVXc0UzF1TyUyRlQxcWo3dTI1RUNnTmd1Uko2aU40cFNSbXJDR2N0ZmdrcXpacWRnJTJGaTBqdVNpSWJPU2JTWWs3anRRdFBDaXhDSlMlMkZaV1hDZWpLdk1hWGV0NzVCOUczZzFrdzlKa0p5ZVhzcWp5JTJGdVU3bEF5N3ZuM3hNYnFkSHZNcE82SUlGODJIcDBEZ0EwaG5DUTdTVVlZcEc2RVdMbmxrc2pJUnFHOSUyQk5XczQxNHNhQmdRTWZnZWpBMlJVRm9ZTXl5alZId1RTWkQySTMzSkt3MUFXR1V2bmNXeXpzQ2tiMHNSeTNZQW8wd3B2VXZFcHJad00yOGdJd0I3SUhSN0NnQmFsZHZ6Z0UxMWo2eG12VDRENDRFMSUyRklTampJU3FKVnBmMTliam9lcnRFMG5rWGhtR2M3c0FUbHFNb21HblBwY3U5R3ZuJTJGc2R4NCUyQjVyN3RpMkRHTTdKT1R6U3JmTHROMFQ4djNza25pM2Y2cDRwM01zakt3cVRLd0E4WDd5VDQyOFU3SGRnMFY5YmRZR2glMkYyS2o0MTdyY0RkdnI3elhXJTJCWW1JRmk4JTNEJTNDJTJGZGlhZ3JhbSUzRSUzQyUyRm14ZmlsZSUzRSsfj+EAABrPSURBVHhe7Z0HsBXFEoYHwxOzggnUsjBizqnMASMGxJwtI4JiKnPOYgbBnFEUESNiwoCKWTFhFnMEc068+lbnOGfu2d2z2zuXs/d0V1nvXc5s7+6/29P/9nT3tDPGTDIqikA5EGhXjstsyKtUO2/Ix6IXVQMBtfP8r4XaeX7s9MhWRAAjnzRpkr6vrYi5nioHAu3aRf5InVIO7P49RO08P3Z6ZCshoHYuBlrtXAyhKgiNAHau5DM0yqq/EATUKYlhVKckhlAVhEZA7VyMsNq5GEJVEBoBJZ+hEVb9hSGgTkkMpTolMYSqIDQCaudihNXOxRCqgtAIKPkMjbDqLwwBdUpiKNUpiSFUBaERUDsXI6x2LoZQFYRGQMlnaIRVf2EIqFMSQ6lOSQyhKgiNgNq5GGG1czGEqiA0Ako+QyOs+gtDQJ2SGEp1SmIIVUFoBNTOxQirnYshVAWhEVDyGRph1V8YAuqUxFCqUxJDqApCI6B2LkZY7VwMoSoIjYCSz9AIq/7CEFCnJIZSnZIYQlUQGgG1czHCaudiCFVBaASUfIZGWPUXhoA6JTGU6pTEEKqC0AionYsRVjsXQ6gKQiOg5DM0wqq/MATUKYmhVKckhlAVhEZA7VyMsNq5GEJVEBoBJZ+hEVb9hSGgTkkMpTolMYSqIDQCaudihNXOxRCqgtAIKPkMjbDqLwwBdUpiKNUpiSFUBaERUDsXI6x2LoZQFYRGQMlnaIRVf2EIqFMSQ6lOSQyhKgiNgNq5GGG1czGEqiA0Ako+QyOs+gtDQJ2SGEp1SmIIVUFoBNTOxQirnYshVAWhEVDyGRph1V8YAuqUxFCqUxJDqApCI6B2LkZY7VwMoSoIjYCSz9AIq/7CEFCnJIZSnZIYQlUQGgG1czHCaudiCFVBaASUfIZGWPUXhoA6JTGU6pTEEKqC0AionYsRVjsXQ6gKQiPQ5sjnn3/+aZ566ilz9913m6efftp8+umn5ttvvzWzzTabWXzxxU3Xrl3NYostZnr27GmmnnrqWHy/+eYbM2bMmOj3GWec0ay55pqVsV988YV57rnnor9nmWUWs9pqq4V+TqrfGKNOSfwaNKRTeumll8zHH38surlll13WdO7cWaQj1ME6X2RDVu08G141Rk82O8f/3nfffak3MMUUU5iOHTuaOeec08w333yp4xkwbtw4M378+Gjs/PPPbxZddNG6jtNBjYlAmyKfTzzxhNl///3Nyy+/nIr2wgsvbC655BKzzjrr1Bz74IMPmm7dukW/zTPPPOajjz6qjLv55pvN9ttvH/2NnjfffDP1fDpAjoA6JTGGk80pJV35tttua2655RbRzV177bVm1113FekIdbDOF9mQVTvPhlcjkc/PP//cdOrUKdMN4F932WUXc8ghh0RBojjBt1988cXRzwcccIDp379/pvPo4MZCoM2Qz/PPPz96ebMKL/TAgQNbHNZWyOevv/5qNt54Y/PXX3+ZKaec0tx0003R12YZRZ2S+Kkp+RRDmF2Bks9smKmdZ8Or7OTTXj8rjFdddZXZeuutawLQ1sjn888/bw4++ODoXueee24zZMgQ8YMvk4I2QT4HDBhgDjzwwCrcCcvzEi+zzDLRUvtPP/1k3n//fTN48OAWywJEQPfdd9+q49sK+fzhhx/MTDPNVLm3d955xyywwAJlekcr19rETulQY8xlxpgfhA+uFOST1YSscu6555ru3btnPaxVxiv5zAaz2nl57dyPfJLittBCC1W9AL///rt55ZVXYlNtbrzxRrPDDju0eGnaGvm89957o8AQMscccxjSc5pJSk8+P/nkk2hZ3JXdd9/dQEhnmGGGms/SJZZ2wAsvvGDIG7OSRD7JIX377bejodNPP32UQ9qoouSzUZ9Mpuv6xRgzpTHmXGPM6QIS2vDkc5tttjFDhw7NBE6jDy7TfNEIWDYx+Sy9nfvkk2DPTjvtVPO1oq4CEsoSup8q9+6770Z5na6Q+oZ+hKV93+83wrub5RqUfLYz7YwxDemU6nmQRCwvu4yg0D9y0UUXmd69e6ceOmLEiKpIyT777GMuvfTSushnqvIGGqDks4EeRv5L6WuMOdMYMwW2aow5PycJbUg7d3M+2yL5zP/Ym/PIJiafpbfzLOTTvt0///yz2XvvvQ0RTyt77rmnueKKK9q0ASj5LDH5pPqNCnYryy23nHn22WcNlXT1yOabb27uuuuuaChh788++6xybFLkc9KkSeaPP/6IjuNcU001VeLpyLt8/fXXzauvvhodR87lyiuvnJhczbiJEydGeong2igu1YTcN/ki5HASraXqz78Gxk2YMMFAPt1lTIqy+KJs3759VKlfJmlip8RjmmCM6fjv8/o9JwltGvLJEhZ2+r///c906NAhgo2/qZbFdrAtUnKWXHLJaPWiHvn777/NW2+9FdnfNNNMU3fFbdJ8IbXzpOum04ftJDDddNNF88Dyyy9f9/xYDyYhxqidl9fO85BPa5v4RPy3FVYXF1xwwcrf1C3wH4Lv4z8r1t/xN++6TTV74403os40rD6wlE+FfS2R2gpzA9HasWPHRvMD/pj0NlZFl1pqqapTQra///57A8eg0Aoh35W5BeHauQdfuEcwIUpMkTM+nPmLcyR1DJBiE8LG0VnqZXc3B4Sbueeeeyo5FPUARjumHXfcsTKUJQD7EJPI57BhwwwRGoQH/9prr9U8HQ6OyOytt95a83fOTaR21llnbfE71b9EhBBeUCr7jjrqqKhCv5ZccMEFpm9fPpz/ET+y6x8DUccJl0ma3CnxcFlyd2elrCS0KcgnjoQEfoSPSlJzKCo87rjjoo8xX3beeeeo0CGu9RqT96mnnmrOO++8FsevuOKK5pxzzonytYjWIEceeaQ5+uijK6dJmi+kdl7LftHZp08f8+WXX7b4maVK5gpazTWqqJ2X187zkk/eRdcW+NuvaOdv/CVCoQ72aGXUqFFm/fXXj/4kj3L48OHm8MMPj9LvrPipdfacUluBDMIHLHn07WrDDTc0Z5xxRiWtj/nhrLPOijW/I444wpx5Jgtd/8n9998f1bDUmr8Y1aNHjwibWu3m8mITen4oNfmk9+Zjjz0WYZREAvOAKC04okcoL0QtB+BeD9EISLNfBOQWKay99tpRv9K4l9vqc1MOlHzmeeoNf4wb/XQvtl4S2hTk080DJ6Kw6aabRl0ekoTWaddff32LFQRWDyCnab0Lt9hiC3PHHXdEp+Aj8fTT+U74R5IKjqR27t7TL7/8Yg477DAzaNCg1Bf5tNNOi67zX6KXOr41BzQ5+QTq0tq5hHyyCsCqnO35S//sxx9/vPLqJRUcuf563XXXNTPPPLO57bbbql5bl3wWZSvXXHON2WOPPVLNg3mIVYguXboYyGW/fv1ij4E0W3LKh+8JJ5xQNZ/EHcg5brjhBrPZZptVDcmKTerNFDSg1OST8LT9EiA6eN111xUEi4lC4nn7fBJ+d5cLuCiub6WVVjIkWT/55JNm5MiRlWvlpWG5YZFFFqnpsNybsj3RWIanmb5NG7BjIKkkYxOev/rqqw1GRqTDCtEZokHzzjuv6dWrV2F4tYYidUqmVvTThT6NhDYd+fTfS7piEBUlDQbH4QoRSj8i6Kbm2LF8VPLRiDN74IEHWrz6eclnHjt3j/Hz37nG7bbbLpoPWA7kI9dt5g8WF154YWuYbqZzqJ2X184l5JOXhF69fAQifgV4veSz1suG38SnWx9bhK2wcrjCCitUnY65gUgn7zD2Zj9IGcRqIykAzBmPPPJItDzv/s68gRBs2mCDDaL/T19T7tsK5JwCLlKGSBMcPXp0VYGmXb6fa665KsfUKrD25xoXm0zGKhhcWvIJibO5XNz/8ccfb0466SQBFNWHSsgn4XG71I4B8YKtssoqVSfwlxj8ZQQ3ImIP5CXki8it4mfp4dBD6cTzj/jNtrXgqLBXolEUkQj8TxJjvMSR0IYnn0yuRBqzCATL7ThRqwMGE/qVV15ZVUHL6oS7OxldMvhgs8LEvtZaa1X+5neKEskjtcIKA7lk7nKYlHzmsXOiKjgkd64gHWDaaaet/Bt5Zptssokh79sKZKHR+v4q+YyeTintXEo+jznmmKooH3Zl/V1W8kmuJUVL2IWbUlOUray33nrmoYceqtgSOyoSYHLl5JNPjiKXViCcdmemtIIj7BXSbOcWUnxYgfHT9OAXW265ZeUcpPMRAbVSi3zGYZNl3pWOLS35JOpA8rwVXjKbcyUFhePzkk/fYSXlodKbkGUyhC+Wr776KipkQHzyGRfZpZiBJQb7gkLAIeJWlHwW8TY0lI606Kd7sT4J/Z73pdFEusMRS+oQUCs++WQCp7+ttS33/t1zr7HGGlEkwQqOxBZA2EhnreIkf+lNQj7z2rnrCPnQZbnSLchw5wMiv3a+8HPFG+HdUPIZPYVS2rmUfPqRPop0bVFxFvLJxyhRRvfjy77bRdgKOZhEOK3U6hXOb36QjM48VPYjaeQTX37iiSdWzgE/iNsBipQ7cmKtUGhlo7w++UzCpjXtv7Tkk6/31VdfvYIVxUPkdhUlecknEUy7zO07M//acIhuA16XqPrkM6k5vGtMfpJ2GySfRT3iMuuhH+B/Ia30O6E1w53GmJ7NSD6Ttt4k9/HYY4+NEHS3yv3uu++qukEQcbBLYT7cfq6ahHzmsXPyyt3oJdGYuG2DuXYiuGCCNGLhYSPmoaabWJARpbNzKfl0i/NAlGIeKrqRLOQzzl6LshW/aIjG+XEFiwSD7IoKATJLKNPIJ8E1gmxIWuspoqQEoazceeedldxPn3wmzWVB3uIYpaUln3wR2ZeSeyPf07YtKALAvORzo402qhQnYCxUySYJ1fW1ohA++UwiDW4VIF9Vbt/TNkg+6UvbzFLKiEjSA3OjjxBAf7extIdNXqabY+1HPllm89udWJ2usyNCSiNr6/SWXnrpyql//PHHxJZMOAcq5hEJ+cxj5+R+r7rqqpVrZSc3d1czHz+W5NwoCW1iGonwaeQzemKltHMp+SQ1Zq+99qq8snSRIHUtK/lkR8Na7YqKspWtttqqUtCU9wMuiXwyD7gtI8kTtdX8cfOhW4BNyo1Nx/PJZxw2afNs0b+Xlny67VQAxV9ulgKVl3wSgUircI+7Njdv1SWf5MFRxBQn7GnP3vaIkk/pk2/44+MqYd0LL23OZxFN5n3ySZGNbb3kP103X8oln3H/Hvd2uLldeclnXjunQINCjbzSKM7IXr+SzwiJUtq5lHz6OZJUe9v0kXojn0lbVRZlK6QCkL+JpEUl4+wyiXxCut2iIb/naS2d5J7brh4uD3C5TCNt41la8knjdjefwy8WqGciJirIUpptXEuU0i6t5SGf/jXVcw3uGLe/l0s+STR+5plnlHy2i4KezRz5TIuGaLW7MVFfT3frPZbQ4yKBcSTTzaGqJ7LB3EEfUSQv+cxr535uWNZ5h7y0RtpwQslnatSzYe1cSj5ZbbBbbbofg7zT9ZJP/zjXHoqwFZa33agkgZ+DDjooq9kl5nzi72m6b4VldepCksTtFODmjidxmcwXXeABpSWfYOCGmWH0H374Yc2igji8yBN1e2K5y3N5yCfLV26SPxW2SblX/nVxPxyDKPls+dTUKZW3/1/SnFX09po++UyauOPIpxshcXNB4+6DXn+2dVNrk0+cH6sfVrJ0/cCJkr+WtktbgT4nVZXaeXntXEI+IZ1uqotfv1AE+SzKVtw2jxRJ7bfffqnvtT8gKfLppxXSVsmNhNY6mVv7QV6prbJX8pn50aQf4Ifos1a80y/L7ifLVwVbcNkvmjzkkyt2v9y4PhsNSb+b6hFKPpV8egjoDkd1GlER5JPNK/gYtJKWF+kuw7U2+fQ/olmBqVXZXyd8k31Yk5PPUtu5hHz6zdcffvjhSjCGl7II8lmUrbidMNjNjMLFOCEHm0JChP7atgo9iXyyBafbWYOuG35PUfd85IhCTm3Kn1tkqeQzwJTGtpZLLLFERTPh9vfeey+26sy9BP8rK6k3lh/GT9qxxCW07Hpy++23x945y/28uLbgiKbPXbt2jcYr+VTy6SGge7vXOYcUQT5ZRXH3S3arbv3LoBjJXRJrbfJJw3y3zynNr0kViBMaXA8dOjT6mZ3V3D7BdUIcdFiTk89S23le8glBoyjQ+kLs6euvv66KyBdBPouyFXelg9ZmbBwTJxQDUuiEsMrAVptIWrW7Wz9Cf292PooT2kqRtmPl0UcfrXw8K/kMNF3R389OpJyCZXSWzNy2A/6pCWkTonYLg9jX3SWyeSOfZ599dtVL4vbb8q+DqlO3obbb8FnJp5JPBwGiIcxYUxpjaNRJdRn7N7bcqDzZzhq+yXyIgqM8y+4UOritU3bbbbcWOyJZqN3WRfxba5NPP9c8abc32kIxz9mtev3NLQJN05nUNjH5LL2d5yGffCyyJaa7fTStibArV4ogn0XZCh1l3K4ctfaN59ppewbXsOJGc9PIJ43j7Q5IpBVSOBnXzqlv376mf//+0WkYC5m3NTFKPjNNP/UPpgqMfljuDiPkaFH1xc4GbgsRIo2jRo0y7EDkjqdYgJ0VXMlLPnF09O60xJZen+wx27Fjxyr9L774oqEtkx1Hj1KWBKwURT798D07L9EmoozSxE6Jfn8Qz3Nzkk77uBuefNK42d/2sp53lUiJXaYqIvLJOYk2EKmw4jdkZz7hY9Nui2fHtTb55LxcG0TSypAhQwz71btCL0KWNt3tdilscCMm9WAdeozaeXnt3CefkEhWFV3BbhhHWzP8MelprlD3AGnz238VQT6LspXffvstau9mt6tl5YF2SJ07d67cCr6XAmZ3RzE3JcZvgeR35fC37+SjktRCd4c1TjZ48OCqNpMUS/bu3btyHUo+A85YcXuX4pAIibOUzVcVzVV9gRxiAP4XRV7yiX6IL20PrLBsT/I0S1xEVNiGy7ZGsmP8VgpFkU/0u3mofBXhlNjiK0+SdMDHmKq6iZ0S+6deliPS6WPa8OQz9SWIGbDPPvtEW18iRZFPHAxOhVQeKxA1NrfgHCNHjqz6iLVjJgf59COaXAuRIwoeWQXC0UMEbNNqfu/Tp48ZMGBAXsiDHad2nnlFo2Hs3CefWV8S0kUIwnTq1KnFoUWRz6JspZafJ+2O/uO0Sho4cGDV3MHf7j7tpBW4QSnunSgp/Txt1x1/VYXtgPHfXbp0MRMnToyIrdvXG/8+fvz4qh6nSj6zvoUZx5PHRBjcDd2nqSBJmDyKWpWeEvJJ8i/bZrLvej0yfPhw06NHj6qhRZJP8kptnok9ST3tY+q59tYc08ROqSiY2yz5dPvaFUU+AZ0OGFTjJ80rrLRQDGCLF/0ChKQc8SLtnGvt3r17JRqT9NLwUc4SYPv27Yt6twrTo3YuhnKy2bmEfBIh5QPS7uXuo1AU+bR2LbUVihBZNXX3bo97cn5NiR3nFi7Zf4OTsOqCQGJ79uxZFT2NOwd9gtnZyG5Hascp+RTbU7oClpX4krf7pccdQfSCl3zZZZeNVQqZtW2S/ObPLF2zdI8QGaHwqZaw/yuh8rim8+Sn4qhwBL645+Brh72a48StEuzVq5cZNGhQ1VAa1PMl5UZwlHymv09tcMRkc0pJWLrNkfNi7r73vgNM2p1oxIgREWFD4pq8s1TWr18/Q462S0KxfSriTznllKja1S5nsxTvzkFJ80WRds49kPZD/ldc6gKREZbnKW6stQNMXvyLPE7JpxjNyWbnEyZMMLPPPntdN8CKIB9uEDB2NWJlMEl4Z22k3s9VTvLXcTqLshVWQIhQ1vLz2Bu7DTHH1QpyufNPLfLJv7Fayhzjpye490Xwih3WavXrzYNNXQ9QOKjUfT7j7h0SCtGi2IfqNh4eYWqcBUvwrTnp4ri4hrFjx5oPPvggytcgL4SlO3dLQOFzTD2crzTwoKE094+jTSrKSlU4GQaoUxKDPtmckvjKG0QBuwHZ3UfcecTtVVqrWKK1L58d4IiEMu8wH7K8xxzYrVu3FjljrX1taedTO09DKPV3tfNUiP4bUIStsNqJf8feSHGhpRI+lrZKaW3PSO+hCJr/pX8oNSO1jmGZncJo/mNpnXEs8cNrOnTokOGOG2NomySfjQGtXkXRCKhTEiOqTikDhGPGjDEUDSC0gbF7TNdS4bZFqWcf5gyX0XRD1c7Fj1ztXAyhKgiNgJLP0Air/sIQUKckhlKdUgYI3cbxbkGTr+Lyyy83/G4Fwupu/ZvhlDqU/XN1G13pe6B2LkVQjw+OgJLP4BDrCYpCQJ2SGEl1ShkgpM2STfznMKpwaYlmheVscjbdVjLkfrHsrpIfAbXz/Nj9e6TauRhCVRAaASWfoRFW/YUhoE5JDKU6pQwQjhs3rkXlKPlV7HxEsYLbvw+1tHajZRpL8Cr5EVA7z4+dkk8xdqqglRBQ8tlKQOtp5AioUxJjqOQzI4SjR482a621VupRFBcMGzYssYNGqhIdECGgdi5+EdTOxRCqgtAIKPkMjbDqLwwBdUpiKNUp5YCQDhG0MaEnJx0j3P2n2V2NZXcaP7v7u+c4jR7yLwJq5+JXQe1cDKEqCI2Aks/QCKv+whBQpySGUp2SGEJjaLdEz760FioFnKopVaidix+72rkYQlUQGgEln6ERVv2FIaBOSQylOiUxhKogNAJq52KE1c7FEKqC0Ago+QyNsOovDAF1SmIo1SmJIVQFoRFQOxcjrHYuhlAVhEZAyWdohFV/YQioUxJDqU5JDKEqCI2A2rkYYbVzMYSqIDQCSj5DI6z6C0NAnZIYSnVKYghVQWgE1M7FCKudiyFUBaERUPIZGmHVXxgC6pTEUKpTEkOoCkIjoHYuRljtXAyhKgiNgJLP0Air/sIQUKckhlKdkhhCVRAaAbVzMcJq52IIVUFoBJR8hkZY9ReGgDolMZTqlMQQqoLQCKidixFWOxdDqApCI6DkMzTCqr8wBNQpiaFUpySGUBWERkDtXIyw2rkYQlUQGgEln6ERVv2FIaBOSQylOiUxhKogNAJq52KE1c7FEKqC0Ago+QyNsOovDAF1SmIo1SmJIVQFoRFQOxcjrHYuhlAVhEagQj5Dn0j1KwIFIdCuID3NqGZSM9603nMpEVA7z//Y1M7zY6dHtiIC/wcZe4IP1a1oXwAAAABJRU5ErkJggg=="></p><p>总体来看，领域模型分为用户、引擎这两个部分</p><p>我们看下用户这个部分：</p><p>Client是用户</p><p>我们看下引擎这个部分：</p><p>Engine是引擎的入口模块，提供API给Client</p><p>Director负责初始化和主循环</p><h3 class="anchor anchorWithStickyNavbar_y2LR" id="给出代码">给出代码<a class="hash-link" href="#给出代码" title="Direct link to heading">​</a></h3><p>首先，我们依次看下每个模块的代码，它们包括：</p><ul><li>Client的代码；</li><li>Engine和Director的代码；</li></ul><p>最后，我们运行Client的代码</p><h4 class="anchor anchorWithStickyNavbar_y2LR" id="client的代码">Client的代码<a class="hash-link" href="#client的代码" title="Direct link to heading">​</a></h4><p>Client</p><div class="codeBlockContainer_J+bg language-ts theme-code-block"><div class="codeBlockContent_csEI ts"><pre tabindex="0" class="prism-code language-ts codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">Engine</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">DirectorAPI</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">init</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Engine</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">DirectorAPI</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">loop</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>我们通过Engine的API来调用了Director的init和loop函数，实现引擎的初始化和主循环</p><h4 class="anchor anchorWithStickyNavbar_y2LR" id="engine和director的代码">Engine和Director的代码<a class="hash-link" href="#engine和director的代码" title="Direct link to heading">​</a></h4><p>Engine</p><div class="codeBlockContainer_J+bg language-ts theme-code-block"><div class="codeBlockContent_csEI ts"><pre tabindex="0" class="prism-code language-ts codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">export</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> DirectorAPI </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    init</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> Director</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">init</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    loop</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> Director</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">loop</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>Director</p><div class="codeBlockContainer_J+bg language-ts theme-code-block"><div class="codeBlockContent_csEI ts"><pre tabindex="0" class="prism-code language-ts codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">export</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> </span><span class="token function-variable function" style="color:#d73a49">init</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token builtin">console</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">log</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;初始化&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">export</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> </span><span class="token function-variable function" style="color:#d73a49">loop</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token builtin">console</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">log</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;主循环&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h4 class="anchor anchorWithStickyNavbar_y2LR" id="运行client的代码">运行Client的代码<a class="hash-link" href="#运行client的代码" title="Direct link to heading">​</a></h4><p>下面，我们运行Client的代码，打印的结果如下：</p><div class="codeBlockContainer_J+bg language-js theme-code-block"><div class="codeBlockContent_csEI js"><pre tabindex="0" class="prism-code language-js codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">初始化</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">主循环</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h2 class="anchor anchorWithStickyNavbar_y2LR" id="加入更多的开发者一起开发引擎">加入更多的开发者一起开发引擎<a class="hash-link" href="#加入更多的开发者一起开发引擎" title="Direct link to heading">​</a></h2><h3 class="anchor anchorWithStickyNavbar_y2LR" id="概述解决方案">概述解决方案<a class="hash-link" href="#概述解决方案" title="Direct link to heading">​</a></h3><p>为了加快开发进度，甲找了另外三个开发者乙、丙、丁一起来开发引擎。他们的分工如下：</p><ul><li>甲继续开发Engine和Director；</li><li>乙负责实现实现一个数学库，实现矩阵计算之类的数学计算逻辑；</li><li>丙负责实现场景的管理；</li><li>丁负责实现渲染</li></ul><h3 class="anchor anchorWithStickyNavbar_y2LR" id="给出uml-1">给出UML<a class="hash-link" href="#给出uml-1" title="Direct link to heading">​</a></h3><p><strong>领域模型</strong></p><p><img alt="领域模型图" src="/3dProgramPattern/assets/images/UML-588d5cc26409ad2b033deb3c29ddb206.png"></p><p>总体来看，领域模型分为用户、引擎这两个部分</p><p>我们看下用户这个部分：</p><p>Client是用户</p><p>我们看下引擎这个部分：</p><p>Engine和Director的职责跟之前一样，并且由甲继续开发</p><p>我们介绍新加入的引擎模块，他们由分别由一个新的开发者负责开发：</p><ul><li>SceneManager负责场景的管理，由丙负责开发</li><li>Render负责渲染，由丁负责开发</li><li>Math负责数学计算，由乙负责开发</li></ul><p>我们来看下依赖关系：</p><p>Engine依赖Director、SceneManager，封装它们来提供初始化、主循环和管理场景的API</p><p>Director依赖SceneManager、Render，在初始化时分别通过它们来初始化场景和初始化渲染，在主循环时分别通过它们来更新场景和渲染</p><p>Render依赖SceneManager，在渲染时通过它获得场景数据</p><p>SceneManager、Render依赖Math，通过它来进行数学计算</p><h3 class="anchor anchorWithStickyNavbar_y2LR" id="给出代码-1">给出代码<a class="hash-link" href="#给出代码-1" title="Direct link to heading">​</a></h3><p>首先，我们看下Client的代码</p><p>然后，我们看下Engine的代码</p><p>然后，我们依次看下Client代码中每个步骤的代码，它们包括：</p><ul><li>创建EngineState的代码</li><li>创建场景的代码</li><li>初始化的代码</li><li>主循环的代码</li></ul><p>最后，我们运行Client的代码</p><h4 class="anchor anchorWithStickyNavbar_y2LR" id="client的代码-1">Client的代码<a class="hash-link" href="#client的代码-1" title="Direct link to heading">​</a></h4><p>Client</p><div class="codeBlockContainer_J+bg language-ts theme-code-block"><div class="codeBlockContent_csEI ts"><pre tabindex="0" class="prism-code language-ts codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> state </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> Engine</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">DirectorAPI</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">createState</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">state </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> Engine</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">SceneAPI</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">createScene</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">state</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">state </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> Engine</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">DirectorAPI</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">init</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">state</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Engine</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">DirectorAPI</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">loop</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">state</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>Client首先创建了EngineState，用来保存引擎的所有数据；然后创建了场景；然后初始化；最后主循环</p><h4 class="anchor anchorWithStickyNavbar_y2LR" id="engine的代码">Engine的代码<a class="hash-link" href="#engine的代码" title="Direct link to heading">​</a></h4><p>Engine</p><div class="codeBlockContainer_J+bg language-ts theme-code-block"><div class="codeBlockContent_csEI ts"><pre tabindex="0" class="prism-code language-ts codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">export</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> DirectorAPI </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    createState</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> Director</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">createState</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    init</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> Director</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">init</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    loop</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> Director</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">loop</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">export</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> SceneAPI </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    createScene</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> SceneManager</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">createScene</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>Engine负责提供API给Client</p><h4 class="anchor anchorWithStickyNavbar_y2LR" id="创建enginestate的代码">创建EngineState的代码<a class="hash-link" href="#创建enginestate的代码" title="Direct link to heading">​</a></h4><p>Director</p><div class="codeBlockContainer_J+bg language-ts theme-code-block"><div class="codeBlockContent_csEI ts"><pre tabindex="0" class="prism-code language-ts codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">export</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> createState </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> state </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        scene</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> SceneManager</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">createState</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>createState函数创建的EngineState保存了创建的SceneManagerState，其中SceneManagerState负责保存场景数据。我们看下创建SceneManagerState的代码：<br>
<!-- -->SceneManager</p><div class="codeBlockContainer_J+bg language-ts theme-code-block"><div class="codeBlockContent_csEI ts"><pre tabindex="0" class="prism-code language-ts codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">export</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> createState </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> sceneManagerState </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> allGameObjects</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>createState函数创建了SceneManagerState，它包括保存场景中所有的gameObject的容器</p><h4 class="anchor anchorWithStickyNavbar_y2LR" id="创建场景的代码">创建场景的代码<a class="hash-link" href="#创建场景的代码" title="Direct link to heading">​</a></h4><p>SceneManager</p><div class="codeBlockContainer_J+bg language-ts theme-code-block"><div class="codeBlockContent_csEI ts"><pre tabindex="0" class="prism-code language-ts codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">export</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> </span><span class="token function-variable function" style="color:#d73a49">createScene</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">state</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> state</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token builtin">console</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">log</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;创建场景&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">//创建一个假的gameObject</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> sceneGameObject </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token operator" style="color:#393A34">...</span><span class="token plain">state</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        scene</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token operator" style="color:#393A34">...</span><span class="token plain">state</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">scene</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token comment" style="color:#999988;font-style:italic">//通过concat而不是push来加入，保持immutable</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            allGameObjects</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> state</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">scene</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">allGameObjects</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">concat</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">sceneGameObject</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>createScene函数创建了场景，场景中只有一个gameObject。这里具体是创建了一个假的gameObject，并将其加入到SceneManagerState的allGameObjects中</p><h4 class="anchor anchorWithStickyNavbar_y2LR" id="初始化的代码">初始化的代码<a class="hash-link" href="#初始化的代码" title="Direct link to heading">​</a></h4><p>Director</p><div class="codeBlockContainer_J+bg language-ts theme-code-block"><div class="codeBlockContent_csEI ts"><pre tabindex="0" class="prism-code language-ts codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">export</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> </span><span class="token function-variable function" style="color:#d73a49">init</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">state</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    state </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> SceneManager</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">init</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">state</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    state </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> Render</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">init</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">state</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> state</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>init函数实现了初始化，调用了SceneManager的init函数来初始化场景，以及调用了Render的init函数来初始化渲染。我们看下相关代码：<br>
<!-- -->SceneManager</p><div class="codeBlockContainer_J+bg language-ts theme-code-block"><div class="codeBlockContent_csEI ts"><pre tabindex="0" class="prism-code language-ts codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">export</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> </span><span class="token function-variable function" style="color:#d73a49">init</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">state</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> state</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token builtin">console</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">log</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;初始化场景&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> state</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>Render</p><div class="codeBlockContainer_J+bg language-ts theme-code-block"><div class="codeBlockContent_csEI ts"><pre tabindex="0" class="prism-code language-ts codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">export</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> </span><span class="token function-variable function" style="color:#d73a49">init</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">state</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> state</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token builtin">console</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">log</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;初始化渲染&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> state</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h4 class="anchor anchorWithStickyNavbar_y2LR" id="主循环的代码">主循环的代码<a class="hash-link" href="#主循环的代码" title="Direct link to heading">​</a></h4><p>Director</p><div class="codeBlockContainer_J+bg language-ts theme-code-block"><div class="codeBlockContent_csEI ts"><pre tabindex="0" class="prism-code language-ts codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">//假实现</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> </span><span class="token function-variable function" style="color:#d73a49">requestAnimationFrame</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">func</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">export</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> </span><span class="token function-variable function" style="color:#d73a49">loop</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">state</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> state</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    state </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> SceneManager</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">update</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">state</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    state </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> Render</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">render</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">state</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">requestAnimationFrame</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">time</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token function" style="color:#d73a49">loop</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">state</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>loop函数实现了主循环，调用了SceneManager的update函数来更新场景，以及调用了Render的render函数来渲染。我们看下更新场景的相关代码：<br>
<!-- -->SceneManager</p><div class="codeBlockContainer_J+bg language-ts theme-code-block"><div class="codeBlockContent_csEI ts"><pre tabindex="0" class="prism-code language-ts codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">export</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> </span><span class="token function-variable function" style="color:#d73a49">update</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">state</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> state</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token builtin">console</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">log</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;更新场景&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> _ </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> Math</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">multiplyMatrix</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> state</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>Math</p><div class="codeBlockContainer_J+bg language-ts theme-code-block"><div class="codeBlockContent_csEI ts"><pre tabindex="0" class="prism-code language-ts codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">export</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> </span><span class="token function-variable function" style="color:#d73a49">multiplyMatrix</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">mat1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> mat2</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token builtin">console</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">log</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;计算&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>SceneManager的update函数实现了更新场景，调用了Math的multiplyMatrix函数来计算</p><p>我们看下渲染的相关代码：<br>
<!-- -->Render</p><div class="codeBlockContainer_J+bg language-ts theme-code-block"><div class="codeBlockContent_csEI ts"><pre tabindex="0" class="prism-code language-ts codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">export</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> </span><span class="token function-variable function" style="color:#d73a49">render</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">state</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> state</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> allGameObjects </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> SceneManager</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getAllGameObjects</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">state</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token builtin">console</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">log</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;处理场景数据&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> _ </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> Math</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">multiplyMatrix</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token builtin">console</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">log</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;渲染&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> state</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>SceneManager</p><div class="codeBlockContainer_J+bg language-ts theme-code-block"><div class="codeBlockContent_csEI ts"><pre tabindex="0" class="prism-code language-ts codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">export</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> </span><span class="token function-variable function" style="color:#d73a49">getAllGameObjects</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">state</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> state</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> state</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">scene</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">allGameObjects</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>Render的render函数实现了渲染，调用了SceneManger的getAllGameObjects函数来获得场景中所有的gameObjects，以及调用了Math的multiplyMatrix函数来计算</p><h4 class="anchor anchorWithStickyNavbar_y2LR" id="运行client的代码-1">运行Client的代码<a class="hash-link" href="#运行client的代码-1" title="Direct link to heading">​</a></h4><p>下面，我们运行Client的代码，打印的结果如下：</p><div class="codeBlockContainer_J+bg language-js theme-code-block"><div class="codeBlockContent_csEI js"><pre tabindex="0" class="prism-code language-js codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">创建场景</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">//初始化</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">初始化场景</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">初始化渲染</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">//主循环</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">更新场景</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">计算</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">处理场景数据</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">计算</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">渲染</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h3 class="anchor anchorWithStickyNavbar_y2LR" id="提出问题">提出问题<a class="hash-link" href="#提出问题" title="Direct link to heading">​</a></h3><ul><li><p>模块之间互相依赖，导致团队开发效率的降低和沟通成本的增加<br>
<!-- -->因为这四个开发者实现的模块互相依赖，所以可能会出现下面的情况：  </p><ul><li><p>一个开发者修改了自己的代码，如果该代码是被其它开发者实现的模块依赖，则会影响到它们  </p></li><li><p>一个开发者可能需要修改其它开发者的代码，如实现Render的丁可能需要修改丙实现的SceneManager的代码，使其能提供某些特定的场景数据  </p><p>这些情况都会造成在开发者合并自己的代码时出现大量的冲突</p></li></ul></li></ul><h2 class="anchor anchorWithStickyNavbar_y2LR" id="使用积木模式来改进">使用积木模式来改进<a class="hash-link" href="#使用积木模式来改进" title="Direct link to heading">​</a></h2><h3 class="anchor anchorWithStickyNavbar_y2LR" id="概述解决方案-1">概述解决方案<a class="hash-link" href="#概述解决方案-1" title="Direct link to heading">​</a></h3><ul><li><p>将每个模块改为一个独立的积木，互相之间只依赖于抽象的协议<br>
<!-- -->积木包括积木实现和积木协议两个部分，其中积木协议是接口，定义了积木的服务的类型和积木的数据的类型；积木实现是对积木协议的实现。<br>
<!-- -->积木的服务就是多个实现该积木的逻辑的函数；积木的数据是一个state，它保存了该积木所有的数据。<br>
<!-- -->每个积木之间依赖的是抽象的积木协议而不是具体的积木实现</p></li><li><p>大家首先一起定义好各个积木的协议，然后每个开发者只独立开发自己的积木实现，互相之间通过积木协议交互</p></li></ul><h3 class="anchor anchorWithStickyNavbar_y2LR" id="给出uml-2">给出UML<a class="hash-link" href="#给出uml-2" title="Direct link to heading">​</a></h3><p><strong>领域模型</strong></p><p><img alt="领域模型图" src="/3dProgramPattern/assets/images/UML-fc137295c4f8111f6f133d9b1cd465c0.png"></p><p>总体来看，领域模型分为用户、BlockFacade、BlockManager、Engine Blocks这四个部分</p><p>我们看下用户这个部分：</p><p>Client是用户</p><p>我们看下BlockFacade、BlockManager这两个部分：</p><p>BlockFacade是门户，提供了管理积木的API，其中init函数负责注册所有使用的积木</p><p>BlockManager负责实现管理积木，提供了注册积木、获得积木的服务和state等函数。BlockManager有一个BlockManagerState，用来保存所有的积木</p><p>我们看下Engine Blocks这个部分：</p><p>整个引擎由积木组成，它们都在这个部分中。之前的各个引擎模块都对应地改为积木了，其中Engine改为Engine Block，Director改为Director Block，SceneManager改为SceneManager Block，Render改为Render Block，Math改为Math Block</p><p>积木包括积木实现和积木协议这两个部分，其中积木实现的模块名以“Implement”结尾，积木协议的模块名以“Protocol”结尾，如Engine Block Implement是积木实现，Engine Block Protocol是积木协议。积木实现是对积木协议的实现，如Engine Block Implement实现了Engine Block Protocol。各个积木实现的逻辑不变，仍然是之前的引擎模块的逻辑。积木协议的state定义了积木的数据的类型，积木协议的service定义了积木的服务的类型</p><p>在所有的积木中，需要定义一个积木作为入口。入口积木向Client提供了调用其它积木的API。Engine Block就是入口积木，其中Engine Block Implement是入口积木的积木实现，Engine Block Protocol是入口积木的积木协议。Client调用入口积木的步骤如下：<br>
<!-- -->1.Client调用BlockFacade的getEntryBlockProtocolName函数来获得入口积木的积木协议名<br>
<!-- -->2.将其传给BlockFacade的getBlockService函数来获得入口积木的服务，从而使用它提供的API</p><p>我们来看下依赖关系：</p><p>各个积木实现之间没有直接依赖，而是依赖抽象的积木协议，如Engine Block Implement没有依赖Director Block Implement，而是依赖它实现的积木协议：Directo Block Protocol</p><h3 class="anchor anchorWithStickyNavbar_y2LR" id="结合uml图描述如何具体地解决问题">结合UML图，描述如何具体地解决问题<a class="hash-link" href="#结合uml图描述如何具体地解决问题" title="Direct link to heading">​</a></h3><ul><li>因为不同积木之间只依赖于积木协议，所以只要积木协议不修改，积木之间就不会互相影响。因此每个开发者只需要关注自己开发的积木实现，互相不影响，从而提升了团队的开发效率，降低了团队的沟通成本</li></ul><h3 class="anchor anchorWithStickyNavbar_y2LR" id="给出代码-2">给出代码<a class="hash-link" href="#给出代码-2" title="Direct link to heading">​</a></h3><p>首先，我们看下Client的代码<br>
<!-- -->然后，我们看下Client的代码中第一个步骤的代码：</p><ul><li><p>初始化积木的代码<br>
<!-- -->然后，我们看下初始化积木中每个步骤的相关代码，它们包括：</p><ul><li>创建BlockManagerState的代码</li><li>BlockManager的registerBlock函数的相关代码</li><li>积木实现的两个函数的代码</li></ul></li></ul><p>然后，我们继续看下Client的代码中剩余的每个步骤的代码，它们包括：</p><ul><li>获得入口积木的服务的代码</li><li>创建场景的代码</li><li>初始化的代码</li><li>主循环的代码</li></ul><p>最后，我们运行Client的代码</p><h4 class="anchor anchorWithStickyNavbar_y2LR" id="client的代码-2">Client的代码<a class="hash-link" href="#client的代码-2" title="Direct link to heading">​</a></h4><p>Client</p><div class="codeBlockContainer_J+bg language-ts theme-code-block"><div class="codeBlockContent_csEI ts"><pre tabindex="0" class="prism-code language-ts codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> blockManagerState </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> BlockFacade</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">init</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">//获得了入口积木（Engine Block）的服务</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> director</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> scene </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> BlockFacade</span><span class="token punctuation" style="color:#393A34">.</span><span class="token generic-function function" style="color:#d73a49">getBlockService</span><span class="token generic-function generic class-name operator" style="color:#393A34">&lt;</span><span class="token generic-function generic class-name">service</span><span class="token generic-function generic class-name operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">blockManagerState</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> BlockFacade</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getEntryBlockProtocolName</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">blockManagerState </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> scene</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">createScene</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">blockManagerState</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">blockManagerState </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> director</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">init</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">blockManagerState</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">director</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">loop</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">blockManagerState</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>Client首先调用BlockFacade的init函数初始化积木；然后调用BlockFacade的getEntryBlockProtocolName函数来获得入口积木的积木协议（Engine Block Protocol）的协议名，将其传给BlockFacade的getBlockService函数来获得入口积木（Engine Block）的服务；然后调用服务的scene的createScene函数，创建了场景；然后调用服务的director的init函数，实现初始化；最后调用服务的director的loop函数，实现主循环</p><h4 class="anchor anchorWithStickyNavbar_y2LR" id="初始化积木的代码">初始化积木的代码<a class="hash-link" href="#初始化积木的代码" title="Direct link to heading">​</a></h4><p>BlockFacade</p><div class="codeBlockContainer_J+bg language-ts theme-code-block"><div class="codeBlockContent_csEI ts"><pre tabindex="0" class="prism-code language-ts codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">export</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> init </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> blockManagerState </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> blockManagerState </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> BlockManager</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">createState</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    blockManagerState </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> BlockManager</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">registerBlock</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        blockManagerState</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token string" style="color:#e3116c">&quot;engine_block_protocol&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        EngineBlockImplement</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">getBlockService</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        EngineBlockImplement</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">createBlockState</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    blockManagerState </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> BlockManager</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">registerBlock</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        blockManagerState</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token string" style="color:#e3116c">&quot;director_block_protocol&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        DirectorBlockImplement</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">getBlockService</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        DirectorBlockImplement</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">createBlockState</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    blockManagerState </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> BlockManager</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">registerBlock</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        blockManagerState</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token string" style="color:#e3116c">&quot;sceneManager_block_protocol&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        SceneManagerBlockImplement</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">getBlockService</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        SceneManagerBlockImplement</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">createBlockState</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    blockManagerState </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> BlockManager</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">registerBlock</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        blockManagerState</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token string" style="color:#e3116c">&quot;render_block_protocol&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        RenderBlockImplement</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">getBlockService</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        RenderBlockImplement</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">createBlockState</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    blockManagerState </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> BlockManager</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">registerBlock</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        blockManagerState</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token string" style="color:#e3116c">&quot;math_block_protocol&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        MathBlockImplement</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">getBlockService</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        MathBlockImplement</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">createBlockState</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> blockManagerState</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>init函数实现了初始化积木，它首先调用BlockManager的createState函数创建BlockManagerState；然后多次调用BlockManager的registerBlock函数，注册了Engine Blocks中所有的积木。其中，在调用BlockManager的registerBlock函数时传入了BlockManagerState、积木协议名、获得积木的服务的函数、积木的state</p><h4 class="anchor anchorWithStickyNavbar_y2LR" id="创建blockmanagerstate的代码">创建BlockManagerState的代码<a class="hash-link" href="#创建blockmanagerstate的代码" title="Direct link to heading">​</a></h4><p>BlockManager</p><div class="codeBlockContainer_J+bg language-ts theme-code-block"><div class="codeBlockContent_csEI ts"><pre tabindex="0" class="prism-code language-ts codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">export</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> createState </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> blockManagerState </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        blockServiceMap</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">Map</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        blockStateMap</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">Map</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>createState函数创建了BlockManagerState，它包括一个保存所有积木的服务的Hash Map和一个保存所有积木的state的Hash Map，它们的Key是积木协议名，Value分别是积木的服务和积木的state</p><h4 class="anchor anchorWithStickyNavbar_y2LR" id="blockmanager的registerblock函数的相关代码">BlockManager的registerBlock函数的相关代码<a class="hash-link" href="#blockmanager的registerblock函数的相关代码" title="Direct link to heading">​</a></h4><p>BlockManager</p><div class="codeBlockContainer_J+bg language-ts theme-code-block"><div class="codeBlockContent_csEI ts"><pre tabindex="0" class="prism-code language-ts codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">export</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> getBlockServiceExn </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">blockService</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">blockManagerState</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> blockManagerState</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> blockProtocolName</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> blockProtocolName</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> blockService </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">getExnFromStrictUndefined</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">blockManagerState</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">blockServiceMap</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">blockProtocolName</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">export</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> getBlockStateExn </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">blockState</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">blockManagerState</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> blockManagerState</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> blockProtocolName</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> blockProtocolName</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> blockState </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">getExnFromStrictUndefined</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">blockManagerState</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">blockStateMap</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">blockProtocolName</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">export</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> setBlockState </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">blockState</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">blockManagerState</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> blockManagerState</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> blockProtocolName</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> blockProtocolName</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> blockState</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> blockState</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> blockManagerState </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token operator" style="color:#393A34">...</span><span class="token plain">blockManagerState</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        blockStateMap</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> blockManagerState</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">blockStateMap</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">set</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">blockProtocolName</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> blockState</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> _buildAPI </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> api </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        getBlockService</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> getBlockServiceExn</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        getBlockState</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> getBlockStateExn</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        setBlockState</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> setBlockState</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">export</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> registerBlock </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">blockService</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> blockState</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">blockManagerState</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> blockManagerState</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> blockProtocolName</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> blockProtocolName</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> getBlockService</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> getBlockService</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">blockService</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    blockState</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> blockState</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> blockManagerState </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    blockManagerState </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token operator" style="color:#393A34">...</span><span class="token plain">blockManagerState</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        blockServiceMap</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> blockManagerState</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">blockServiceMap</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">set</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">blockProtocolName</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">getBlockService</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token function" style="color:#d73a49">_buildAPI</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    blockManagerState </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">setBlockState</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">blockManagerState</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> blockProtocolName</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> blockState</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> blockManagerState</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>registerBlock函数实现了注册积木，它首先通过传入的getBlockService函数获得积木的服务，将其保存在BlockManagerState的blockServiceMap中；最后将传入的积木的state保存在BlockManagerState的blockStateMap中</p><p>registerBlock函数在调用传入的getBlockService函数时，注入了_buildAPI函数构造的BlockManager的api，从而使得该积木能在它的服务中通过它们来调用依赖的其它积木的服务和state，如Engine Block能通过它们调用SceneManagerBlock的服务和state</p><h4 class="anchor anchorWithStickyNavbar_y2LR" id="积木实现的两个函数的代码">积木实现的两个函数的代码<a class="hash-link" href="#积木实现的两个函数的代码" title="Direct link to heading">​</a></h4><p>BlockFacade的init函数在调用BlockManager的registerBlock函数注册积木时，调用了该积木的积木实现的两个函数：getBlockService、createBlockState。我们以Engine Block Implement为例，来看下它的两个函数的相关代码：<br>
<!-- -->Engine Block Implement</p><div class="codeBlockContainer_J+bg language-ts theme-code-block"><div class="codeBlockContent_csEI ts"><pre tabindex="0" class="prism-code language-ts codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">//获得积木的服务</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">export</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> getBlockService</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">...</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">api</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">//返回服务</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        director</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token function-variable function" style="color:#d73a49">init</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">blockManagerState</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token operator" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token function-variable function" style="color:#d73a49">loop</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">blockManagerState</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token operator" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        scene</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token function-variable function" style="color:#d73a49">createScene</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">blockManagerState</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token operator" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">//创建积木的state</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">export</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> createBlockState</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">...</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">//state为null</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">null</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>getBlockService函数实现了Engine Block Protocol定义的服务。createBlockState函数创建了Engine Block Protocol定义的state。其中，getBlockService函数的形参是注入的BlockManager的api。我们看下Engine Block Protocol对应的代码：<br>
<!-- -->Engine Block Protocol-&gt;ServiceType</p><div class="codeBlockContainer_J+bg language-ts theme-code-block"><div class="codeBlockContent_csEI ts"><pre tabindex="0" class="prism-code language-ts codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> </span><span class="token class-name">directorAPI</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function-variable function" style="color:#d73a49">init</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">blockManagerState</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> blockManagerState</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> blockManagerState</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function-variable function" style="color:#d73a49">loop</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">blockManagerState</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> blockManagerState</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> </span><span class="token class-name">sceneAPI</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function-variable function" style="color:#d73a49">createScene</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">blockManagerState</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> blockManagerState</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> blockManagerState</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">export</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> </span><span class="token class-name">service</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    director</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> directorAPI</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    scene</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> sceneAPI</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>Engine Block Protocol-&gt;StateType</p><div class="codeBlockContainer_J+bg language-ts theme-code-block"><div class="codeBlockContent_csEI ts"><pre tabindex="0" class="prism-code language-ts codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">export</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> </span><span class="token class-name">state</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">null</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>Engine Block Protocol在ServiceType.ts文件中定义了服务的类型，在StateType.ts文件中定义了state的类型</p><h4 class="anchor anchorWithStickyNavbar_y2LR" id="获得入口积木的服务的代码">获得入口积木的服务的代码<a class="hash-link" href="#获得入口积木的服务的代码" title="Direct link to heading">​</a></h4><p>Client调用了BlockFacade的函数，获得了入口积木的服务。我们看下BlockFacade的相关代码：<br>
<!-- -->BlockFacade</p><div class="codeBlockContainer_J+bg language-ts theme-code-block"><div class="codeBlockContent_csEI ts"><pre tabindex="0" class="prism-code language-ts codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">//获得Engine Block Protocol的协议名</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">export</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> </span><span class="token function-variable function" style="color:#d73a49">getEntryBlockProtocolName</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;engine_block_protocol&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">export</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> getBlockService </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">blockService</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">blockManagerState</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> blockManagerState</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> blockProtocolName</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> blockProtocolName</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> BlockManager</span><span class="token punctuation" style="color:#393A34">.</span><span class="token generic-function function" style="color:#d73a49">getBlockServiceExn</span><span class="token generic-function generic class-name operator" style="color:#393A34">&lt;</span><span class="token generic-function generic class-name">blockService</span><span class="token generic-function generic class-name operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">blockManagerState</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> blockProtocolName</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>BlockFacade的getBlockService函数通过BlockManager的getBlockServiceExn函数获得了注册的积木的服务。Client通过指定BlockFacade的getBlockService函数的形参blockProtocolName为Engine Block Protocol的协议名，从而获得了Engine Block的服务</p><h4 class="anchor anchorWithStickyNavbar_y2LR" id="创建场景的代码-1">创建场景的代码<a class="hash-link" href="#创建场景的代码-1" title="Direct link to heading">​</a></h4><p>Client调用了Engine Block的服务，创建了场景。我们看下Engine Block的相关代码：<br>
<!-- -->Engine Block Implement</p><div class="codeBlockContainer_J+bg language-ts theme-code-block"><div class="codeBlockContent_csEI ts"><pre tabindex="0" class="prism-code language-ts codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">export</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> getBlockService</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">...</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">api</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token operator" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        scene</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token function-variable function" style="color:#d73a49">createScene</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">blockManagerState</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token comment" style="color:#999988;font-style:italic">//依赖于SceneManager Block Protocol来调用SceneManager Block的服务的createScene函数</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> createScene </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> api</span><span class="token punctuation" style="color:#393A34">.</span><span class="token generic-function function" style="color:#d73a49">getBlockService</span><span class="token generic-function generic class-name operator" style="color:#393A34">&lt;</span><span class="token generic-function generic class-name">sceneManagerService</span><span class="token generic-function generic class-name operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">blockManagerState</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;sceneManager_block_protocol&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token comment" style="color:#999988;font-style:italic">//因为createScene函数返回了新的SceneManager Block的state，所以调用BlockManager的api的setBlockState将其保存到BlockManagerState中，并返回新的BlockManagerState</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> api</span><span class="token punctuation" style="color:#393A34">.</span><span class="token generic-function function" style="color:#d73a49">setBlockState</span><span class="token generic-function generic class-name operator" style="color:#393A34">&lt;</span><span class="token generic-function generic class-name">sceneManagerState</span><span class="token generic-function generic class-name operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    blockManagerState</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token string" style="color:#e3116c">&quot;sceneManager_block_protocol&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token function" style="color:#d73a49">createScene</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">api</span><span class="token punctuation" style="color:#393A34">.</span><span class="token generic-function function" style="color:#d73a49">getBlockState</span><span class="token generic-function generic class-name operator" style="color:#393A34">&lt;</span><span class="token generic-function generic class-name">sceneManagerState</span><span class="token generic-function generic class-name operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">blockManagerState</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;sceneManager_block_protocol&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>Engine Block的服务的scene的createScene函数调用了Scene Manager Block的服务和state来创建场景</p><p>值得注意的是：<br>
<!-- -->Engine Block Implement依赖Scene Manager Block的积木协议（SceneManager Block Protocol）而不是积木实现（Scene Manager Block Implement）。只要积木协议（SceneManager Block Protocol）不变，那么不管这个积木实现（SceneManager Block Implement）如何改变，都不会影响到Engine Block Implement。<br>
<!-- -->其中，“积木协议不变”是指两个方面：<br>
<!-- -->1.积木协议名不变<br>
<!-- -->如调用api的getBlockService函数时传入的“sceneManager_block_protocol”这个Scene Manager Block Protocol名，它是该协议的package.json的name，是固定不变的<br>
<!-- -->2.积木协议定义的服务、state的类型不变<br>
<!-- -->它们的类型一般不会变化，比较稳定</p><p>我们看下SceneManager Block的相关代码：<br>
<!-- -->SceneManager Block Implement</p><div class="codeBlockContainer_J+bg language-ts theme-code-block"><div class="codeBlockContent_csEI ts"><pre tabindex="0" class="prism-code language-ts codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">export</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> getBlockService</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">...</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">...</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function-variable function" style="color:#d73a49">createScene</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">sceneManagerState</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token builtin">console</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">log</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;创建场景&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> sceneGameObject </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token operator" style="color:#393A34">...</span><span class="token plain">sceneManagerState</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                allGameObjects</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> sceneManagerState</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">allGameObjects</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">concat</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">sceneGameObject</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token operator" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">export</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> createBlockState</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">...</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        allGameObjects</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>SceneManager Block Protocol-&gt;ServiceType</p><div class="codeBlockContainer_J+bg language-ts theme-code-block"><div class="codeBlockContent_csEI ts"><pre tabindex="0" class="prism-code language-ts codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">export</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> </span><span class="token class-name">service</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function-variable function" style="color:#d73a49">createScene</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">sceneManagerState</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> sceneManagerState</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>SceneManager Block Protocol-&gt;StateType</p><div class="codeBlockContainer_J+bg language-ts theme-code-block"><div class="codeBlockContent_csEI ts"><pre tabindex="0" class="prism-code language-ts codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> </span><span class="token class-name">gameObject</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token builtin">any</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">export</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> </span><span class="token class-name">allGameObjects</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token builtin">Array</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">gameObject</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">export</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> </span><span class="token class-name">state</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    allGameObjects</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> allGameObjects</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>SceneManager Block的state和服务的逻辑分别跟之前的SceneManager模块的SceneManagerState和逻辑一样，没有变化</p><h4 class="anchor anchorWithStickyNavbar_y2LR" id="初始化的代码-1">初始化的代码<a class="hash-link" href="#初始化的代码-1" title="Direct link to heading">​</a></h4><p>Client调用了Engine Block的服务，实现初始化。我们看下Engine Block的相关代码：<br>
<!-- -->Engine Block Implement</p><div class="codeBlockContainer_J+bg language-ts theme-code-block"><div class="codeBlockContent_csEI ts"><pre tabindex="0" class="prism-code language-ts codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">export</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> getBlockService</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">...</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">api</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        director</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token function-variable function" style="color:#d73a49">init</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">blockManagerState</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token comment" style="color:#999988;font-style:italic">//依赖于Director Block Protocol来调用Director Block的服务的init函数</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> init </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> api</span><span class="token punctuation" style="color:#393A34">.</span><span class="token generic-function function" style="color:#d73a49">getBlockService</span><span class="token generic-function generic class-name operator" style="color:#393A34">&lt;</span><span class="token generic-function generic class-name">directorService</span><span class="token generic-function generic class-name operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">blockManagerState</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;director_block_protocol&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">init</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">blockManagerState</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token operator" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>Engine Block的服务的director的init函数调用了Director Block的服务来实现初始化。我们看下Director Block的相关代码：<br>
<!-- -->Director Block Implement</p><div class="codeBlockContainer_J+bg language-ts theme-code-block"><div class="codeBlockContent_csEI ts"><pre tabindex="0" class="prism-code language-ts codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">export</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> getBlockService</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">...</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">api</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function-variable function" style="color:#d73a49">init</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">blockManagerState</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token comment" style="color:#999988;font-style:italic">//依赖于SceneManager Block Protocol来调用SceneManager Block的服务的init函数</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> sceneManagerService </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> api</span><span class="token punctuation" style="color:#393A34">.</span><span class="token generic-function function" style="color:#d73a49">getBlockService</span><span class="token generic-function generic class-name operator" style="color:#393A34">&lt;</span><span class="token generic-function generic class-name">sceneManagerService</span><span class="token generic-function generic class-name operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">blockManagerState</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;sceneManager_block_protocol&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            blockManagerState </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> sceneManagerService</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">init</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">blockManagerState</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token comment" style="color:#999988;font-style:italic">//依赖于Render Block Protocol来调用Render Block的服务的init函数</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> renderService </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> api</span><span class="token punctuation" style="color:#393A34">.</span><span class="token generic-function function" style="color:#d73a49">getBlockService</span><span class="token generic-function generic class-name operator" style="color:#393A34">&lt;</span><span class="token generic-function generic class-name">renderService</span><span class="token generic-function generic class-name operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">blockManagerState</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;render_block_protocol&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            blockManagerState </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> renderService</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">init</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">blockManagerState</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> blockManagerState</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token operator" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">export</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> createBlockState</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">...</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">null</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>Director Block Protocol-&gt;ServiceType</p><div class="codeBlockContainer_J+bg language-ts theme-code-block"><div class="codeBlockContent_csEI ts"><pre tabindex="0" class="prism-code language-ts codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">export</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> </span><span class="token class-name">service</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function-variable function" style="color:#d73a49">init</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">blockManagerState</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> blockManagerState</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> blockManagerState</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>Director Block Protocol-&gt;StateType</p><div class="codeBlockContainer_J+bg language-ts theme-code-block"><div class="codeBlockContent_csEI ts"><pre tabindex="0" class="prism-code language-ts codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">export</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> </span><span class="token class-name">state</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">null</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>Director Block的服务的init函数调用了SceneManager Block和Render Block的服务，相关代码如下：<br>
<!-- -->SceneManager Block Implement</p><div class="codeBlockContainer_J+bg language-ts theme-code-block"><div class="codeBlockContent_csEI ts"><pre tabindex="0" class="prism-code language-ts codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">export</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> getBlockService</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">...</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">api</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token operator" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function-variable function" style="color:#d73a49">init</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">blockManagerState</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token builtin">console</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">log</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;初始化场景&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> blockManagerState</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token operator" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>SceneManager Block Protocol-&gt;ServiceType</p><div class="codeBlockContainer_J+bg language-ts theme-code-block"><div class="codeBlockContent_csEI ts"><pre tabindex="0" class="prism-code language-ts codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">export</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> </span><span class="token class-name">service</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function-variable function" style="color:#d73a49">init</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">blockManagerState</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> blockManagerState</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> blockManagerState</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>Render Block Implement</p><div class="codeBlockContainer_J+bg language-ts theme-code-block"><div class="codeBlockContent_csEI ts"><pre tabindex="0" class="prism-code language-ts codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">export</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> getBlockService</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">...</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">...</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function-variable function" style="color:#d73a49">init</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">blockManagerState</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token builtin">console</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">log</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;初始化渲染&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> blockManagerState</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token operator" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>Render Block Protocol-&gt;ServiceType</p><div class="codeBlockContainer_J+bg language-ts theme-code-block"><div class="codeBlockContent_csEI ts"><pre tabindex="0" class="prism-code language-ts codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">export</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> </span><span class="token class-name">service</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function-variable function" style="color:#d73a49">init</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">blockManagerState</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> blockManagerState</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> blockManagerState</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>同样的，Director Block的服务、SceneManager Block的服务、Render Block服务的逻辑跟之前的SceneManager、Render模块的逻辑一样，没有变化。不过Director Block的state变为null了</p><h4 class="anchor anchorWithStickyNavbar_y2LR" id="主循环的代码-1">主循环的代码<a class="hash-link" href="#主循环的代码-1" title="Direct link to heading">​</a></h4><p>Client调用了Engine Block的服务，实现主循环。我们看下Engine Block的相关代码：<br>
<!-- -->Engine Block Implement</p><div class="codeBlockContainer_J+bg language-ts theme-code-block"><div class="codeBlockContent_csEI ts"><pre tabindex="0" class="prism-code language-ts codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">export</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> getBlockService</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">...</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">api</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        director</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token operator" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token function-variable function" style="color:#d73a49">loop</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">blockManagerState</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token comment" style="color:#999988;font-style:italic">//依赖于Director Block Protocol来调用Director Block的服务的loop函数</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> loop </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> api</span><span class="token punctuation" style="color:#393A34">.</span><span class="token generic-function function" style="color:#d73a49">getBlockService</span><span class="token generic-function generic class-name operator" style="color:#393A34">&lt;</span><span class="token generic-function generic class-name">directorService</span><span class="token generic-function generic class-name operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">blockManagerState</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;director_block_protocol&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">loop</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">blockManagerState</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>Engine Block的服务的director的loop函数调用了Director Block的服务来实现主循环。我们看下Director Block的相关代码：<br>
<!-- -->Director Block Implement</p><div class="codeBlockContainer_J+bg language-ts theme-code-block"><div class="codeBlockContent_csEI ts"><pre tabindex="0" class="prism-code language-ts codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">//假实现</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> </span><span class="token function-variable function" style="color:#d73a49">requestAnimationFrame</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">func</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> </span><span class="token function-variable function" style="color:#d73a49">_loop</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">api</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> api</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> blockManagerState</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> blockManagerState</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> sceneManagerBlockProtocolName</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> blockProtocolName</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> renderBlockProtocolName</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> blockProtocolName</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">//依赖于SceneManager Block Protocol来调用SceneManager Block的服务的update函数</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> sceneManagerService </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> api</span><span class="token punctuation" style="color:#393A34">.</span><span class="token generic-function function" style="color:#d73a49">getBlockService</span><span class="token generic-function generic class-name operator" style="color:#393A34">&lt;</span><span class="token generic-function generic class-name">sceneManagerService</span><span class="token generic-function generic class-name operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">blockManagerState</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> sceneManagerBlockProtocolName</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    blockManagerState </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> sceneManagerService</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">update</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">blockManagerState</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">//依赖于Render Block Protocol来调用Render Block的服务的render函数</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> renderService </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> api</span><span class="token punctuation" style="color:#393A34">.</span><span class="token generic-function function" style="color:#d73a49">getBlockService</span><span class="token generic-function generic class-name operator" style="color:#393A34">&lt;</span><span class="token generic-function generic class-name">renderService</span><span class="token generic-function generic class-name operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">blockManagerState</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> renderBlockProtocolName</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    blockManagerState </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> renderService</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">render</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">blockManagerState</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">requestAnimationFrame</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">time</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token function" style="color:#d73a49">_loop</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">api</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> blockManagerState</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> sceneManagerBlockProtocolName</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> renderBlockProtocolName</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">export</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> getBlockService</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">...</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">api</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token operator" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function-variable function" style="color:#d73a49">loop</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">blockManagerState</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token function" style="color:#d73a49">_loop</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">api</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> blockManagerState</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;sceneManager_block_protocol&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;render_block_protocol&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>Director Block Protocol-&gt;ServiceType</p><div class="codeBlockContainer_J+bg language-ts theme-code-block"><div class="codeBlockContent_csEI ts"><pre tabindex="0" class="prism-code language-ts codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">export</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> </span><span class="token class-name">service</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function-variable function" style="color:#d73a49">loop</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">blockManagerState</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> blockManagerState</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>Director Block的服务的loop函数调用了SceneManager Block和Render Block的服务，相关代码如下：<br>
<!-- -->SceneManager Block Implement</p><div class="codeBlockContainer_J+bg language-ts theme-code-block"><div class="codeBlockContent_csEI ts"><pre tabindex="0" class="prism-code language-ts codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">export</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> getBlockService</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">...</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">api</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token operator" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function-variable function" style="color:#d73a49">getAllGameObjects</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">sceneManagerState</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> sceneManagerState</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">allGameObjects</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token operator" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function-variable function" style="color:#d73a49">update</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">blockManagerState</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token builtin">console</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">log</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;更新场景&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token comment" style="color:#999988;font-style:italic">//依赖于Math Block Protocol来调用Math Block的服务的multiplyMatrix函数</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> multiplyMatrix </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> api</span><span class="token punctuation" style="color:#393A34">.</span><span class="token generic-function function" style="color:#d73a49">getBlockService</span><span class="token generic-function generic class-name operator" style="color:#393A34">&lt;</span><span class="token generic-function generic class-name">mathService</span><span class="token generic-function generic class-name operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">blockManagerState</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;math_block_protocol&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> _ </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">multiplyMatrix</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> blockManagerState</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>SceneManager Block Protocol-&gt;ServiceType</p><div class="codeBlockContainer_J+bg language-ts theme-code-block"><div class="codeBlockContent_csEI ts"><pre tabindex="0" class="prism-code language-ts codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">export</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> </span><span class="token class-name">service</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function-variable function" style="color:#d73a49">getAllGameObjects</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">sceneManagerState</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> allGameObjects</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function-variable function" style="color:#d73a49">update</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">blockManagerState</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> blockManagerState</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> blockManagerState</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>Render Block</p><div class="codeBlockContainer_J+bg language-ts theme-code-block"><div class="codeBlockContent_csEI ts"><pre tabindex="0" class="prism-code language-ts codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">export</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> getBlockService</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">...</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">api</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token operator" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function-variable function" style="color:#d73a49">render</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">blockManagerState</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token comment" style="color:#999988;font-style:italic">//依赖于SceneManager Block Protocol来调用SceneManager Block的服务的getAllGameObjects函数</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> getAllGameObjects </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> api</span><span class="token punctuation" style="color:#393A34">.</span><span class="token generic-function function" style="color:#d73a49">getBlockService</span><span class="token generic-function generic class-name operator" style="color:#393A34">&lt;</span><span class="token generic-function generic class-name">sceneManagerService</span><span class="token generic-function generic class-name operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">blockManagerState</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;sceneManager_block_protocol&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> allGameObjects </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">getAllGameObjects</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">api</span><span class="token punctuation" style="color:#393A34">.</span><span class="token generic-function function" style="color:#d73a49">getBlockState</span><span class="token generic-function generic class-name operator" style="color:#393A34">&lt;</span><span class="token generic-function generic class-name">sceneManagerState</span><span class="token generic-function generic class-name operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">blockManagerState</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;sceneManager_block_protocol&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token builtin">console</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">log</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;处理场景数据&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token comment" style="color:#999988;font-style:italic">//依赖于Math Block Protocol来调用Math Block的服务的multiplyMatrix函数</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> multiplyMatrix </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> api</span><span class="token punctuation" style="color:#393A34">.</span><span class="token generic-function function" style="color:#d73a49">getBlockService</span><span class="token generic-function generic class-name operator" style="color:#393A34">&lt;</span><span class="token generic-function generic class-name">mathService</span><span class="token generic-function generic class-name operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">blockManagerState</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;math_block_protocol&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> _ </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">multiplyMatrix</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token builtin">console</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">log</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;渲染&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> blockManagerState</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>SceneManager Block的服务的update函数和Render Block的服务的render函数调用了Math Block的服务，相关代码如下：<br>
<!-- -->Math Block Implement</p><div class="codeBlockContainer_J+bg language-ts theme-code-block"><div class="codeBlockContent_csEI ts"><pre tabindex="0" class="prism-code language-ts codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">export</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> getBlockService</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">...</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">api</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function-variable function" style="color:#d73a49">multiplyMatrix</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">mat1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> mat2</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token builtin">console</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">log</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;计算&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">export</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> createBlockState</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">...</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">null</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>Math Block Protocol-&gt;ServiceType</p><div class="codeBlockContainer_J+bg language-ts theme-code-block"><div class="codeBlockContent_csEI ts"><pre tabindex="0" class="prism-code language-ts codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> </span><span class="token class-name">matrix</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token builtin">any</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">export</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> </span><span class="token class-name">service</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function-variable function" style="color:#d73a49">multiplyMatrix</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">mat1</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> matrix</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> mat2</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> matrix</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> matrix</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>Math Block Protocol-&gt;StateType</p><div class="codeBlockContainer_J+bg language-ts theme-code-block"><div class="codeBlockContent_csEI ts"><pre tabindex="0" class="prism-code language-ts codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">export</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> </span><span class="token class-name">state</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">null</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>同样的，这几个Block的服务的逻辑跟之前对应的模块的逻辑一样，没有变化</p><h4 class="anchor anchorWithStickyNavbar_y2LR" id="运行client的代码-2">运行Client的代码<a class="hash-link" href="#运行client的代码-2" title="Direct link to heading">​</a></h4><p>我们运行Client的代码，打印的结果跟之前一样</p><h2 class="anchor anchorWithStickyNavbar_y2LR" id="定义">定义<a class="hash-link" href="#定义" title="Direct link to heading">​</a></h2><h3 class="anchor anchorWithStickyNavbar_y2LR" id="一句话定义">一句话定义<a class="hash-link" href="#一句话定义" title="Direct link to heading">​</a></h3><p>系统由积木搭建而成</p><h3 class="anchor anchorWithStickyNavbar_y2LR" id="补充说明">补充说明<a class="hash-link" href="#补充说明" title="Direct link to heading">​</a></h3><p>将系统的每个模块离散化为一个积木</p><p>积木之间依赖于抽象的协议而不是具体的实现</p><h3 class="anchor anchorWithStickyNavbar_y2LR" id="通用uml">通用UML<a class="hash-link" href="#通用uml" title="Direct link to heading">​</a></h3><p><strong>领域模型</strong></p><p><img alt="领域模型图" src="/3dProgramPattern/assets/images/UML-2477f5b11c57ff31a458c3f03adc7c63.png"></p><p>总体来看，领域模型分为用户、BlockFacade、BlockManager、System Blocks四个部分</p><p>我们看下用户这个部分：</p><ul><li>Client<br>该角色是用户</li></ul><p>我们看下BlockFacade、BlockManager这两个部分：</p><ul><li><p>BlockFacade<br>
<!-- -->该角色是门户，提供了管理积木的API，其中init函数负责注册所有使用的积木</p></li><li><p>BlockManager<br>
<!-- -->该角色负责实现管理积木，提供了注册积木、获得积木的服务和state等函数。该角色有一个BlockManagerState，用来保存所有的积木</p></li></ul><p>我们看下System Blocks这个部分：</p><p>整个系统由积木组成，它们都在这个部分中</p><ul><li><p>Entry Block Protocol<br>
<!-- -->该角色为入口积木的积木协议，它的state定义了积木的数据的类型，它的service定义了积木的服务的类型</p></li><li><p>Entry Block Implement<br>
<!-- -->该角色为入口积木的积木实现，它有一个BlockState数据和两个函数，其中getBlockService函数返回了实现的服务，createBlockState函数创建了blockState</p></li><li><p>Block Protocol<br>
<!-- -->该角色为其它积木的积木协议，它的成员跟Entry Block Protocol一样</p></li><li><p>Block Implement<br>
<!-- -->该角色为其它积木的积木实现，它的成员跟Entry Block一样，图中省略了它们</p></li></ul><p><strong>角色之间的关系</strong></p><ul><li><p>一个积木包括积木实现和积木协议这两个部分</p></li><li><p>System Blocks中有且只有一个入口积木</p></li><li><p>因为多个积木实现可以实现同一个积木协议，所以Entry Block Implement和Entry Block Protocol、Block Implement和Block Protocol都是多对一的关系</p></li></ul><ul><li><p>各个积木实现之间没有直接依赖，而是依赖抽象的积木协议</p></li><li><p>因为入口积木依赖多个其它积木，所以Entry Block Implement和Block Protocol是一对多的依赖关系</p></li><li><p>其它积木不能依赖入口积木</p></li><li><p>因为其它积木可以通过多个其它积木协议来依赖多个其它积木，所以Block Implement和Block Protocol是一对多的依赖关系</p></li><li><p>因为BlockManager通过registerBlock函数注册了多个积木，所以BlockManager与System Blocks中的积木是一对多的组合关系</p></li></ul><h3 class="anchor anchorWithStickyNavbar_y2LR" id="角色的抽象代码">角色的抽象代码<a class="hash-link" href="#角色的抽象代码" title="Direct link to heading">​</a></h3><p>下面我们来看看各个角色的抽象代码：</p><p>我们依次看下领域模型中各个部分的抽象代码：</p><p>首先，我们看下Client的抽象代码<br>
<!-- -->然后，我们看下BlockFacade的抽象代码<br>
<!-- -->然后，我们看下BlockManager的抽象代码<br>
<!-- -->最后，我们看下System Blocks这个部分的抽象代码，它们包括：</p><ul><li>Entry Block Protocol的抽象代码</li><li>Entry Block的抽象代码</li><li>Block Protocol的抽象代码</li><li>Block的抽象代码</li></ul><h4 class="anchor anchorWithStickyNavbar_y2LR" id="client的抽象代码">Client的抽象代码<a class="hash-link" href="#client的抽象代码" title="Direct link to heading">​</a></h4><p>Client</p><div class="codeBlockContainer_J+bg language-ts theme-code-block"><div class="codeBlockContent_csEI ts"><pre tabindex="0" class="prism-code language-ts codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> blockManagerState </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> BlockFacade</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">init</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> entryBlockService </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> BlockFacade</span><span class="token punctuation" style="color:#393A34">.</span><span class="token generic-function function" style="color:#d73a49">getBlockService</span><span class="token generic-function generic class-name operator" style="color:#393A34">&lt;</span><span class="token generic-function generic class-name">service</span><span class="token generic-function generic class-name operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">blockManagerState</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> BlockFacade</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getEntryBlockProtocolName</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">调用entryBlockService</span><span class="token operator" style="color:#393A34">...</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h4 class="anchor anchorWithStickyNavbar_y2LR" id="blockfacade的抽象代码">BlockFacade的抽象代码<a class="hash-link" href="#blockfacade的抽象代码" title="Direct link to heading">​</a></h4><p>BlockFacade</p><div class="codeBlockContainer_J+bg language-ts theme-code-block"><div class="codeBlockContent_csEI ts"><pre tabindex="0" class="prism-code language-ts codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">export</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> init </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> blockManagerState </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> blockManagerState </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> BlockManager</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">createState</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    blockManagerState </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> BlockManager</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">registerBlock</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        blockManagerState</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token string" style="color:#e3116c">&quot;entry_block_protocol&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        EntryBlock</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">getBlockService</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        EntryBlock</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">createBlockState</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    blockManagerState </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> BlockManager</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">registerBlock</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        blockManagerState</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token string" style="color:#e3116c">&quot;block1_protocol&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Block1</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">getBlockService</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Block1</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">createBlockState</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    注册更多的Block</span><span class="token operator" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> blockManagerState</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">export</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> </span><span class="token function-variable function" style="color:#d73a49">getEntryBlockProtocolName</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;entry_block_protocol&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">export</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> getBlockService </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">blockService</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">blockManagerState</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> blockManagerState</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> blockProtocolName</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> blockProtocolName</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> BlockManager</span><span class="token punctuation" style="color:#393A34">.</span><span class="token generic-function function" style="color:#d73a49">getBlockServiceExn</span><span class="token generic-function generic class-name operator" style="color:#393A34">&lt;</span><span class="token generic-function generic class-name">blockService</span><span class="token generic-function generic class-name operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">blockManagerState</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> blockProtocolName</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h4 class="anchor anchorWithStickyNavbar_y2LR" id="blockmanager的抽象代码">BlockManager的抽象代码<a class="hash-link" href="#blockmanager的抽象代码" title="Direct link to heading">​</a></h4><p>BlockManagerType</p><div class="codeBlockContainer_J+bg language-ts theme-code-block"><div class="codeBlockContent_csEI ts"><pre tabindex="0" class="prism-code language-ts codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> Map </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;immutable&quot;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">export</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> </span><span class="token class-name">blockName</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token builtin">string</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">export</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> </span><span class="token class-name">blockProtocolName</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token builtin">string</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">export</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> </span><span class="token class-name">blockService</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token builtin">any</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">export</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> </span><span class="token class-name">blockState</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token builtin">any</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">export</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> </span><span class="token class-name">state</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  blockServiceMap</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> Map</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">blockProtocolName</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> blockService</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  blockStateMap</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> Map</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">blockProtocolName</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> blockState</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">export</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> </span><span class="token class-name">api</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token generic-function function" style="color:#d73a49">getBlockService</span><span class="token generic-function generic class-name operator" style="color:#393A34">&lt;</span><span class="token generic-function generic class-name">blockService</span><span class="token generic-function generic class-name operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">state</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> state</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> blockProtocolName</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> blockProtocolName</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> blockService</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token generic-function function" style="color:#d73a49">getBlockState</span><span class="token generic-function generic class-name operator" style="color:#393A34">&lt;</span><span class="token generic-function generic class-name">blockState</span><span class="token generic-function generic class-name operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">state</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> state</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> blockProtocolName</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> blockProtocolName</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> blockState</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token generic-function function" style="color:#d73a49">setBlockState</span><span class="token generic-function generic class-name operator" style="color:#393A34">&lt;</span><span class="token generic-function generic class-name">blockState</span><span class="token generic-function generic class-name operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">state</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> state</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> blockProtocolName</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> blockProtocolName</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> blockState</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> blockState</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> state</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">export</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> </span><span class="token class-name">getBlockService</span><span class="token class-name operator" style="color:#393A34">&lt;</span><span class="token class-name"> blockService</span><span class="token class-name operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">api</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> api</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> blockService</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">export</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> </span><span class="token class-name">createBlockState</span><span class="token class-name operator" style="color:#393A34">&lt;</span><span class="token class-name">blockState</span><span class="token class-name operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> blockState</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>BlockManager</p><div class="codeBlockContainer_J+bg language-ts theme-code-block"><div class="codeBlockContent_csEI ts"><pre tabindex="0" class="prism-code language-ts codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> state</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> blockProtocolName</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> getBlockService </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;./BlockManagerType&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">export</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">declare</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">createState</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> state</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">export</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">declare</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token generic-function function" style="color:#d73a49">getBlockServiceExn</span><span class="token generic-function generic class-name operator" style="color:#393A34">&lt;</span><span class="token generic-function generic class-name">blockService</span><span class="token generic-function generic class-name operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">state</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> state</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> blockProtocolName</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> blockProtocolName</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> blockService</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">export</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">declare</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token generic-function function" style="color:#d73a49">getBlockStateExn</span><span class="token generic-function generic class-name operator" style="color:#393A34">&lt;</span><span class="token generic-function generic class-name">blockState</span><span class="token generic-function generic class-name operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">state</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> state</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> blockProtocolName</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> blockProtocolName</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> blockState</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">export</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">declare</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token generic-function function" style="color:#d73a49">setBlockState</span><span class="token generic-function generic class-name operator" style="color:#393A34">&lt;</span><span class="token generic-function generic class-name">blockState</span><span class="token generic-function generic class-name operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">state</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> state</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> blockProtocolName</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> blockProtocolName</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> blockState</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> blockState</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> state</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">export</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">declare</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token generic-function function" style="color:#d73a49">registerBlock</span><span class="token generic-function generic class-name operator" style="color:#393A34">&lt;</span><span class="token generic-function generic class-name">blockService</span><span class="token generic-function generic class-name punctuation" style="color:#393A34">,</span><span class="token generic-function generic class-name"> blockState</span><span class="token generic-function generic class-name operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">state</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> state</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> blockProtocolName</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> blockProtocolName</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> getBlockService</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> getBlockService</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> blockService</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    blockState</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> blockState</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> state</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>BlockManager的函数实现已经在之前的案例代码中给出了，这里只给出函数签名</p><h4 class="anchor anchorWithStickyNavbar_y2LR" id="entry-block-protocol的抽象代码">Entry Block Protocol的抽象代码<a class="hash-link" href="#entry-block-protocol的抽象代码" title="Direct link to heading">​</a></h4><p>ServiceType</p><div class="codeBlockContainer_J+bg language-ts theme-code-block"><div class="codeBlockContent_csEI ts"><pre tabindex="0" class="prism-code language-ts codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">export</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> </span><span class="token class-name">service</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>StateType</p><div class="codeBlockContainer_J+bg language-ts theme-code-block"><div class="codeBlockContent_csEI ts"><pre tabindex="0" class="prism-code language-ts codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">export</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> </span><span class="token class-name">state</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">...</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h4 class="anchor anchorWithStickyNavbar_y2LR" id="entry-block-implement的抽象代码">Entry Block Implement的抽象代码<a class="hash-link" href="#entry-block-implement的抽象代码" title="Direct link to heading">​</a></h4><p>Entry Block Implement</p><div class="codeBlockContainer_J+bg language-ts theme-code-block"><div class="codeBlockContent_csEI ts"><pre tabindex="0" class="prism-code language-ts codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">export</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> getBlockService</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> BlockManagerType</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">getBlockService</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    EntryBlockProtocolServiceType</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">api</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        实现service</span><span class="token operator" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">export</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> createBlockState</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> BlockManagerType</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">createBlockState</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    EntryBlockProtocolStateType</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">state</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> 创建blockState</span><span class="token operator" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h4 class="anchor anchorWithStickyNavbar_y2LR" id="block-protocol的抽象代码">Block Protocol的抽象代码<a class="hash-link" href="#block-protocol的抽象代码" title="Direct link to heading">​</a></h4><p>跟Entry Block Protocl的抽象代码一样，故省略</p><h4 class="anchor anchorWithStickyNavbar_y2LR" id="block-implement的抽象代码">Block Implement的抽象代码<a class="hash-link" href="#block-implement的抽象代码" title="Direct link to heading">​</a></h4><p>跟Entry Block Implement的抽象代码一样，故省略</p><h3 class="anchor anchorWithStickyNavbar_y2LR" id="遵循的设计原则在uml中的体现">遵循的设计原则在UML中的体现<a class="hash-link" href="#遵循的设计原则在uml中的体现" title="Direct link to heading">​</a></h3><ul><li>单一职责原则<br>每个积木只做一件事情</li><li>合成复用原则<br>系统组合了积木</li><li>依赖倒置原则<br>各个积木实现之间没有直接依赖，而是依赖抽象的积木协议</li><li>接口隔离原则<br>积木协议的state和service只定义了该积木的数据和服务的类型，没有定义其它积木的相关类型</li><li>最少知识原则<br>各个积木协议相互独立，如Block Protocol和其它的Block Protocol之间没有依赖关系；各个积木实现相互独立，如Block Implement和其它的Block Implement之间没有依赖关系</li><li>开闭原则<br>要增加系统的一个模块，只需要增加一个积木，并在BlockFacade的init函数中注册该积木即可，无需修改其它的积木</li></ul><h2 class="anchor anchorWithStickyNavbar_y2LR" id="应用">应用<a class="hash-link" href="#应用" title="Direct link to heading">​</a></h2><h3 class="anchor anchorWithStickyNavbar_y2LR" id="优点">优点<a class="hash-link" href="#优点" title="Direct link to heading">​</a></h3><ul><li><p>实现了可插拔架构，支持大型的开发团队<br>
<!-- -->因为每个开发者只独立地负责自己的积木，互相之间通过抽象的积木协议交互，所以只要积木协议设计得足够抽象，则可以任意插拔积木，显著降低了各个开发者之间的影响</p></li><li><p>可以按需打包使用的积木到build后的系统文件中，从而减小文件大小<br>
<!-- -->具体是在BlockFacade的init函数中通过import只引入需要使用的积木并注册，其它的积木则不需要引入进来。这样的话通过打包工具（如webpack）的tree shaking机制，即可只打包import进来的积木</p></li><li><p>测试方便  </p><ul><li>对于单个积木的单元测试：<br>因为各个积木实现之间没有耦合，所以可以单独地对每个积木实现进行单元测试；<br>对于积木实现之间通过依赖积木协议交互的代码，可以很容易地使用stub或者mock来构造依赖的积木协议的积木实现  </li><li>对于涉及到多个积木的集成测试或者运行测试：<br>开发单个积木的开发者可以在本地构造假的Client，并构造假的BlockFacade的init函数来引入和注册需要测试的多个积木；然后运行Client来测试</li></ul></li></ul><h3 class="anchor anchorWithStickyNavbar_y2LR" id="缺点">缺点<a class="hash-link" href="#缺点" title="Direct link to heading">​</a></h3><p>无</p><h3 class="anchor anchorWithStickyNavbar_y2LR" id="使用场景">使用场景<a class="hash-link" href="#使用场景" title="Direct link to heading">​</a></h3><h4 class="anchor anchorWithStickyNavbar_y2LR" id="场景描述">场景描述<a class="hash-link" href="#场景描述" title="Direct link to heading">​</a></h4><p>多人开发的大型系统</p><h4 class="anchor anchorWithStickyNavbar_y2LR" id="具体案例">具体案例<a class="hash-link" href="#具体案例" title="Direct link to heading">​</a></h4><ul><li>多人开发的引擎<br>引擎的动画、场景管理、模型加载、粒子、物理等各个模块都可以作为一个积木或者拆解为多个更小的积木。整个引擎可以完全由积木搭建而成，每个开发者负责一个积木的开发，这样相互的影响会降到最低</li></ul><ul><li>多人开发的编辑器<br>编辑器的引擎、UI、撤销重做、导入导出、发布等各个模块都可以作为一个积木或者拆解为多个更小的积木。整个编辑器可以完全由积木搭建而成，每个开发者负责一个积木的开发，这样相互的影响会降到最低</li></ul><h3 class="anchor anchorWithStickyNavbar_y2LR" id="注意事项">注意事项<a class="hash-link" href="#注意事项" title="Direct link to heading">​</a></h3><ul><li><p>积木模式是影响全局架构的模式，最好在刚开始时就使用积木模式来设计整体架构</p></li><li><p>确保积木协议足够抽象，避免频繁改动</p></li></ul><h2 class="anchor anchorWithStickyNavbar_y2LR" id="扩展">扩展<a class="hash-link" href="#扩展" title="Direct link to heading">​</a></h2><h3 class="anchor anchorWithStickyNavbar_y2LR" id="对于积木协议中定义的服务state的类型可以使用dependent-type来加强类型约束从而在编译期间尽量除错">对于积木协议中定义的服务、state的类型，可以使用Dependent Type来加强类型约束，从而在编译期间尽量除错<a class="hash-link" href="#对于积木协议中定义的服务state的类型可以使用dependent-type来加强类型约束从而在编译期间尽量除错" title="Direct link to heading">​</a></h3><p>因为Typescript部分地支持Dependent Type，所以使用它开发的积木协议可以加入Dependent Type</p><h3 class="anchor anchorWithStickyNavbar_y2LR" id="对积木本身进行扩展">对积木本身进行扩展<a class="hash-link" href="#对积木本身进行扩展" title="Direct link to heading">​</a></h3><p>有些积木本身需要进行扩展，如一个积木A有自己的数据，A提供了默认的方式来操作数据；而A的用户希望能够用自定义的方式来操作它的数据。实现的思路是将“默认的方式”和“自定义的方式”这两个方式作为对A的两个扩展，用户通过在注册A时指定使用哪个扩展，来实现使用哪种方式操作它的数据</p><p>积木应该有两种类型：默认类型、扩展类型。积木A属于“默认类型”的积木，它的两个扩展属于“扩展类型”的积木。属于“默认类型”的积木应该有数据，属于“扩展类型”的积木应该没有数据。具体来说：<br>
<!-- -->假设在开发编辑器时，编辑器使用了一个引擎积木。该积木维护所有的场景数据，实现了用默认的组件来操作场景数据。如果编辑器希望能够使用自定义的组件来操作它的场景数据，该如何实现？<br>
<!-- -->我们可以将积木分为两种类型的积木：Extension和Contribute。其中，Extension即是前面提到的“默认类型”的积木，Contribute即是前面提到的“扩展类型”的积木。Contribute是Extension的扩展。Extension有数据，Contribute没有数据。<br>
<!-- -->那么就可以实现一个Extension：Engine Extension，它是编辑器使用的引擎积木，负责维护所有的场景数据；实现两个Contribute：EngineSceneContribute1、EngineSceneContribute2，它们是对Engine Extension的扩展，其中前者使用默认的组件来操作Engine Extension的场景数据，后者使用自定义的组件来操作Engine Extension的场景数据。因为两者都是操作Engine Extension的场景数据，它们的接口应该相同，所以它们实现同一个积木协议。<br>
<!-- -->编辑器在注册Engine Extension积木时，可以通过指定注册其中一个Contribute，从而实现使用默认的组件或者自定义的组件来操作场景数据。  </p><p>首先，我们看下Extension和Contribute的参考代码：<br>
<!-- -->Engine Extension Implement</p><div class="codeBlockContainer_J+bg language-ts theme-code-block"><div class="codeBlockContent_csEI ts"><pre tabindex="0" class="prism-code language-ts codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">export</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> getExtensionService</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> BlockManagerType</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">getExtensionService</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    EngineExtensionProtocolServiceType</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">api</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function-variable function" style="color:#d73a49">operateScene</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">blockManagerState</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token comment" style="color:#999988;font-style:italic">//依赖于Contribute的积木协议来调用Contribute的积木实现（可能是EngineSceneContribute1或者EngineSceneContribute2）的服务</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> operate </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> api</span><span class="token punctuation" style="color:#393A34">.</span><span class="token generic-function function" style="color:#d73a49">getContribute</span><span class="token generic-function generic class-name operator" style="color:#393A34">&lt;</span><span class="token generic-function generic class-name">EngineSceneContributeProtocolServiceType</span><span class="token generic-function generic class-name punctuation" style="color:#393A34">.</span><span class="token generic-function generic class-name">service</span><span class="token generic-function generic class-name operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">blockManagerState</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;engine_scene_contribute_protocol&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token comment" style="color:#999988;font-style:italic">//操作场景数据</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token function" style="color:#d73a49">operate</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">xxx</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token operator" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">export</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> createExtensionState</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> BlockManagerType</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">createExtensionState</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    EngineExtensionProtocolStateType</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">state</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        创建初始的场景数据</span><span class="token operator" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>EngineSceneContribute1 Implement</p><div class="codeBlockContainer_J+bg language-ts theme-code-block"><div class="codeBlockContent_csEI ts"><pre tabindex="0" class="prism-code language-ts codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">export</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> getContributeService</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> BlockManagerType</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">getContributeService</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    EngineSceneContributeProtocolServiceType</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">api</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function-variable function" style="color:#d73a49">operate</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">...</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            使用默认的组件操作场景数据</span><span class="token operator" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">//因为没有数据，所以没有create block state函数</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>EngineSceneContribute2 Implement</p><div class="codeBlockContainer_J+bg language-ts theme-code-block"><div class="codeBlockContent_csEI ts"><pre tabindex="0" class="prism-code language-ts codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">export</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> getContributeService</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> BlockManagerType</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">getContributeService</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    EngineSceneContributeProtocolServiceType</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">api</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function-variable function" style="color:#d73a49">operate</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">...</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            使用自定义的组件操作场景数据</span><span class="token operator" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">//因为没有数据，所以没有create block state函数</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>这里省略了积木协议的代码</p><p>然后，我们看下在BlockFacade的init函数中注册Engine Extension和需要的Contribute的参考代码：<br>
<!-- -->BlockFacade</p><div class="codeBlockContainer_J+bg language-ts theme-code-block"><div class="codeBlockContent_csEI ts"><pre tabindex="0" class="prism-code language-ts codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">export</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> init </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> blockManagerState </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">//注册Engine Extension积木</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    blockManagerState </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> BlockManager</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">registerExtensionBlock</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        blockManagerState</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token string" style="color:#e3116c">&quot;engine_extension_protocol&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        EngineExtension</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">getExtensionService</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        EngineExtension</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">createExtensionState</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">//注册EngineSceneContribute1或者EngineSceneContribute2积木</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    blockManagerState </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> BlockManager</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">registerContributeBlock</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        blockManagerState</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">//因为两者实现同一个积木协议，所以积木协议名是同一个</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token string" style="color:#e3116c">&quot;engine_scene_contribute_protocol&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">//选择EngineSceneContribute1或者EngineSceneContribute2</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">EngineSceneContribute1 或者 EngineSceneContribute2</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">getContributeService</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h3 class="anchor anchorWithStickyNavbar_y2LR" id="积木加入钩子函数">积木加入钩子函数<a class="hash-link" href="#积木加入钩子函数" title="Direct link to heading">​</a></h3><p>积木可以加入钩子函数，从而在不同的时机执行对应的钩子函数，实现对积木生命周期的控制。如积木可以加入onRegister钩子函数，它在注册该积木时被执行。积木的参考代码如下：<br>
<!-- -->Block Implement</p><div class="codeBlockContainer_J+bg language-ts theme-code-block"><div class="codeBlockContent_csEI ts"><pre tabindex="0" class="prism-code language-ts codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">//加入getBlockLife函数</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">export</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> getBlockLife</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> BlockManagerType</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">getBlockLife</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">BlockProtocolServiceType</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">service</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">api</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> blockProtocolName</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">//返回积木的生命周期数据，包括了钩子函数</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function-variable function" style="color:#d73a49">onRegister</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">blockManagerState</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> service</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token builtin">console</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">log</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;register!&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> blockManagerState</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>BlockManagerType增加下面的类型定义：<br>
<!-- -->BlockManagerType</p><div class="codeBlockContainer_J+bg language-ts theme-code-block"><div class="codeBlockContent_csEI ts"><pre tabindex="0" class="prism-code language-ts codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> </span><span class="token class-name">blockLife</span><span class="token class-name operator" style="color:#393A34">&lt;</span><span class="token class-name">blockService</span><span class="token class-name operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    onRegister</span><span class="token operator" style="color:#393A34">?</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">state</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> state</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> blockService</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> blockService</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> state</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">export</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> </span><span class="token class-name">getBlockLife</span><span class="token class-name operator" style="color:#393A34">&lt;</span><span class="token class-name">blockService</span><span class="token class-name operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">api</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> api</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> blockProtocolName</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> blockProtocolName</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> blockLife</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">blockService</span><span class="token operator" style="color:#393A34">&gt;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>BlockManager的registerBlock函数在注册了积木后，需要执行该积木的生命周期数据中的onRegister函数</p><h2 class="anchor anchorWithStickyNavbar_y2LR" id="最佳实践">最佳实践<a class="hash-link" href="#最佳实践" title="Direct link to heading">​</a></h2><h3 class="anchor anchorWithStickyNavbar_y2LR" id="哪些场景不需要使用模式">哪些场景不需要使用模式<a class="hash-link" href="#哪些场景不需要使用模式" title="Direct link to heading">​</a></h3><p>如果系统的规模较小，或者系统的开发者人数较少，那么就不需要积木模式</p><h3 class="anchor anchorWithStickyNavbar_y2LR" id="给出具体的实践案例">给出具体的实践案例<a class="hash-link" href="#给出具体的实践案例" title="Direct link to heading">​</a></h3><h4 class="anchor anchorWithStickyNavbar_y2LR" id="monorepo">monorepo<a class="hash-link" href="#monorepo" title="Direct link to heading">​</a></h4><p>每个积木实现以及积木协议都可以作为一个单独的项目。如果使用monorepo来管理一个系统的开发，那么整个系统就是一个大的项目，该项目中有很多个独立的package，其中每个积木实现以及积木协议都是一个package。可以使用lerna来管理monorepo</p><h2 class="anchor anchorWithStickyNavbar_y2LR" id="更多资料推荐">更多资料推荐<a class="hash-link" href="#更多资料推荐" title="Direct link to heading">​</a></h2><p>我开发的<a href="https://github.com/Meta3D-Technology/Meta3D" target="_blank" rel="noopener noreferrer">Meta3D</a>使用了积木模式来设计整体架构。Meta3D是开源的Web3D低代码开发平台，用来开发Web3D引擎和编辑器。可以在网上搜索“Meta3D Github”来找到Github Repo</p><p>可以在网上搜索“dependent type typescript”来找到在Typescript使用Dependent Type的资料</p><p>可以在网上搜索“lerna”来找到lerna的资料</p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/积木模式/积木模式.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_mS5F" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_mt2f"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/3dProgramPattern/docs/依赖隔离模式/"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">第2章 依赖隔离模式</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/3dProgramPattern/docs/管道模式/"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">第4章 管道模式</div></a></div></nav></div></div><div class="col col--3"><div class="tableOfContents_vrFS thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#一个开发者开发引擎" class="table-of-contents__link toc-highlight">一个开发者开发引擎</a><ul><li><a href="#需求" class="table-of-contents__link toc-highlight">需求</a></li><li><a href="#实现思路" class="table-of-contents__link toc-highlight">实现思路</a></li><li><a href="#给出uml" class="table-of-contents__link toc-highlight">给出UML</a></li><li><a href="#给出代码" class="table-of-contents__link toc-highlight">给出代码</a></li></ul></li><li><a href="#加入更多的开发者一起开发引擎" class="table-of-contents__link toc-highlight">加入更多的开发者一起开发引擎</a><ul><li><a href="#概述解决方案" class="table-of-contents__link toc-highlight">概述解决方案</a></li><li><a href="#给出uml-1" class="table-of-contents__link toc-highlight">给出UML</a></li><li><a href="#给出代码-1" class="table-of-contents__link toc-highlight">给出代码</a></li><li><a href="#提出问题" class="table-of-contents__link toc-highlight">提出问题</a></li></ul></li><li><a href="#使用积木模式来改进" class="table-of-contents__link toc-highlight">使用积木模式来改进</a><ul><li><a href="#概述解决方案-1" class="table-of-contents__link toc-highlight">概述解决方案</a></li><li><a href="#给出uml-2" class="table-of-contents__link toc-highlight">给出UML</a></li><li><a href="#结合uml图描述如何具体地解决问题" class="table-of-contents__link toc-highlight">结合UML图，描述如何具体地解决问题</a></li><li><a href="#给出代码-2" class="table-of-contents__link toc-highlight">给出代码</a></li></ul></li><li><a href="#定义" class="table-of-contents__link toc-highlight">定义</a><ul><li><a href="#一句话定义" class="table-of-contents__link toc-highlight">一句话定义</a></li><li><a href="#补充说明" class="table-of-contents__link toc-highlight">补充说明</a></li><li><a href="#通用uml" class="table-of-contents__link toc-highlight">通用UML</a></li><li><a href="#角色的抽象代码" class="table-of-contents__link toc-highlight">角色的抽象代码</a></li><li><a href="#遵循的设计原则在uml中的体现" class="table-of-contents__link toc-highlight">遵循的设计原则在UML中的体现</a></li></ul></li><li><a href="#应用" class="table-of-contents__link toc-highlight">应用</a><ul><li><a href="#优点" class="table-of-contents__link toc-highlight">优点</a></li><li><a href="#缺点" class="table-of-contents__link toc-highlight">缺点</a></li><li><a href="#使用场景" class="table-of-contents__link toc-highlight">使用场景</a></li><li><a href="#注意事项" class="table-of-contents__link toc-highlight">注意事项</a></li></ul></li><li><a href="#扩展" class="table-of-contents__link toc-highlight">扩展</a><ul><li><a href="#对于积木协议中定义的服务state的类型可以使用dependent-type来加强类型约束从而在编译期间尽量除错" class="table-of-contents__link toc-highlight">对于积木协议中定义的服务、state的类型，可以使用Dependent Type来加强类型约束，从而在编译期间尽量除错</a></li><li><a href="#对积木本身进行扩展" class="table-of-contents__link toc-highlight">对积木本身进行扩展</a></li><li><a href="#积木加入钩子函数" class="table-of-contents__link toc-highlight">积木加入钩子函数</a></li></ul></li><li><a href="#最佳实践" class="table-of-contents__link toc-highlight">最佳实践</a><ul><li><a href="#哪些场景不需要使用模式" class="table-of-contents__link toc-highlight">哪些场景不需要使用模式</a></li><li><a href="#给出具体的实践案例" class="table-of-contents__link toc-highlight">给出具体的实践案例</a></li></ul></li><li><a href="#更多资料推荐" class="table-of-contents__link toc-highlight">更多资料推荐</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">社区</div><ul class="footer__items"><li class="footer__item"><a href="https://qm.qq.com/cgi-bin/qm/qr?k=SaSgwsyiccUjc3Mx3Jqliv9HJnHxL-WI&amp;jump_from=webapi&amp;authKey=+EQRAdLQ80spfX++pA3UB4erf6cxC+Mo4jH6bfovhdE7MOvI5WBUljCZ6roGaNZh" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>与作者交流加QQ群<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div><div class="col footer__col"><div class="footer__title">更多</div><ul class="footer__items"><li class="footer__item"><a href="https://www.zhihu.com/people/dreamforest-yyc" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>作者的知乎<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://www.cnblogs.com/chaogex/" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>作者的博客<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div></div><div class="footer__bottom text--center"></div></div></footer></div>
<script src="/3dProgramPattern/assets/js/runtime~main.a26eabbf.js"></script>
<script src="/3dProgramPattern/assets/js/main.c6dc4a90.js"></script>
</body>
</html>